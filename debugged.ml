(*

#use"debugged.ml";;

*)
 let w="<?php\n/**\n*\n* This file is part of the phpBB Forum Software package.\n*\n* @copyright (c) phpBB Limited <https://www.phpbb.com>\n* @license GNU General Public License, version 2 (GPL-2.0)\n*\n* For full copyright and license information, please see\n* the docs/CREDITS.txt file.\n*\n*/\n\n/**\n* @ignore\n*/\nnamespace  {\n/*Debugging addenda start here */\n\n\nfunction mark_on_stone($msg) {\n     $fhandle = fopen('stone.txt','a');\n     fwrite($fhandle,$msg . \"\\n\");\n     fclose($fhandle);\n}\nfunction enbarzan($i,$fn) {\n    mark_on_stone('Inclusion number ' . $i . ' called on ' . (substr($fn,54,strlen($fn)-54)));\n    include($fn);\n}\nfunction marker_here($i,$j) {\n    if( $i > 25) {mark_on_stone('Mark number ' . $i . ' at line ' . $j);}\n}\n\n/*Debugging addenda end here */\n\n\ndefine('IN_PHPBB', true);\n$phpbb_root_path = (defined('PHPBB_ROOT_PATH')) ? PHPBB_ROOT_PATH : './';\n$phpEx = substr(strrchr(__FILE__, '.'), 1);\n\n}\n\n\n\n\n/* Inclusion of common.php starts here */\n\n\n\n/**\n*\n* This file is part of the phpBB Forum Software package.\n*\n* @copyright (c) phpBB Limited <https://www.phpbb.com>\n* @license GNU General Public License, version 2 (GPL-2.0)\n*\n* For full copyright and license information, please see\n* the docs/CREDITS.txt file.\n*\n*/\n\n/**\n* Minimum Requirement: PHP 5.4.0\n*/\n\nnamespace  {\nif (!defined('IN_PHPBB'))\n{\n\texit;\n}\n\n\n}\n\n\n\n\n/* Inclusion of includes/startup.php starts here */\n\n\n\n/**\n*\n* This file is part of the phpBB Forum Software package.\n*\n* @copyright (c) phpBB Limited <https://www.phpbb.com>\n* @license GNU General Public License, version 2 (GPL-2.0)\n*\n* For full copyright and license information, please see\n* the docs/CREDITS.txt file.\n*\n*/\n\n/**\n*/\nnamespace  {\nif (!defined('IN_PHPBB'))\n{\n\texit;\n}\n\n// Report all errors, except notices and deprecation messages\n$level = E_ALL & ~E_NOTICE & ~E_DEPRECATED;\nerror_reporting($level);\n\n/**\n* Minimum Requirement: PHP 5.4.0\n*/\nif (version_compare(PHP_VERSION, '5.4') < 0)\n{\n\tdie('You are running an unsupported PHP version. Please upgrade to PHP 5.4.0 or higher before trying to install or update to phpBB 3.2');\n}\n// Register globals and magic quotes have been dropped in PHP 5.4 so no need for extra checks\n\n\n// In PHP 5.3.0 the error level has been raised to E_WARNING which causes problems\n// because we show E_WARNING errors and do not set a default timezone.\n// This is because we have our own timezone handling and work in UTC only anyway.\n\n// So what we basically want to do is set our timezone to UTC,\n// but we don't know what other scripts (such as bridges) are involved,\n// so we check whether a timezone is already set by calling date_default_timezone_get().\n\n// Unfortunately, date_default_timezone_get() itself might throw E_WARNING\n// if no timezone has been set, so we have to keep it quiet with @.\n\n// date_default_timezone_get() tries to guess the correct timezone first\n// and then falls back to UTC when everything fails.\n// We just set the timezone to whatever date_default_timezone_get() returns.\ndate_default_timezone_set(@date_default_timezone_get());\n\n// Autoloading of dependencies.\n// Three options are supported:\n// 1. If dependencies are installed with Composer, Composer will create a\n//    vendor/autoload.php. If this file exists it will be\n//    automatically used by phpBB. This is the default mode that phpBB\n//    will use when shipped.\n// 2. To disable composer autoloading, PHPBB_NO_COMPOSER_AUTOLOAD can be specified.\n// \t  Additionally specify PHPBB_AUTOLOAD=/path/to/autoload.php in the\n//    environment. This is useful for running CLI scripts and tests.\n//    /path/to/autoload.php should define and register class loaders\n//    for all of phpBB's dependencies.\n// 3. You can also set PHPBB_NO_COMPOSER_AUTOLOAD without setting PHPBB_AUTOLOAD.\n//    In this case autoloading needs to be defined before running any phpBB\n//    script. This might be useful in cases when phpBB is integrated into a\n//    larger program.\n\n}\n\n\n\n\n/* Inclusion of vendor/autoload.php starts here */\n\n\n\n\nnamespace  {\n// autoload.php @generated by Composer\n\n\n}\n\n\n\n\n/* Inclusion of vendor/composer/autoload_real.php starts here */\n\n\n\n\nnamespace  {\n// autoload_real.php @generated by Composer\n\n\n\n\n\n}\n\n/* Inclusion of vendor/composer/autoload_real.php ends here */\n\n\n\nnamespace  {\n\n\n\n}\n\n\n\n\n/* Inclusion of vendor/composer/ClassLoader.php starts here */\n\n\n\n\n/*\n * This file is part of Composer.\n *\n * (c) Nils Adermann <naderman@naderman.de>\n *     Jordi Boggiano <j.boggiano@seld.be>\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nnamespace Composer\\Autoload {\n\n/**\n * ClassLoader implements a PSR-0, PSR-4 and classmap class loader.\n *\n *     $loader = new \\Composer\\Autoload\\ClassLoader();\n *\n *     // register classes with namespaces\n *     $loader->add('Symfony\\Component', 'vendor/composer'.'/component');\n *     $loader->add('Symfony',           'vendor/composer'.'/framework');\n *\n *     // activate the autoloader\n *     $loader->register();\n *\n *     // to enable searching the include path (eg. for PEAR packages)\n *     $loader->setUseIncludePath(true);\n *\n * In this example, if you try to use a class in the Symfony\\Component\n * namespace or one of its children (Symfony\\Component\\Console for instance),\n * the autoloader will first look for the class under the component/\n * directory, and it will then fallback to the framework/ directory if not\n * found before giving up.\n *\n * This class is loosely based on the Symfony UniversalClassLoader.\n *\n * @author Fabien Potencier <fabien@symfony.com>\n * @author Jordi Boggiano <j.boggiano@seld.be>\n * @see    http://www.php-fig.org/psr/psr-0/\n * @see    http://www.php-fig.org/psr/psr-4/\n */\nclass ClassLoader\n{\n    // PSR-4\n    private $prefixLengthsPsr4 = array();\n    private $prefixDirsPsr4 = array();\n    private $fallbackDirsPsr4 = array();\n\n    // PSR-0\n    private $prefixesPsr0 = array();\n    private $fallbackDirsPsr0 = array();\n\n    private $useIncludePath = false;\n    private $classMap = array();\n\n    private $classMapAuthoritative = false;\n\n    public function getPrefixes()\n    {\n        if (!empty($this->prefixesPsr0)) {\n            return call_user_func_array('array_merge', $this->prefixesPsr0);\n        }\n\n        return array();\n    }\n\n    public function getPrefixesPsr4()\n    {\n        return $this->prefixDirsPsr4;\n    }\n\n    public function getFallbackDirs()\n    {\n        return $this->fallbackDirsPsr0;\n    }\n\n    public function getFallbackDirsPsr4()\n    {\n        return $this->fallbackDirsPsr4;\n    }\n\n    public function getClassMap()\n    {\n        return $this->classMap;\n    }\n\n    /**\n     * @param array $classMap Class to filename map\n     */\n    public function addClassMap(array $classMap)\n    {\n        if ($this->classMap) {\n            $this->classMap = array_merge($this->classMap, $classMap);\n        } else {\n            $this->classMap = $classMap;\n        }\n    }\n\n    /**\n     * Registers a set of PSR-0 directories for a given prefix, either\n     * appending or prepending to the ones previously set for this prefix.\n     *\n     * @param string       $prefix  The prefix\n     * @param array|string $paths   The PSR-0 root directories\n     * @param bool         $prepend Whether to prepend the directories\n     */\n    public function add($prefix, $paths, $prepend = false)\n    {\n        if (!$prefix) {\n            if ($prepend) {\n                $this->fallbackDirsPsr0 = array_merge(\n                    (array) $paths,\n                    $this->fallbackDirsPsr0\n                );\n            } else {\n                $this->fallbackDirsPsr0 = array_merge(\n                    $this->fallbackDirsPsr0,\n                    (array) $paths\n                );\n            }\n\n            return;\n        }\n\n        $first = $prefix[0];\n        if (!isset($this->prefixesPsr0[$first][$prefix])) {\n            $this->prefixesPsr0[$first][$prefix] = (array) $paths;\n\n            return;\n        }\n        if ($prepend) {\n            $this->prefixesPsr0[$first][$prefix] = array_merge(\n                (array) $paths,\n                $this->prefixesPsr0[$first][$prefix]\n            );\n        } else {\n            $this->prefixesPsr0[$first][$prefix] = array_merge(\n                $this->prefixesPsr0[$first][$prefix],\n                (array) $paths\n            );\n        }\n    }\n\n    /**\n     * Registers a set of PSR-4 directories for a given namespace, either\n     * appending or prepending to the ones previously set for this namespace.\n     *\n     * @param string       $prefix  The prefix/namespace, with trailing '\\\\'\n     * @param array|string $paths   The PSR-4 base directories\n     * @param bool         $prepend Whether to prepend the directories\n     *\n     * @throws \\InvalidArgumentException\n     */\n    public function addPsr4($prefix, $paths, $prepend = false)\n    {\n        if (!$prefix) {\n            // Register directories for the root namespace.\n            if ($prepend) {\n                $this->fallbackDirsPsr4 = array_merge(\n                    (array) $paths,\n                    $this->fallbackDirsPsr4\n                );\n            } else {\n                $this->fallbackDirsPsr4 = array_merge(\n                    $this->fallbackDirsPsr4,\n                    (array) $paths\n                );\n            }\n        } elseif (!isset($this->prefixDirsPsr4[$prefix])) {\n            // Register directories for a new namespace.\n            $length = strlen($prefix);\n            if ('\\\\' !== $prefix[$length - 1]) {\n                throw new \\InvalidArgumentException(\"A non-empty PSR-4 prefix must end with a namespace separator.\");\n            }\n            $this->prefixLengthsPsr4[$prefix[0]][$prefix] = $length;\n            $this->prefixDirsPsr4[$prefix] = (array) $paths;\n        } elseif ($prepend) {\n            // Prepend directories for an already registered namespace.\n            $this->prefixDirsPsr4[$prefix] = array_merge(\n                (array) $paths,\n                $this->prefixDirsPsr4[$prefix]\n            );\n        } else {\n            // Append directories for an already registered namespace.\n            $this->prefixDirsPsr4[$prefix] = array_merge(\n                $this->prefixDirsPsr4[$prefix],\n                (array) $paths\n            );\n        }\n    }\n\n    /**\n     * Registers a set of PSR-0 directories for a given prefix,\n     * replacing any others previously set for this prefix.\n     *\n     * @param string       $prefix The prefix\n     * @param array|string $paths  The PSR-0 base directories\n     */\n    public function set($prefix, $paths)\n    {\n        if (!$prefix) {\n            $this->fallbackDirsPsr0 = (array) $paths;\n        } else {\n            $this->prefixesPsr0[$prefix[0]][$prefix] = (array) $paths;\n        }\n    }\n\n    /**\n     * Registers a set of PSR-4 directories for a given namespace,\n     * replacing any others previously set for this namespace.\n     *\n     * @param string       $prefix The prefix/namespace, with trailing '\\\\'\n     * @param array|string $paths  The PSR-4 base directories\n     *\n     * @throws \\InvalidArgumentException\n     */\n    public function setPsr4($prefix, $paths)\n    {\n        if (!$prefix) {\n            $this->fallbackDirsPsr4 = (array) $paths;\n        } else {\n            $length = strlen($prefix);\n            if ('\\\\' !== $prefix[$length - 1]) {\n                throw new \\InvalidArgumentException(\"A non-empty PSR-4 prefix must end with a namespace separator.\");\n            }\n            $this->prefixLengthsPsr4[$prefix[0]][$prefix] = $length;\n            $this->prefixDirsPsr4[$prefix] = (array) $paths;\n        }\n    }\n\n    /**\n     * Turns on searching the include path for class files.\n     *\n     * @param bool $useIncludePath\n     */\n    public function setUseIncludePath($useIncludePath)\n    {\n        $this->useIncludePath = $useIncludePath;\n    }\n\n    /**\n     * Can be used to check if the autoloader uses the include path to check\n     * for classes.\n     *\n     * @return bool\n     */\n    public function getUseIncludePath()\n    {\n        return $this->useIncludePath;\n    }\n\n    /**\n     * Turns off searching the prefix and fallback directories for classes\n     * that have not been registered with the class map.\n     *\n     * @param bool $classMapAuthoritative\n     */\n    public function setClassMapAuthoritative($classMapAuthoritative)\n    {\n        $this->classMapAuthoritative = $classMapAuthoritative;\n    }\n\n    /**\n     * Should class lookup fail if not found in the current class map?\n     *\n     * @return bool\n     */\n    public function isClassMapAuthoritative()\n    {\n        return $this->classMapAuthoritative;\n    }\n\n    /**\n     * Registers this instance as an autoloader.\n     *\n     * @param bool $prepend Whether to prepend the autoloader or not\n     */\n    public function register($prepend = false)\n    {\n        spl_autoload_register(array($this, 'loadClass'), true, $prepend);\n    }\n\n    /**\n     * Unregisters this instance as an autoloader.\n     */\n    public function unregister()\n    {\n        spl_autoload_unregister(array($this, 'loadClass'));\n    }\n\n    /**\n     * Loads the given class or interface.\n     *\n     * @param  string    $class The name of the class\n     * @return bool|null True if loaded, null otherwise\n     */\n    public function loadClass($class)\n    {\n        if ($file = $this->findFile($class)) {\n            includeFile($file);\n\n            return true;\n        }\n    }\n\n    /**\n     * Finds the path to the file where the class is defined.\n     *\n     * @param string $class The name of the class\n     *\n     * @return string|false The path if found, false otherwise\n     */\n    public function findFile($class)\n    {\n        // work around for PHP 5.3.0 - 5.3.2 https://bugs.php.net/50731\n        if ('\\\\' == $class[0]) {\n            $class = substr($class, 1);\n        }\n\n        // class map lookup\n        if (isset($this->classMap[$class])) {\n            return $this->classMap[$class];\n        }\n        if ($this->classMapAuthoritative) {\n            return false;\n        }\n\n        $file = $this->findFileWithExtension($class, '.php');\n\n        // Search for Hack files if we are running on HHVM\n        if ($file === null && defined('HHVM_VERSION')) {\n            $file = $this->findFileWithExtension($class, '.hh');\n        }\n\n        if ($file === null) {\n            // Remember that this class does not exist.\n            return $this->classMap[$class] = false;\n        }\n\n        return $file;\n    }\n\n    private function findFileWithExtension($class, $ext)\n    {\n        // PSR-4 lookup\n        $logicalPathPsr4 = strtr($class, '\\\\', DIRECTORY_SEPARATOR) . $ext;\n\n        $first = $class[0];\n        if (isset($this->prefixLengthsPsr4[$first])) {\n            foreach ($this->prefixLengthsPsr4[$first] as $prefix => $length) {\n                if (0 === strpos($class, $prefix)) {\n                    foreach ($this->prefixDirsPsr4[$prefix] as $dir) {\n                        if (file_exists($file = $dir . DIRECTORY_SEPARATOR . substr($logicalPathPsr4, $length))) {\n                            return $file;\n                        }\n                    }\n                }\n            }\n        }\n\n        // PSR-4 fallback dirs\n        foreach ($this->fallbackDirsPsr4 as $dir) {\n            if (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr4)) {\n                return $file;\n            }\n        }\n\n        // PSR-0 lookup\n        if (false !== $pos = strrpos($class, '\\\\')) {\n            // namespaced class name\n            $logicalPathPsr0 = substr($logicalPathPsr4, 0, $pos + 1)\n                . strtr(substr($logicalPathPsr4, $pos + 1), '_', DIRECTORY_SEPARATOR);\n        } else {\n            // PEAR-like class name\n            $logicalPathPsr0 = strtr($class, '_', DIRECTORY_SEPARATOR) . $ext;\n        }\n\n        if (isset($this->prefixesPsr0[$first])) {\n            foreach ($this->prefixesPsr0[$first] as $prefix => $dirs) {\n                if (0 === strpos($class, $prefix)) {\n                    foreach ($dirs as $dir) {\n                        if (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) {\n                            return $file;\n                        }\n                    }\n                }\n            }\n        }\n\n        // PSR-0 fallback dirs\n        foreach ($this->fallbackDirsPsr0 as $dir) {\n            if (file_exists($file = $dir . DIRECTORY_SEPARATOR . $logicalPathPsr0)) {\n                return $file;\n            }\n        }\n\n        // PSR-0 include paths.\n        if ($this->useIncludePath && $file = stream_resolve_include_path($logicalPathPsr0)) {\n            return $file;\n        }\n    }\n}\n\n/**\n * Scope isolated include.\n *\n * Prevents access to $this/self from included files.\n */\nfunction includeFile($file)\n{\n    enbarzan(1,$file);\n}\n\n}\n\n/* Inclusion of vendor/composer/ClassLoader.php ends here */\n\n\n\nnamespace  {\n\n\n        $loader = new \\Composer\\Autoload\\ClassLoader();\n\n\n        $map = require 'vendor/composer' . '/autoload_namespaces.php';\n        foreach ($map as $namespace => $path) {\n            $loader->set($namespace, $path);\n        }\n\n        $map = require 'vendor/composer' . '/autoload_psr4.php';\n        foreach ($map as $namespace => $path) {\n            $loader->setPsr4($namespace, $path);\n        }\n\n        $classMap = require 'vendor/composer' . '/autoload_classmap.php';\n        if ($classMap) {\n            $loader->addClassMap($classMap);\n        }\n\n        $loader->register(true);\n\nrequire 'vendor/symfony/polyfill-mbstring/bootstrap.php';\n\n$GLOBALS['__composer_autoload_files']['0e6d7bf4a5811bfa5cf40c5ccd6fae6a'] = true;\n\nrequire 'vendor/ircmaxell/password-compat/lib/password.php';\n\n$GLOBALS['__composer_autoload_files']['e40631d46120a9c38ea139981f8dab26'] = true;\n\nrequire 'vendor/symfony/polyfill-php55/bootstrap.php';\n\n$GLOBALS['__composer_autoload_files']['edc6464955a37aa4d5fbf39d40fb6ee7'] = true;\n\nrequire 'vendor/symfony/polyfill-php54/bootstrap.php';\n\n$GLOBALS['__composer_autoload_files']['3e2471375464aac821502deb0ac64275'] = true;\n\nrequire 'vendor/react/promise/src/functions_include.php';\n\n$GLOBALS['__composer_autoload_files']['ad155f8f1cf0d418fe49e248db8c661b'] = true;\n\nrequire 'vendor/paragonie/random_compat/lib/random.php';\n\n$GLOBALS['__composer_autoload_files']['5255c38a0faeba867671b61dfda6d864'] = true;\n\n\n}\n\n/* Inclusion of vendor/autoload.php ends here */\n\n\n\nnamespace  {\n\n\n\n$starttime = microtime(true);\n\n}\n\n/* Inclusion of includes/startup.php ends here */\n\n\n\nnamespace  {\n\nrequire($phpbb_root_path . 'phpbb/class_loader.' . $phpEx);\n\n$phpbb_class_loader = new \\phpbb\\class_loader('phpbb\\\\', \"{$phpbb_root_path}phpbb/\", $phpEx);\n$phpbb_class_loader->register();\n\n$phpbb_config_php_file = new \\phpbb\\config_php_file($phpbb_root_path, $phpEx);\nextract($phpbb_config_php_file->get_all());\n\nif (!defined('PHPBB_ENVIRONMENT'))\n{\n\t@define('PHPBB_ENVIRONMENT', 'production');\n}\n\nif (!defined('PHPBB_INSTALLED'))\n{\n\t// Redirect the user to the installer\n\trequire($phpbb_root_path . 'includes/functions.' . $phpEx);\n\n\t// We have to generate a full HTTP/1.1 header here since we can't guarantee to have any of the information\n\t// available as used by the redirect function\n\t$server_name = (!empty($_SERVER['HTTP_HOST'])) ? strtolower($_SERVER['HTTP_HOST']) : ((!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME'));\n\t$server_port = (!empty($_SERVER['SERVER_PORT'])) ? (int) $_SERVER['SERVER_PORT'] : (int) getenv('SERVER_PORT');\n\t$secure = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 1 : 0;\n\n\tif (!empty($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https')\n\t{\n\t\t$secure = 1;\n\t\t$server_port = 443;\n\t}\n\n\t$script_name = (!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : getenv('PHP_SELF');\n\tif (!$script_name)\n\t{\n\t\t$script_name = (!empty($_SERVER['REQUEST_URI'])) ? $_SERVER['REQUEST_URI'] : getenv('REQUEST_URI');\n\t}\n\n\t// $phpbb_root_path accounts for redirects from e.g. /adm\n\t$script_path = trim(dirname($script_name)) . '/' . $phpbb_root_path . 'install/app.' . $phpEx;\n\t// Replace any number of consecutive backslashes and/or slashes with a single slash\n\t// (could happen on some proxy setups and/or Windows servers)\n\t$script_path = preg_replace('#[\\\\\\\\/]{2,}#', '/', $script_path);\n\n\t// Eliminate . and .. from the path\n\trequire($phpbb_root_path . 'phpbb/filesystem.' . $phpEx);\n\t$phpbb_filesystem = new phpbb\\filesystem\\filesystem();\n\t$script_path = $phpbb_filesystem->clean_path($script_path);\n\n\t$url = (($secure) ? 'https://' : 'http://') . $server_name;\n\n\tif ($server_port && (($secure && $server_port <> 443) || (!$secure && $server_port <> 80)))\n\t{\n\t\t// HTTP HOST can carry a port number...\n\t\tif (strpos($server_name, ':') === false)\n\t\t{\n\t\t\t$url .= ':' . $server_port;\n\t\t}\n\t}\n\n\t$url .= $script_path;\n\theader('Location: ' . $url);\n\texit;\n}\n\n// In case $phpbb_adm_relative_path is not set (in case of an update), use the default.\n$phpbb_adm_relative_path = (isset($phpbb_adm_relative_path)) ? $phpbb_adm_relative_path : 'adm/';\n$phpbb_admin_path = (defined('PHPBB_ADMIN_PATH')) ? PHPBB_ADMIN_PATH : $phpbb_root_path . $phpbb_adm_relative_path;\n\n// Include files\nrequire($phpbb_root_path . 'includes/functions.' . $phpEx);\nrequire($phpbb_root_path . 'includes/functions_content.' . $phpEx);\ninclude($phpbb_root_path . 'includes/functions_compatibility.' . $phpEx);\n\nrequire($phpbb_root_path . 'includes/constants.' . $phpEx);\n\n}\n\n\n\n\n/* Inclusion of includes/utf/utf_tools.php starts here */\n\n\n\n/**\n*\n* This file is part of the phpBB Forum Software package.\n*\n* @copyright (c) phpBB Limited <https://www.phpbb.com>\n* @license GNU General Public License, version 2 (GPL-2.0)\n*\n* For full copyright and license information, please see\n* the docs/CREDITS.txt file.\n*\n*/\n\n/**\n*/\nnamespace  {\nif (!defined('IN_PHPBB'))\n{\n\texit;\n}\n\n// Enforce ASCII only string handling\nsetlocale(LC_CTYPE, 'C');\n\n/**\n* Setup the UTF-8 portability layer\n*/\nPatchwork\\Utf8\\Bootup::initUtf8Encode();\nPatchwork\\Utf8\\Bootup::initMbstring();\nPatchwork\\Utf8\\Bootup::initIntl();\n\n/**\n* UTF-8 tools\n*\n* Whenever possible, these functions will try to use PHP's built-in functions or\n* extensions, otherwise they will default to custom routines.\n*\n*/\n\n/**\n* UTF-8 aware alternative to strrpos\n* @ignore\n*/\nfunction utf8_strrpos($str,\t$needle, $offset = null)\n{\n\t// Emulate behaviour of strrpos rather than raising warning\n\tif (empty($str))\n\t{\n\t\treturn false;\n\t}\n\n\tif (is_null($offset))\n\t{\n\t\treturn mb_strrpos($str, $needle);\n\t}\n\telse\n\t{\n\t\treturn mb_strrpos($str, $needle, $offset);\n\t}\n}\n\n/**\n* UTF-8 aware alternative to strpos\n* @ignore\n*/\nfunction utf8_strpos($str, $needle, $offset = null)\n{\n\tif (is_null($offset))\n\t{\n\t\treturn mb_strpos($str, $needle);\n\t}\n\telse\n\t{\n\t\treturn mb_strpos($str, $needle, $offset);\n\t}\n}\n\n/**\n* UTF-8 aware alternative to strtolower\n* @ignore\n*/\nfunction utf8_strtolower($str)\n{\n\treturn mb_strtolower($str);\n}\n\n/**\n* UTF-8 aware alternative to strtoupper\n* @ignore\n*/\nfunction utf8_strtoupper($str)\n{\n\treturn mb_strtoupper($str);\n}\n\n/**\n* UTF-8 aware alternative to substr\n* @ignore\n*/\nfunction utf8_substr($str, $offset, $length = null)\n{\n\tif (is_null($length))\n\t{\n\t\treturn mb_substr($str, $offset);\n\t}\n\telse\n\t{\n\t\treturn mb_substr($str, $offset, $length);\n\t}\n}\n\n/**\n* Return the length (in characters) of a UTF-8 string\n* @ignore\n*/\nfunction utf8_strlen($text)\n{\n\treturn mb_strlen($text, 'utf-8');\n}\n\n/**\n* UTF-8 aware alternative to str_split\n* Convert a string to an array\n*\n* @author Harry Fuecks\n* @param string $str UTF-8 encoded\n* @param int $split_len number to characters to split string by\n* @return array characters in string reverses\n*/\nfunction utf8_str_split($str, $split_len = 1)\n{\n\tif (!is_int($split_len) || $split_len < 1)\n\t{\n\t\treturn false;\n\t}\n\n\t$len = utf8_strlen($str);\n\tif ($len <= $split_len)\n\t{\n\t\treturn array($str);\n\t}\n\n\tpreg_match_all('/.{' . $split_len . '}|[^\\x00]{1,' . $split_len . '}$/us', $str, $ar);\n\treturn $ar[0];\n}\n\n/**\n* UTF-8 aware alternative to strspn\n* Find length of initial segment matching the mask\n*\n* @author Harry Fuecks\n*/\nfunction utf8_strspn($str, $mask, $start = null, $length = null)\n{\n\tif ($start !== null || $length !== null)\n\t{\n\t\t$str = utf8_substr($str, $start, $length);\n\t}\n\n\tpreg_match('/^[' . $mask . ']+/u', $str, $matches);\n\n\tif (isset($matches[0]))\n\t{\n\t\treturn utf8_strlen($matches[0]);\n\t}\n\n\treturn 0;\n}\n\n/**\n* UTF-8 aware alternative to ucfirst\n* Make a string's first character uppercase\n*\n* @author Harry Fuecks\n* @param string\n* @return string with first character as upper case (if applicable)\n*/\nfunction utf8_ucfirst($str)\n{\n\tswitch (utf8_strlen($str))\n\t{\n\t\tcase 0:\n\t\t\treturn '';\n\t\tbreak;\n\n\t\tcase 1:\n\t\t\treturn utf8_strtoupper($str);\n\t\tbreak;\n\n\t\tdefault:\n\t\t\tpreg_match('/^(.{1})(.*)$/us', $str, $matches);\n\t\t\treturn utf8_strtoupper($matches[1]) . $matches[2];\n\t\tbreak;\n\t}\n}\n\n/**\n* Recode a string to UTF-8\n*\n* If the encoding is not supported, the string is returned as-is\n*\n* @param\tstring\t$string\t\tOriginal string\n* @param\tstring\t$encoding\tOriginal encoding (lowered)\n* @return\tstring\t\t\t\tThe string, encoded in UTF-8\n*/\nfunction utf8_recode($string, $encoding)\n{\n\t$encoding = strtolower($encoding);\n\n\tif ($encoding == 'utf-8' || !is_string($string) || empty($string))\n\t{\n\t\treturn $string;\n\t}\n\n\t// we force iso-8859-1 to be cp1252\n\tif ($encoding == 'iso-8859-1')\n\t{\n\t\t$encoding = 'cp1252';\n\t}\n\t// convert iso-8859-8-i to iso-8859-8\n\telse if ($encoding == 'iso-8859-8-i')\n\t{\n\t\t$encoding = 'iso-8859-8';\n\t\t$string = hebrev($string);\n\t}\n\n\t// First, try iconv()\n\tif (function_exists('iconv'))\n\t{\n\t\t$ret = @iconv($encoding, 'utf-8', $string);\n\n\t\tif (!empty($ret))\n\t\t{\n\t\t\treturn $ret;\n\t\t}\n\t}\n\n\t// Try the mb_string extension\n\tif (function_exists('mb_convert_encoding'))\n\t{\n\t\t// mbstring is nasty on PHP4, we must make *sure* that we send a good encoding\n\t\tswitch ($encoding)\n\t\t{\n\t\t\tcase 'iso-8859-1':\n\t\t\tcase 'iso-8859-2':\n\t\t\tcase 'iso-8859-4':\n\t\t\tcase 'iso-8859-7':\n\t\t\tcase 'iso-8859-9':\n\t\t\tcase 'iso-8859-15':\n\t\t\tcase 'windows-1251':\n\t\t\tcase 'windows-1252':\n\t\t\tcase 'cp1252':\n\t\t\tcase 'shift_jis':\n\t\t\tcase 'euc-kr':\n\t\t\tcase 'big5':\n\t\t\tcase 'gb2312':\n\t\t\t\t$ret = @mb_convert_encoding($string, 'utf-8', $encoding);\n\n\t\t\t\tif (!empty($ret))\n\t\t\t\t{\n\t\t\t\t\treturn $ret;\n\t\t\t\t}\n\t\t}\n\t}\n\n\t// Try the recode extension\n\tif (function_exists('recode_string'))\n\t{\n\t\t$ret = @recode_string($encoding . '..utf-8', $string);\n\n\t\tif (!empty($ret))\n\t\t{\n\t\t\treturn $ret;\n\t\t}\n\t}\n\n\t// If nothing works, check if we have a custom transcoder available\n\tif (!preg_match('#^[a-z0-9_ \\\\-]+$#', $encoding))\n\t{\n\t\t// Make sure the encoding name is alphanumeric, we don't want it to be abused into loading arbitrary files\n\t\ttrigger_error('Unknown encoding: ' . $encoding, E_USER_ERROR);\n\t}\n\n\tglobal $phpbb_root_path, $phpEx;\n\n\t// iso-8859-* character encoding\n\tif (preg_match('/iso[_ -]?8859[_ -]?(\\\\d+)/', $encoding, $array))\n\t{\n\t\tswitch ($array[1])\n\t\t{\n\t\t\tcase '1':\n\t\t\tcase '2':\n\t\t\tcase '4':\n\t\t\tcase '7':\n\t\t\tcase '8':\n\t\t\tcase '9':\n\t\t\tcase '15':\n\t\t\t\tif (!function_exists('iso_8859_' . $array[1]))\n\t\t\t\t{\n\t\t\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx))\n\t\t\t\t\t{\n\t\t\t\t\t\ttrigger_error('Basic reencoder file is missing', E_USER_ERROR);\n\t\t\t\t\t}\n\t\t\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx);\n\t\t\t\t}\n\t\t\t\treturn call_user_func('iso_8859_' . $array[1], $string);\n\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\ttrigger_error('Unknown encoding: ' . $encoding, E_USER_ERROR);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// CP/WIN character encoding\n\tif (preg_match('/(?:cp|windows)[_\\- ]?(\\\\d+)/', $encoding, $array))\n\t{\n\t\tswitch ($array[1])\n\t\t{\n\t\t\tcase '932':\n\t\t\tbreak;\n\t\t\tcase '1250':\n\t\t\tcase '1251':\n\t\t\tcase '1252':\n\t\t\tcase '1254':\n\t\t\tcase '1255':\n\t\t\tcase '1256':\n\t\t\tcase '1257':\n\t\t\tcase '874':\n\t\t\t\tif (!function_exists('cp' . $array[1]))\n\t\t\t\t{\n\t\t\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx))\n\t\t\t\t\t{\n\t\t\t\t\t\ttrigger_error('Basic reencoder file is missing', E_USER_ERROR);\n\t\t\t\t\t}\n\t\t\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx);\n\t\t\t\t}\n\t\t\t\treturn call_user_func('cp' . $array[1], $string);\n\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\ttrigger_error('Unknown encoding: ' . $encoding, E_USER_ERROR);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// TIS-620\n\tif (preg_match('/tis[_ -]?620/', $encoding))\n\t{\n\t\tif (!function_exists('tis_620'))\n\t\t{\n\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx))\n\t\t\t{\n\t\t\t\ttrigger_error('Basic reencoder file is missing', E_USER_ERROR);\n\t\t\t}\n\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_basic.' . $phpEx);\n\t\t}\n\t\treturn tis_620($string);\n\t}\n\n\t// SJIS\n\tif (preg_match('/sjis(?:[_ -]?win)?|(?:cp|ibm)[_ -]?932|shift[_ -]?jis/', $encoding))\n\t{\n\t\tif (!function_exists('sjis'))\n\t\t{\n\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx))\n\t\t\t{\n\t\t\t\ttrigger_error('CJK reencoder file is missing', E_USER_ERROR);\n\t\t\t}\n\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx);\n\t\t}\n\t\treturn sjis($string);\n\t}\n\n\t// EUC_KR\n\tif (preg_match('/euc[_ -]?kr/', $encoding))\n\t{\n\t\tif (!function_exists('euc_kr'))\n\t\t{\n\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx))\n\t\t\t{\n\t\t\t\ttrigger_error('CJK reencoder file is missing', E_USER_ERROR);\n\t\t\t}\n\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx);\n\t\t}\n\t\treturn euc_kr($string);\n\t}\n\n\t// BIG-5\n\tif (preg_match('/big[_ -]?5/', $encoding))\n\t{\n\t\tif (!function_exists('big5'))\n\t\t{\n\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx))\n\t\t\t{\n\t\t\t\ttrigger_error('CJK reencoder file is missing', E_USER_ERROR);\n\t\t\t}\n\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx);\n\t\t}\n\t\treturn big5($string);\n\t}\n\n\t// GB2312\n\tif (preg_match('/gb[_ -]?2312/', $encoding))\n\t{\n\t\tif (!function_exists('gb2312'))\n\t\t{\n\t\t\tif (!file_exists($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx))\n\t\t\t{\n\t\t\t\ttrigger_error('CJK reencoder file is missing', E_USER_ERROR);\n\t\t\t}\n\t\t\tinclude($phpbb_root_path . 'includes/utf/data/recode_cjk.' . $phpEx);\n\t\t}\n\t\treturn gb2312($string);\n\t}\n\n\t// Trigger an error?! Fow now just give bad data :-(\n\ttrigger_error('Unknown encoding: ' . $encoding, E_USER_ERROR);\n}\n\n/**\n* Replace all UTF-8 chars that are not in ASCII with their NCR\n*\n* @param\tstring\t$text\t\tUTF-8 string in NFC\n* @return\tstring\t\t\t\tASCII string using NCRs for non-ASCII chars\n*/\nfunction utf8_encode_ncr($text)\n{\n\treturn preg_replace_callback('#[\\\\xC2-\\\\xF4][\\\\x80-\\\\xBF]{1,3}#', 'utf8_encode_ncr_callback', $text);\n}\n\n/**\n* Callback used in encode_ncr()\n*\n* Takes a UTF-8 char and replaces it with its NCR. Attention, $m is an array\n*\n* @param\tarray\t$m\t\t\t0-based numerically indexed array passed by preg_replace_callback()\n* @return\tstring\t\t\t\tA HTML NCR if the character is valid, or the original string otherwise\n*/\nfunction utf8_encode_ncr_callback($m)\n{\n\treturn '&#' . utf8_ord($m[0]) . ';';\n}\n\n/**\n* Converts a UTF-8 char to an NCR\n*\n* @param string $chr UTF-8 char\n* @return integer UNICODE code point\n*/\nfunction utf8_ord($chr)\n{\n\tswitch (strlen($chr))\n\t{\n\t\tcase 1:\n\t\t\treturn ord($chr);\n\t\tbreak;\n\n\t\tcase 2:\n\t\t\treturn ((ord($chr[0]) & 0x1F) << 6) | (ord($chr[1]) & 0x3F);\n\t\tbreak;\n\n\t\tcase 3:\n\t\t\treturn ((ord($chr[0]) & 0x0F) << 12) | ((ord($chr[1]) & 0x3F) << 6) | (ord($chr[2]) & 0x3F);\n\t\tbreak;\n\n\t\tcase 4:\n\t\t\treturn ((ord($chr[0]) & 0x07) << 18) | ((ord($chr[1]) & 0x3F) << 12) | ((ord($chr[2]) & 0x3F) << 6) | (ord($chr[3]) & 0x3F);\n\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn $chr;\n\t}\n}\n\n/**\n* Converts an NCR to a UTF-8 char\n*\n* @param\tint\t\t$cp\tUNICODE code point\n* @return\tstring\t\tUTF-8 char\n*/\nfunction utf8_chr($cp)\n{\n\tif ($cp > 0xFFFF)\n\t{\n\t\treturn chr(0xF0 | ($cp >> 18)) . chr(0x80 | (($cp >> 12) & 0x3F)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));\n\t}\n\telse if ($cp > 0x7FF)\n\t{\n\t\treturn chr(0xE0 | ($cp >> 12)) . chr(0x80 | (($cp >> 6) & 0x3F)) . chr(0x80 | ($cp & 0x3F));\n\t}\n\telse if ($cp > 0x7F)\n\t{\n\t\treturn chr(0xC0 | ($cp >> 6)) . chr(0x80 | ($cp & 0x3F));\n\t}\n\telse\n\t{\n\t\treturn chr($cp);\n\t}\n}\n\n/**\n* Convert Numeric Character References to UTF-8 chars\n*\n* Notes:\n*\t- we do not convert NCRs recursively, if you pass &#38;#38; it will return &#38;\n*\t- we DO NOT check for the existence of the Unicode characters, therefore an entity may be converted to an inexistent codepoint\n*\n* @param\tstring\t$text\t\tString to convert, encoded in UTF-8 (no normal form required)\n* @return\tstring\t\t\t\tUTF-8 string where NCRs have been replaced with the actual chars\n*/\nfunction utf8_decode_ncr($text)\n{\n\treturn preg_replace_callback('/&#([0-9]{1,6}|x[0-9A-F]{1,5});/i', 'utf8_decode_ncr_callback', $text);\n}\n\n/**\n* Callback used in decode_ncr()\n*\n* Takes a NCR (in decimal or hexadecimal) and returns a UTF-8 char. Attention, $m is an array.\n* It will ignore most of invalid NCRs, but not all!\n*\n* @param\tarray\t$m\t\t\t0-based numerically indexed array passed by preg_replace_callback()\n* @return\tstring\t\t\t\tUTF-8 char\n*/\nfunction utf8_decode_ncr_callback($m)\n{\n\t$cp = (strncasecmp($m[1], 'x', 1)) ? $m[1] : hexdec(substr($m[1], 1));\n\n\treturn utf8_chr($cp);\n}\n\n/**\n* Case folds a unicode string as per Unicode 5.0, section 3.13\n*\n* @param\tstring\t$text\ttext to be case folded\n* @param\tstring\t$option\tdetermines how we will fold the cases\n* @return\tstring\t\t\tcase folded text\n*/\nfunction utf8_case_fold($text, $option = 'full')\n{\n\tstatic $uniarray = array();\n\tglobal $phpbb_root_path, $phpEx;\n\n\t// common is always set\n\tif (!isset($uniarray['c']))\n\t{\n\t\t$uniarray['c'] = include($phpbb_root_path . 'includes/utf/data/case_fold_c.' . $phpEx);\n\t}\n\n\t// only set full if we need to\n\tif ($option === 'full' && !isset($uniarray['f']))\n\t{\n\t\t$uniarray['f'] = include($phpbb_root_path . 'includes/utf/data/case_fold_f.' . $phpEx);\n\t}\n\n\t// only set simple if we need to\n\tif ($option !== 'full' && !isset($uniarray['s']))\n\t{\n\t\t$uniarray['s'] = include($phpbb_root_path . 'includes/utf/data/case_fold_s.' . $phpEx);\n\t}\n\n\t// common is always replaced\n\t$text = strtr($text, $uniarray['c']);\n\n\tif ($option === 'full')\n\t{\n\t\t// full replaces a character with multiple characters\n\t\t$text = strtr($text, $uniarray['f']);\n\t}\n\telse\n\t{\n\t\t// simple replaces a character with another character\n\t\t$text = strtr($text, $uniarray['s']);\n\t}\n\n\treturn $text;\n}\n\n/**\n* Takes the input and does a \"special\" case fold. It does minor normalization\n* and returns NFKC compatable text\n*\n* @param\tstring\t$text\ttext to be case folded\n* @param\tstring\t$option\tdetermines how we will fold the cases\n* @return\tstring\t\t\tcase folded text\n*/\nfunction utf8_case_fold_nfkc($text, $option = 'full')\n{\n\tstatic $fc_nfkc_closure = array(\n\t\t\"\\xCD\\xBA\"\t=> \"\\x20\\xCE\\xB9\",\n\t\t\"\\xCF\\x92\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xCF\\x93\"\t=> \"\\xCF\\x8D\",\n\t\t\"\\xCF\\x94\"\t=> \"\\xCF\\x8B\",\n\t\t\"\\xCF\\xB2\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xCF\\xB9\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xE1\\xB4\\xAC\"\t=> \"\\x61\",\n\t\t\"\\xE1\\xB4\\xAD\"\t=> \"\\xC3\\xA6\",\n\t\t\"\\xE1\\xB4\\xAE\"\t=> \"\\x62\",\n\t\t\"\\xE1\\xB4\\xB0\"\t=> \"\\x64\",\n\t\t\"\\xE1\\xB4\\xB1\"\t=> \"\\x65\",\n\t\t\"\\xE1\\xB4\\xB2\"\t=> \"\\xC7\\x9D\",\n\t\t\"\\xE1\\xB4\\xB3\"\t=> \"\\x67\",\n\t\t\"\\xE1\\xB4\\xB4\"\t=> \"\\x68\",\n\t\t\"\\xE1\\xB4\\xB5\"\t=> \"\\x69\",\n\t\t\"\\xE1\\xB4\\xB6\"\t=> \"\\x6A\",\n\t\t\"\\xE1\\xB4\\xB7\"\t=> \"\\x6B\",\n\t\t\"\\xE1\\xB4\\xB8\"\t=> \"\\x6C\",\n\t\t\"\\xE1\\xB4\\xB9\"\t=> \"\\x6D\",\n\t\t\"\\xE1\\xB4\\xBA\"\t=> \"\\x6E\",\n\t\t\"\\xE1\\xB4\\xBC\"\t=> \"\\x6F\",\n\t\t\"\\xE1\\xB4\\xBD\"\t=> \"\\xC8\\xA3\",\n\t\t\"\\xE1\\xB4\\xBE\"\t=> \"\\x70\",\n\t\t\"\\xE1\\xB4\\xBF\"\t=> \"\\x72\",\n\t\t\"\\xE1\\xB5\\x80\"\t=> \"\\x74\",\n\t\t\"\\xE1\\xB5\\x81\"\t=> \"\\x75\",\n\t\t\"\\xE1\\xB5\\x82\"\t=> \"\\x77\",\n\t\t\"\\xE2\\x82\\xA8\"\t=> \"\\x72\\x73\",\n\t\t\"\\xE2\\x84\\x82\"\t=> \"\\x63\",\n\t\t\"\\xE2\\x84\\x83\"\t=> \"\\xC2\\xB0\\x63\",\n\t\t\"\\xE2\\x84\\x87\"\t=> \"\\xC9\\x9B\",\n\t\t\"\\xE2\\x84\\x89\"\t=> \"\\xC2\\xB0\\x66\",\n\t\t\"\\xE2\\x84\\x8B\"\t=> \"\\x68\",\n\t\t\"\\xE2\\x84\\x8C\"\t=> \"\\x68\",\n\t\t\"\\xE2\\x84\\x8D\"\t=> \"\\x68\",\n\t\t\"\\xE2\\x84\\x90\"\t=> \"\\x69\",\n\t\t\"\\xE2\\x84\\x91\"\t=> \"\\x69\",\n\t\t\"\\xE2\\x84\\x92\"\t=> \"\\x6C\",\n\t\t\"\\xE2\\x84\\x95\"\t=> \"\\x6E\",\n\t\t\"\\xE2\\x84\\x96\"\t=> \"\\x6E\\x6F\",\n\t\t\"\\xE2\\x84\\x99\"\t=> \"\\x70\",\n\t\t\"\\xE2\\x84\\x9A\"\t=> \"\\x71\",\n\t\t\"\\xE2\\x84\\x9B\"\t=> \"\\x72\",\n\t\t\"\\xE2\\x84\\x9C\"\t=> \"\\x72\",\n\t\t\"\\xE2\\x84\\x9D\"\t=> \"\\x72\",\n\t\t\"\\xE2\\x84\\xA0\"\t=> \"\\x73\\x6D\",\n\t\t\"\\xE2\\x84\\xA1\"\t=> \"\\x74\\x65\\x6C\",\n\t\t\"\\xE2\\x84\\xA2\"\t=> \"\\x74\\x6D\",\n\t\t\"\\xE2\\x84\\xA4\"\t=> \"\\x7A\",\n\t\t\"\\xE2\\x84\\xA8\"\t=> \"\\x7A\",\n\t\t\"\\xE2\\x84\\xAC\"\t=> \"\\x62\",\n\t\t\"\\xE2\\x84\\xAD\"\t=> \"\\x63\",\n\t\t\"\\xE2\\x84\\xB0\"\t=> \"\\x65\",\n\t\t\"\\xE2\\x84\\xB1\"\t=> \"\\x66\",\n\t\t\"\\xE2\\x84\\xB3\"\t=> \"\\x6D\",\n\t\t\"\\xE2\\x84\\xBB\"\t=> \"\\x66\\x61\\x78\",\n\t\t\"\\xE2\\x84\\xBE\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xE2\\x84\\xBF\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xE2\\x85\\x85\"\t=> \"\\x64\",\n\t\t\"\\xE3\\x89\\x90\"\t=> \"\\x70\\x74\\x65\",\n\t\t\"\\xE3\\x8B\\x8C\"\t=> \"\\x68\\x67\",\n\t\t\"\\xE3\\x8B\\x8E\"\t=> \"\\x65\\x76\",\n\t\t\"\\xE3\\x8B\\x8F\"\t=> \"\\x6C\\x74\\x64\",\n\t\t\"\\xE3\\x8D\\xB1\"\t=> \"\\x68\\x70\\x61\",\n\t\t\"\\xE3\\x8D\\xB3\"\t=> \"\\x61\\x75\",\n\t\t\"\\xE3\\x8D\\xB5\"\t=> \"\\x6F\\x76\",\n\t\t\"\\xE3\\x8D\\xBA\"\t=> \"\\x69\\x75\",\n\t\t\"\\xE3\\x8E\\x80\"\t=> \"\\x70\\x61\",\n\t\t\"\\xE3\\x8E\\x81\"\t=> \"\\x6E\\x61\",\n\t\t\"\\xE3\\x8E\\x82\"\t=> \"\\xCE\\xBC\\x61\",\n\t\t\"\\xE3\\x8E\\x83\"\t=> \"\\x6D\\x61\",\n\t\t\"\\xE3\\x8E\\x84\"\t=> \"\\x6B\\x61\",\n\t\t\"\\xE3\\x8E\\x85\"\t=> \"\\x6B\\x62\",\n\t\t\"\\xE3\\x8E\\x86\"\t=> \"\\x6D\\x62\",\n\t\t\"\\xE3\\x8E\\x87\"\t=> \"\\x67\\x62\",\n\t\t\"\\xE3\\x8E\\x8A\"\t=> \"\\x70\\x66\",\n\t\t\"\\xE3\\x8E\\x8B\"\t=> \"\\x6E\\x66\",\n\t\t\"\\xE3\\x8E\\x8C\"\t=> \"\\xCE\\xBC\\x66\",\n\t\t\"\\xE3\\x8E\\x90\"\t=> \"\\x68\\x7A\",\n\t\t\"\\xE3\\x8E\\x91\"\t=> \"\\x6B\\x68\\x7A\",\n\t\t\"\\xE3\\x8E\\x92\"\t=> \"\\x6D\\x68\\x7A\",\n\t\t\"\\xE3\\x8E\\x93\"\t=> \"\\x67\\x68\\x7A\",\n\t\t\"\\xE3\\x8E\\x94\"\t=> \"\\x74\\x68\\x7A\",\n\t\t\"\\xE3\\x8E\\xA9\"\t=> \"\\x70\\x61\",\n\t\t\"\\xE3\\x8E\\xAA\"\t=> \"\\x6B\\x70\\x61\",\n\t\t\"\\xE3\\x8E\\xAB\"\t=> \"\\x6D\\x70\\x61\",\n\t\t\"\\xE3\\x8E\\xAC\"\t=> \"\\x67\\x70\\x61\",\n\t\t\"\\xE3\\x8E\\xB4\"\t=> \"\\x70\\x76\",\n\t\t\"\\xE3\\x8E\\xB5\"\t=> \"\\x6E\\x76\",\n\t\t\"\\xE3\\x8E\\xB6\"\t=> \"\\xCE\\xBC\\x76\",\n\t\t\"\\xE3\\x8E\\xB7\"\t=> \"\\x6D\\x76\",\n\t\t\"\\xE3\\x8E\\xB8\"\t=> \"\\x6B\\x76\",\n\t\t\"\\xE3\\x8E\\xB9\"\t=> \"\\x6D\\x76\",\n\t\t\"\\xE3\\x8E\\xBA\"\t=> \"\\x70\\x77\",\n\t\t\"\\xE3\\x8E\\xBB\"\t=> \"\\x6E\\x77\",\n\t\t\"\\xE3\\x8E\\xBC\"\t=> \"\\xCE\\xBC\\x77\",\n\t\t\"\\xE3\\x8E\\xBD\"\t=> \"\\x6D\\x77\",\n\t\t\"\\xE3\\x8E\\xBE\"\t=> \"\\x6B\\x77\",\n\t\t\"\\xE3\\x8E\\xBF\"\t=> \"\\x6D\\x77\",\n\t\t\"\\xE3\\x8F\\x80\"\t=> \"\\x6B\\xCF\\x89\",\n\t\t\"\\xE3\\x8F\\x81\"\t=> \"\\x6D\\xCF\\x89\",\n\t\t\"\\xE3\\x8F\\x83\"\t=> \"\\x62\\x71\",\n\t\t\"\\xE3\\x8F\\x86\"\t=> \"\\x63\\xE2\\x88\\x95\\x6B\\x67\",\n\t\t\"\\xE3\\x8F\\x87\"\t=> \"\\x63\\x6F\\x2E\",\n\t\t\"\\xE3\\x8F\\x88\"\t=> \"\\x64\\x62\",\n\t\t\"\\xE3\\x8F\\x89\"\t=> \"\\x67\\x79\",\n\t\t\"\\xE3\\x8F\\x8B\"\t=> \"\\x68\\x70\",\n\t\t\"\\xE3\\x8F\\x8D\"\t=> \"\\x6B\\x6B\",\n\t\t\"\\xE3\\x8F\\x8E\"\t=> \"\\x6B\\x6D\",\n\t\t\"\\xE3\\x8F\\x97\"\t=> \"\\x70\\x68\",\n\t\t\"\\xE3\\x8F\\x99\"\t=> \"\\x70\\x70\\x6D\",\n\t\t\"\\xE3\\x8F\\x9A\"\t=> \"\\x70\\x72\",\n\t\t\"\\xE3\\x8F\\x9C\"\t=> \"\\x73\\x76\",\n\t\t\"\\xE3\\x8F\\x9D\"\t=> \"\\x77\\x62\",\n\t\t\"\\xE3\\x8F\\x9E\"\t=> \"\\x76\\xE2\\x88\\x95\\x6D\",\n\t\t\"\\xE3\\x8F\\x9F\"\t=> \"\\x61\\xE2\\x88\\x95\\x6D\",\n\t\t\"\\xF0\\x9D\\x90\\x80\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x90\\x81\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x90\\x82\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x90\\x83\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x90\\x84\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x90\\x85\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x90\\x86\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x90\\x87\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x90\\x88\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x90\\x89\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x90\\x8A\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x90\\x8B\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x90\\x8C\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x90\\x8D\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x90\\x8E\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x90\\x8F\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x90\\x90\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x90\\x91\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x90\\x92\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x90\\x93\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x90\\x94\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x90\\x95\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x90\\x96\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x90\\x97\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x90\\x98\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x90\\x99\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x90\\xB4\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x90\\xB5\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x90\\xB6\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x90\\xB7\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x90\\xB8\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x90\\xB9\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x90\\xBA\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x90\\xBB\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x90\\xBC\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x90\\xBD\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x90\\xBE\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x90\\xBF\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x91\\x80\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x91\\x81\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x91\\x82\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x91\\x83\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x91\\x84\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x91\\x85\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x91\\x86\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x91\\x87\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x91\\x88\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x91\\x89\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x91\\x8A\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x91\\x8B\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x91\\x8C\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x91\\x8D\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x91\\xA8\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x91\\xA9\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x91\\xAA\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x91\\xAB\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x91\\xAC\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x91\\xAD\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x91\\xAE\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x91\\xAF\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x91\\xB0\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x91\\xB1\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x91\\xB2\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x91\\xB3\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x91\\xB4\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x91\\xB5\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x91\\xB6\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x91\\xB7\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x91\\xB8\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x91\\xB9\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x91\\xBA\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x91\\xBB\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x91\\xBC\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x91\\xBD\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x91\\xBE\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x91\\xBF\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x92\\x80\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x92\\x81\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x92\\x9C\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x92\\x9E\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x92\\x9F\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x92\\xA2\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x92\\xA5\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x92\\xA6\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x92\\xA9\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x92\\xAA\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x92\\xAB\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x92\\xAC\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x92\\xAE\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x92\\xAF\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x92\\xB0\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x92\\xB1\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x92\\xB2\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x92\\xB3\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x92\\xB4\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x92\\xB5\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x93\\x90\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x93\\x91\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x93\\x92\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x93\\x93\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x93\\x94\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x93\\x95\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x93\\x96\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x93\\x97\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x93\\x98\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x93\\x99\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x93\\x9A\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x93\\x9B\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x93\\x9C\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x93\\x9D\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x93\\x9E\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x93\\x9F\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x93\\xA0\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x93\\xA1\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x93\\xA2\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x93\\xA3\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x93\\xA4\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x93\\xA5\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x93\\xA6\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x93\\xA7\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x93\\xA8\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x93\\xA9\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x94\\x84\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x94\\x85\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x94\\x87\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x94\\x88\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x94\\x89\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x94\\x8A\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x94\\x8D\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x94\\x8E\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x94\\x8F\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x94\\x90\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x94\\x91\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x94\\x92\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x94\\x93\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x94\\x94\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x94\\x96\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x94\\x97\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x94\\x98\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x94\\x99\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x94\\x9A\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x94\\x9B\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x94\\x9C\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x94\\xB8\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x94\\xB9\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x94\\xBB\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x94\\xBC\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x94\\xBD\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x94\\xBE\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x95\\x80\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x95\\x81\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x95\\x82\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x95\\x83\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x95\\x84\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x95\\x86\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x95\\x8A\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x95\\x8B\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x95\\x8C\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x95\\x8D\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x95\\x8E\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x95\\x8F\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x95\\x90\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x95\\xAC\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x95\\xAD\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x95\\xAE\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x95\\xAF\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x95\\xB0\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x95\\xB1\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x95\\xB2\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x95\\xB3\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x95\\xB4\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x95\\xB5\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x95\\xB6\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x95\\xB7\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x95\\xB8\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x95\\xB9\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x95\\xBA\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x95\\xBB\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x95\\xBC\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x95\\xBD\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x95\\xBE\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x95\\xBF\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x96\\x80\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x96\\x81\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x96\\x82\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x96\\x83\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x96\\x84\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x96\\x85\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x96\\xA0\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x96\\xA1\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x96\\xA2\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x96\\xA3\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x96\\xA4\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x96\\xA5\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x96\\xA6\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x96\\xA7\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x96\\xA8\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x96\\xA9\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x96\\xAA\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x96\\xAB\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x96\\xAC\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x96\\xAD\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x96\\xAE\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x96\\xAF\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x96\\xB0\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x96\\xB1\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x96\\xB2\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x96\\xB3\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x96\\xB4\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x96\\xB5\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x96\\xB6\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x96\\xB7\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x96\\xB8\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x96\\xB9\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x97\\x94\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x97\\x95\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x97\\x96\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x97\\x97\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x97\\x98\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x97\\x99\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x97\\x9A\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x97\\x9B\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x97\\x9C\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x97\\x9D\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x97\\x9E\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x97\\x9F\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x97\\xA0\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x97\\xA1\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x97\\xA2\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x97\\xA3\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x97\\xA4\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x97\\xA5\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x97\\xA6\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x97\\xA7\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x97\\xA8\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x97\\xA9\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x97\\xAA\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x97\\xAB\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x97\\xAC\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x97\\xAD\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x98\\x88\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x98\\x89\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x98\\x8A\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x98\\x8B\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x98\\x8C\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x98\\x8D\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x98\\x8E\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x98\\x8F\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x98\\x90\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x98\\x91\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x98\\x92\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x98\\x93\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x98\\x94\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x98\\x95\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x98\\x96\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x98\\x97\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x98\\x98\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x98\\x99\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x98\\x9A\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x98\\x9B\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x98\\x9C\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x98\\x9D\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x98\\x9E\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x98\\x9F\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x98\\xA0\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x98\\xA1\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x98\\xBC\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x98\\xBD\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x98\\xBE\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x98\\xBF\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x99\\x80\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x99\\x81\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x99\\x82\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x99\\x83\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x99\\x84\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x99\\x85\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x99\\x86\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x99\\x87\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x99\\x88\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x99\\x89\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x99\\x8A\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x99\\x8B\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x99\\x8C\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x99\\x8D\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x99\\x8E\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x99\\x8F\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x99\\x90\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x99\\x91\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x99\\x92\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x99\\x93\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x99\\x94\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x99\\x95\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x99\\xB0\"\t=> \"\\x61\",\n\t\t\"\\xF0\\x9D\\x99\\xB1\"\t=> \"\\x62\",\n\t\t\"\\xF0\\x9D\\x99\\xB2\"\t=> \"\\x63\",\n\t\t\"\\xF0\\x9D\\x99\\xB3\"\t=> \"\\x64\",\n\t\t\"\\xF0\\x9D\\x99\\xB4\"\t=> \"\\x65\",\n\t\t\"\\xF0\\x9D\\x99\\xB5\"\t=> \"\\x66\",\n\t\t\"\\xF0\\x9D\\x99\\xB6\"\t=> \"\\x67\",\n\t\t\"\\xF0\\x9D\\x99\\xB7\"\t=> \"\\x68\",\n\t\t\"\\xF0\\x9D\\x99\\xB8\"\t=> \"\\x69\",\n\t\t\"\\xF0\\x9D\\x99\\xB9\"\t=> \"\\x6A\",\n\t\t\"\\xF0\\x9D\\x99\\xBA\"\t=> \"\\x6B\",\n\t\t\"\\xF0\\x9D\\x99\\xBB\"\t=> \"\\x6C\",\n\t\t\"\\xF0\\x9D\\x99\\xBC\"\t=> \"\\x6D\",\n\t\t\"\\xF0\\x9D\\x99\\xBD\"\t=> \"\\x6E\",\n\t\t\"\\xF0\\x9D\\x99\\xBE\"\t=> \"\\x6F\",\n\t\t\"\\xF0\\x9D\\x99\\xBF\"\t=> \"\\x70\",\n\t\t\"\\xF0\\x9D\\x9A\\x80\"\t=> \"\\x71\",\n\t\t\"\\xF0\\x9D\\x9A\\x81\"\t=> \"\\x72\",\n\t\t\"\\xF0\\x9D\\x9A\\x82\"\t=> \"\\x73\",\n\t\t\"\\xF0\\x9D\\x9A\\x83\"\t=> \"\\x74\",\n\t\t\"\\xF0\\x9D\\x9A\\x84\"\t=> \"\\x75\",\n\t\t\"\\xF0\\x9D\\x9A\\x85\"\t=> \"\\x76\",\n\t\t\"\\xF0\\x9D\\x9A\\x86\"\t=> \"\\x77\",\n\t\t\"\\xF0\\x9D\\x9A\\x87\"\t=> \"\\x78\",\n\t\t\"\\xF0\\x9D\\x9A\\x88\"\t=> \"\\x79\",\n\t\t\"\\xF0\\x9D\\x9A\\x89\"\t=> \"\\x7A\",\n\t\t\"\\xF0\\x9D\\x9A\\xA8\"\t=> \"\\xCE\\xB1\",\n\t\t\"\\xF0\\x9D\\x9A\\xA9\"\t=> \"\\xCE\\xB2\",\n\t\t\"\\xF0\\x9D\\x9A\\xAA\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xF0\\x9D\\x9A\\xAB\"\t=> \"\\xCE\\xB4\",\n\t\t\"\\xF0\\x9D\\x9A\\xAC\"\t=> \"\\xCE\\xB5\",\n\t\t\"\\xF0\\x9D\\x9A\\xAD\"\t=> \"\\xCE\\xB6\",\n\t\t\"\\xF0\\x9D\\x9A\\xAE\"\t=> \"\\xCE\\xB7\",\n\t\t\"\\xF0\\x9D\\x9A\\xAF\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9A\\xB0\"\t=> \"\\xCE\\xB9\",\n\t\t\"\\xF0\\x9D\\x9A\\xB1\"\t=> \"\\xCE\\xBA\",\n\t\t\"\\xF0\\x9D\\x9A\\xB2\"\t=> \"\\xCE\\xBB\",\n\t\t\"\\xF0\\x9D\\x9A\\xB3\"\t=> \"\\xCE\\xBC\",\n\t\t\"\\xF0\\x9D\\x9A\\xB4\"\t=> \"\\xCE\\xBD\",\n\t\t\"\\xF0\\x9D\\x9A\\xB5\"\t=> \"\\xCE\\xBE\",\n\t\t\"\\xF0\\x9D\\x9A\\xB6\"\t=> \"\\xCE\\xBF\",\n\t\t\"\\xF0\\x9D\\x9A\\xB7\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xF0\\x9D\\x9A\\xB8\"\t=> \"\\xCF\\x81\",\n\t\t\"\\xF0\\x9D\\x9A\\xB9\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9A\\xBA\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9A\\xBB\"\t=> \"\\xCF\\x84\",\n\t\t\"\\xF0\\x9D\\x9A\\xBC\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xF0\\x9D\\x9A\\xBD\"\t=> \"\\xCF\\x86\",\n\t\t\"\\xF0\\x9D\\x9A\\xBE\"\t=> \"\\xCF\\x87\",\n\t\t\"\\xF0\\x9D\\x9A\\xBF\"\t=> \"\\xCF\\x88\",\n\t\t\"\\xF0\\x9D\\x9B\\x80\"\t=> \"\\xCF\\x89\",\n\t\t\"\\xF0\\x9D\\x9B\\x93\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9B\\xA2\"\t=> \"\\xCE\\xB1\",\n\t\t\"\\xF0\\x9D\\x9B\\xA3\"\t=> \"\\xCE\\xB2\",\n\t\t\"\\xF0\\x9D\\x9B\\xA4\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xF0\\x9D\\x9B\\xA5\"\t=> \"\\xCE\\xB4\",\n\t\t\"\\xF0\\x9D\\x9B\\xA6\"\t=> \"\\xCE\\xB5\",\n\t\t\"\\xF0\\x9D\\x9B\\xA7\"\t=> \"\\xCE\\xB6\",\n\t\t\"\\xF0\\x9D\\x9B\\xA8\"\t=> \"\\xCE\\xB7\",\n\t\t\"\\xF0\\x9D\\x9B\\xA9\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9B\\xAA\"\t=> \"\\xCE\\xB9\",\n\t\t\"\\xF0\\x9D\\x9B\\xAB\"\t=> \"\\xCE\\xBA\",\n\t\t\"\\xF0\\x9D\\x9B\\xAC\"\t=> \"\\xCE\\xBB\",\n\t\t\"\\xF0\\x9D\\x9B\\xAD\"\t=> \"\\xCE\\xBC\",\n\t\t\"\\xF0\\x9D\\x9B\\xAE\"\t=> \"\\xCE\\xBD\",\n\t\t\"\\xF0\\x9D\\x9B\\xAF\"\t=> \"\\xCE\\xBE\",\n\t\t\"\\xF0\\x9D\\x9B\\xB0\"\t=> \"\\xCE\\xBF\",\n\t\t\"\\xF0\\x9D\\x9B\\xB1\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xF0\\x9D\\x9B\\xB2\"\t=> \"\\xCF\\x81\",\n\t\t\"\\xF0\\x9D\\x9B\\xB3\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9B\\xB4\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9B\\xB5\"\t=> \"\\xCF\\x84\",\n\t\t\"\\xF0\\x9D\\x9B\\xB6\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xF0\\x9D\\x9B\\xB7\"\t=> \"\\xCF\\x86\",\n\t\t\"\\xF0\\x9D\\x9B\\xB8\"\t=> \"\\xCF\\x87\",\n\t\t\"\\xF0\\x9D\\x9B\\xB9\"\t=> \"\\xCF\\x88\",\n\t\t\"\\xF0\\x9D\\x9B\\xBA\"\t=> \"\\xCF\\x89\",\n\t\t\"\\xF0\\x9D\\x9C\\x8D\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9C\\x9C\"\t=> \"\\xCE\\xB1\",\n\t\t\"\\xF0\\x9D\\x9C\\x9D\"\t=> \"\\xCE\\xB2\",\n\t\t\"\\xF0\\x9D\\x9C\\x9E\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xF0\\x9D\\x9C\\x9F\"\t=> \"\\xCE\\xB4\",\n\t\t\"\\xF0\\x9D\\x9C\\xA0\"\t=> \"\\xCE\\xB5\",\n\t\t\"\\xF0\\x9D\\x9C\\xA1\"\t=> \"\\xCE\\xB6\",\n\t\t\"\\xF0\\x9D\\x9C\\xA2\"\t=> \"\\xCE\\xB7\",\n\t\t\"\\xF0\\x9D\\x9C\\xA3\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9C\\xA4\"\t=> \"\\xCE\\xB9\",\n\t\t\"\\xF0\\x9D\\x9C\\xA5\"\t=> \"\\xCE\\xBA\",\n\t\t\"\\xF0\\x9D\\x9C\\xA6\"\t=> \"\\xCE\\xBB\",\n\t\t\"\\xF0\\x9D\\x9C\\xA7\"\t=> \"\\xCE\\xBC\",\n\t\t\"\\xF0\\x9D\\x9C\\xA8\"\t=> \"\\xCE\\xBD\",\n\t\t\"\\xF0\\x9D\\x9C\\xA9\"\t=> \"\\xCE\\xBE\",\n\t\t\"\\xF0\\x9D\\x9C\\xAA\"\t=> \"\\xCE\\xBF\",\n\t\t\"\\xF0\\x9D\\x9C\\xAB\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xF0\\x9D\\x9C\\xAC\"\t=> \"\\xCF\\x81\",\n\t\t\"\\xF0\\x9D\\x9C\\xAD\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9C\\xAE\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9C\\xAF\"\t=> \"\\xCF\\x84\",\n\t\t\"\\xF0\\x9D\\x9C\\xB0\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xF0\\x9D\\x9C\\xB1\"\t=> \"\\xCF\\x86\",\n\t\t\"\\xF0\\x9D\\x9C\\xB2\"\t=> \"\\xCF\\x87\",\n\t\t\"\\xF0\\x9D\\x9C\\xB3\"\t=> \"\\xCF\\x88\",\n\t\t\"\\xF0\\x9D\\x9C\\xB4\"\t=> \"\\xCF\\x89\",\n\t\t\"\\xF0\\x9D\\x9D\\x87\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9D\\x96\"\t=> \"\\xCE\\xB1\",\n\t\t\"\\xF0\\x9D\\x9D\\x97\"\t=> \"\\xCE\\xB2\",\n\t\t\"\\xF0\\x9D\\x9D\\x98\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xF0\\x9D\\x9D\\x99\"\t=> \"\\xCE\\xB4\",\n\t\t\"\\xF0\\x9D\\x9D\\x9A\"\t=> \"\\xCE\\xB5\",\n\t\t\"\\xF0\\x9D\\x9D\\x9B\"\t=> \"\\xCE\\xB6\",\n\t\t\"\\xF0\\x9D\\x9D\\x9C\"\t=> \"\\xCE\\xB7\",\n\t\t\"\\xF0\\x9D\\x9D\\x9D\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9D\\x9E\"\t=> \"\\xCE\\xB9\",\n\t\t\"\\xF0\\x9D\\x9D\\x9F\"\t=> \"\\xCE\\xBA\",\n\t\t\"\\xF0\\x9D\\x9D\\xA0\"\t=> \"\\xCE\\xBB\",\n\t\t\"\\xF0\\x9D\\x9D\\xA1\"\t=> \"\\xCE\\xBC\",\n\t\t\"\\xF0\\x9D\\x9D\\xA2\"\t=> \"\\xCE\\xBD\",\n\t\t\"\\xF0\\x9D\\x9D\\xA3\"\t=> \"\\xCE\\xBE\",\n\t\t\"\\xF0\\x9D\\x9D\\xA4\"\t=> \"\\xCE\\xBF\",\n\t\t\"\\xF0\\x9D\\x9D\\xA5\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xF0\\x9D\\x9D\\xA6\"\t=> \"\\xCF\\x81\",\n\t\t\"\\xF0\\x9D\\x9D\\xA7\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9D\\xA8\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9D\\xA9\"\t=> \"\\xCF\\x84\",\n\t\t\"\\xF0\\x9D\\x9D\\xAA\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xF0\\x9D\\x9D\\xAB\"\t=> \"\\xCF\\x86\",\n\t\t\"\\xF0\\x9D\\x9D\\xAC\"\t=> \"\\xCF\\x87\",\n\t\t\"\\xF0\\x9D\\x9D\\xAD\"\t=> \"\\xCF\\x88\",\n\t\t\"\\xF0\\x9D\\x9D\\xAE\"\t=> \"\\xCF\\x89\",\n\t\t\"\\xF0\\x9D\\x9E\\x81\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9E\\x90\"\t=> \"\\xCE\\xB1\",\n\t\t\"\\xF0\\x9D\\x9E\\x91\"\t=> \"\\xCE\\xB2\",\n\t\t\"\\xF0\\x9D\\x9E\\x92\"\t=> \"\\xCE\\xB3\",\n\t\t\"\\xF0\\x9D\\x9E\\x93\"\t=> \"\\xCE\\xB4\",\n\t\t\"\\xF0\\x9D\\x9E\\x94\"\t=> \"\\xCE\\xB5\",\n\t\t\"\\xF0\\x9D\\x9E\\x95\"\t=> \"\\xCE\\xB6\",\n\t\t\"\\xF0\\x9D\\x9E\\x96\"\t=> \"\\xCE\\xB7\",\n\t\t\"\\xF0\\x9D\\x9E\\x97\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9E\\x98\"\t=> \"\\xCE\\xB9\",\n\t\t\"\\xF0\\x9D\\x9E\\x99\"\t=> \"\\xCE\\xBA\",\n\t\t\"\\xF0\\x9D\\x9E\\x9A\"\t=> \"\\xCE\\xBB\",\n\t\t\"\\xF0\\x9D\\x9E\\x9B\"\t=> \"\\xCE\\xBC\",\n\t\t\"\\xF0\\x9D\\x9E\\x9C\"\t=> \"\\xCE\\xBD\",\n\t\t\"\\xF0\\x9D\\x9E\\x9D\"\t=> \"\\xCE\\xBE\",\n\t\t\"\\xF0\\x9D\\x9E\\x9E\"\t=> \"\\xCE\\xBF\",\n\t\t\"\\xF0\\x9D\\x9E\\x9F\"\t=> \"\\xCF\\x80\",\n\t\t\"\\xF0\\x9D\\x9E\\xA0\"\t=> \"\\xCF\\x81\",\n\t\t\"\\xF0\\x9D\\x9E\\xA1\"\t=> \"\\xCE\\xB8\",\n\t\t\"\\xF0\\x9D\\x9E\\xA2\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9E\\xA3\"\t=> \"\\xCF\\x84\",\n\t\t\"\\xF0\\x9D\\x9E\\xA4\"\t=> \"\\xCF\\x85\",\n\t\t\"\\xF0\\x9D\\x9E\\xA5\"\t=> \"\\xCF\\x86\",\n\t\t\"\\xF0\\x9D\\x9E\\xA6\"\t=> \"\\xCF\\x87\",\n\t\t\"\\xF0\\x9D\\x9E\\xA7\"\t=> \"\\xCF\\x88\",\n\t\t\"\\xF0\\x9D\\x9E\\xA8\"\t=> \"\\xCF\\x89\",\n\t\t\"\\xF0\\x9D\\x9E\\xBB\"\t=> \"\\xCF\\x83\",\n\t\t\"\\xF0\\x9D\\x9F\\x8A\"\t=> \"\\xCF\\x9D\",\n\t);\n\n\t// do the case fold\n\t$text = utf8_case_fold($text, $option);\n\n\t// convert to NFKC\n\tNormalizer::normalize($text, Normalizer::NFKC);\n\n\t// FC_NFKC_Closure, http://www.unicode.org/Public/5.0.0/ucd/DerivedNormalizationProps.txt\n\t$text = strtr($text, $fc_nfkc_closure);\n\n\treturn $text;\n}\n\n/**\n* Assume the input is NFC:\n* Takes the input and does a \"special\" case fold. It does minor normalization as well.\n*\n* @param\tstring\t$text\ttext to be case folded\n* @param\tstring\t$option\tdetermines how we will fold the cases\n* @return\tstring\t\t\tcase folded text\n*/\nfunction utf8_case_fold_nfc($text, $option = 'full')\n{\n\tstatic $uniarray = array();\n\tstatic $ypogegrammeni = array(\n\t\t\"\\xCD\\xBA\"\t\t=> \"\\x20\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x80\"\t=> \"\\xE1\\xBC\\x80\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x81\"\t=> \"\\xE1\\xBC\\x81\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x82\"\t=> \"\\xE1\\xBC\\x82\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x83\"\t=> \"\\xE1\\xBC\\x83\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x84\"\t=> \"\\xE1\\xBC\\x84\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x85\"\t=> \"\\xE1\\xBC\\x85\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x86\"\t=> \"\\xE1\\xBC\\x86\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x87\"\t=> \"\\xE1\\xBC\\x87\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x88\"\t=> \"\\xE1\\xBC\\x88\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x89\"\t=> \"\\xE1\\xBC\\x89\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8A\"\t=> \"\\xE1\\xBC\\x8A\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8B\"\t=> \"\\xE1\\xBC\\x8B\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8C\"\t=> \"\\xE1\\xBC\\x8C\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8D\"\t=> \"\\xE1\\xBC\\x8D\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8E\"\t=> \"\\xE1\\xBC\\x8E\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x8F\"\t=> \"\\xE1\\xBC\\x8F\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x90\"\t=> \"\\xE1\\xBC\\xA0\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x91\"\t=> \"\\xE1\\xBC\\xA1\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x92\"\t=> \"\\xE1\\xBC\\xA2\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x93\"\t=> \"\\xE1\\xBC\\xA3\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x94\"\t=> \"\\xE1\\xBC\\xA4\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x95\"\t=> \"\\xE1\\xBC\\xA5\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x96\"\t=> \"\\xE1\\xBC\\xA6\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x97\"\t=> \"\\xE1\\xBC\\xA7\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x98\"\t=> \"\\xE1\\xBC\\xA8\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x99\"\t=> \"\\xE1\\xBC\\xA9\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9A\"\t=> \"\\xE1\\xBC\\xAA\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9B\"\t=> \"\\xE1\\xBC\\xAB\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9C\"\t=> \"\\xE1\\xBC\\xAC\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9D\"\t=> \"\\xE1\\xBC\\xAD\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9E\"\t=> \"\\xE1\\xBC\\xAE\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\x9F\"\t=> \"\\xE1\\xBC\\xAF\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA0\"\t=> \"\\xE1\\xBD\\xA0\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA1\"\t=> \"\\xE1\\xBD\\xA1\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA2\"\t=> \"\\xE1\\xBD\\xA2\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA3\"\t=> \"\\xE1\\xBD\\xA3\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA4\"\t=> \"\\xE1\\xBD\\xA4\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA5\"\t=> \"\\xE1\\xBD\\xA5\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA6\"\t=> \"\\xE1\\xBD\\xA6\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA7\"\t=> \"\\xE1\\xBD\\xA7\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA8\"\t=> \"\\xE1\\xBD\\xA8\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xA9\"\t=> \"\\xE1\\xBD\\xA9\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAA\"\t=> \"\\xE1\\xBD\\xAA\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAB\"\t=> \"\\xE1\\xBD\\xAB\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAC\"\t=> \"\\xE1\\xBD\\xAC\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAD\"\t=> \"\\xE1\\xBD\\xAD\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAE\"\t=> \"\\xE1\\xBD\\xAE\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xAF\"\t=> \"\\xE1\\xBD\\xAF\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xB2\"\t=> \"\\xE1\\xBD\\xB0\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xB3\"\t=> \"\\xCE\\xB1\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xB4\"\t=> \"\\xCE\\xAC\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xB7\"\t=> \"\\xE1\\xBE\\xB6\\xCD\\x85\",\n\t\t\"\\xE1\\xBE\\xBC\"\t=> \"\\xCE\\x91\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\x82\"\t=> \"\\xE1\\xBD\\xB4\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\x83\"\t=> \"\\xCE\\xB7\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\x84\"\t=> \"\\xCE\\xAE\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\x87\"\t=> \"\\xE1\\xBF\\x86\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\x8C\"\t=> \"\\xCE\\x97\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\xB2\"\t=> \"\\xE1\\xBD\\xBC\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\xB3\"\t=> \"\\xCF\\x89\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\xB4\"\t=> \"\\xCF\\x8E\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\xB7\"\t=> \"\\xE1\\xBF\\xB6\\xCD\\x85\",\n\t\t\"\\xE1\\xBF\\xBC\"\t=> \"\\xCE\\xA9\\xCD\\x85\",\n\t);\n\n\t// perform a small trick, avoid further normalization on composed points that contain U+0345 in their decomposition\n\t$text = strtr($text, $ypogegrammeni);\n\n\t// do the case fold\n\t$text = utf8_case_fold($text, $option);\n\n\treturn $text;\n}\n\n/**\n* wrapper around PHP's native normalizer from intl\n* previously a PECL extension, included in the core since PHP 5.3.0\n* http://php.net/manual/en/normalizer.normalize.php\n*\n* @param\tmixed\t$strings\ta string or an array of strings to normalize\n* @return\tmixed\t\t\t\tthe normalized content, preserving array keys if array given.\n*/\nfunction utf8_normalize_nfc($strings)\n{\n\tif (empty($strings))\n\t{\n\t\treturn $strings;\n\t}\n\n\tif (!is_array($strings))\n\t{\n\t\tif (Normalizer::isNormalized($strings))\n\t\t{\n\t\t\treturn $strings;\n\t\t}\n\t\treturn (string) Normalizer::normalize($strings);\n\t}\n\telse\n\t{\n\t\tforeach ($strings as $key => $string)\n\t\t{\n\t\t\tif (is_array($string))\n\t\t\t{\n\t\t\t\tforeach ($string as $_key => $_string)\n\t\t\t\t{\n\t\t\t\t\tif (Normalizer::isNormalized($strings[$key][$_key]))\n\t\t\t\t\t{\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t$strings[$key][$_key] = (string) Normalizer::normalize($strings[$key][$_key]);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (Normalizer::isNormalized($strings[$key]))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t$strings[$key] = (string) Normalizer::normalize($strings[$key]);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn $strings;\n}\n\n/**\n* This function is used to generate a \"clean\" version of a string.\n* Clean means that it is a case insensitive form (case folding) and that it is normalized (NFC).\n* Additionally a homographs of one character are transformed into one specific character (preferably ASCII\n* if it is an ASCII character).\n*\n* Please be aware that if you change something within this function or within\n* functions used here you need to rebuild/update the username_clean column in the users table. And all other\n* columns that store a clean string otherwise you will break this functionality.\n*\n* @param\tstring\t$text\tAn unclean string, mabye user input (has to be valid UTF-8!)\n* @return\tstring\t\t\tCleaned up version of the input string\n*/\nfunction utf8_clean_string($text)\n{\n\tglobal $phpbb_root_path, $phpEx;\n\n\tstatic $homographs = array();\n\tif (empty($homographs))\n\t{\n\t\t$homographs = include($phpbb_root_path . 'includes/utf/data/confusables.' . $phpEx);\n\t}\n\n\t$text = utf8_case_fold_nfkc($text);\n\t$text = strtr($text, $homographs);\n\t// Other control characters\n\t$text = preg_replace('#(?:[\\x00-\\x1F\\x7F]+|(?:\\xC2[\\x80-\\x9F])+)#', '', $text);\n\n\t// we need to reduce multiple spaces to a single one\n\t$text = preg_replace('# {2,}#', ' ', $text);\n\n\t// we can use trim here as all the other space characters should have been turned\n\t// into normal ASCII spaces by now\n\treturn trim($text);\n}\n\n/**\n* A wrapper for htmlspecialchars($value, ENT_COMPAT, 'UTF-8')\n*/\nfunction utf8_htmlspecialchars($value)\n{\n\treturn htmlspecialchars($value, ENT_COMPAT, 'UTF-8');\n}\n\n/**\n* Trying to convert returned system message to utf8\n*\n* PHP assumes such messages are ISO-8859-1 so we'll do that too\n* and if it breaks messages we'll blame it on them ;-)\n*/\nfunction utf8_convert_message($message)\n{\n\t// First of all check if conversion is neded at all, as there is no point\n\t// in converting ASCII messages from ISO-8859-1 to UTF-8\n\tif (!preg_match('/[\\x80-\\xFF]/', $message))\n\t{\n\t\treturn utf8_htmlspecialchars($message);\n\t}\n\n\t// else we need to convert some part of the message\n\treturn utf8_htmlspecialchars(utf8_recode($message, 'ISO-8859-1'));\n}\n\n/**\n* UTF8-compatible wordwrap replacement\n*\n* @param\tstring\t$string\tThe input string\n* @param\tint\t\t$width\tThe column width. Defaults to 75.\n* @param\tstring\t$break\tThe line is broken using the optional break parameter. Defaults to '\\n'.\n* @param\tbool\t$cut\tIf the cut is set to TRUE, the string is always wrapped at the specified width. So if you have a word that is larger than the given width, it is broken apart.\n*\n* @return\tstring\t\t\tthe given string wrapped at the specified column.\n*\n*/\nfunction utf8_wordwrap($string, $width = 75, $break = \"\\n\", $cut = false)\n{\n\t// We first need to explode on $break, not destroying existing (intended) breaks\n\t$lines = explode($break, $string);\n\t$new_lines = array(0 => '');\n\t$index = 0;\n\n\tforeach ($lines as $line)\n\t{\n\t\t$words = explode(' ', $line);\n\n\t\tfor ($i = 0, $size = sizeof($words); $i < $size; $i++)\n\t\t{\n\t\t\t$word = $words[$i];\n\n\t\t\t// If cut is true we need to cut the word if it is > width chars\n\t\t\tif ($cut && utf8_strlen($word) > $width)\n\t\t\t{\n\t\t\t\t$words[$i] = utf8_substr($word, $width);\n\t\t\t\t$word = utf8_substr($word, 0, $width);\n\t\t\t\t$i--;\n\t\t\t}\n\n\t\t\tif (utf8_strlen($new_lines[$index] . $word) > $width)\n\t\t\t{\n\t\t\t\t$new_lines[$index] = substr($new_lines[$index], 0, -1);\n\t\t\t\t$index++;\n\t\t\t\t$new_lines[$index] = '';\n\t\t\t}\n\n\t\t\t$new_lines[$index] .= $word . ' ';\n\t\t}\n\n\t\t$new_lines[$index] = substr($new_lines[$index], 0, -1);\n\t\t$index++;\n\t\t$new_lines[$index] = '';\n\t}\n\n\tunset($new_lines[$index]);\n\treturn implode($break, $new_lines);\n}\n\n/**\n* UTF8-safe basename() function\n*\n* basename() has some limitations and is dependent on the locale setting\n* according to the PHP manual. Therefore we provide our own locale independent\n* basename function.\n*\n* @param string $filename The filename basename() should be applied to\n* @return string The basenamed filename\n*/\nfunction utf8_basename($filename)\n{\n\t// We always check for forward slash AND backward slash\n\t// because they could be mixed or \"sneaked\" in. ;)\n\t// You know, never trust user input...\n\tif (strpos($filename, '/') !== false)\n\t{\n\t\t$filename = utf8_substr($filename, utf8_strrpos($filename, '/') + 1);\n\t}\n\n\tif (strpos($filename, '\\\\') !== false)\n\t{\n\t\t$filename = utf8_substr($filename, utf8_strrpos($filename, '\\\\') + 1);\n\t}\n\n\treturn $filename;\n}\n\n}\n\n/* Inclusion of includes/utf/utf_tools.php ends here */\n\n\n\nnamespace  {\n\n\nif (PHPBB_ENVIRONMENT === 'development')\n{\n\t\\phpbb\\debug\\debug::enable();\n}\nelse\n{\n\tset_error_handler(defined('PHPBB_MSG_HANDLER') ? PHPBB_MSG_HANDLER : 'msg_handler');\n}\n\n$phpbb_class_loader_ext = new \\phpbb\\class_loader('\\\\', \"{$phpbb_root_path}ext/\", $phpEx);\n$phpbb_class_loader_ext->register();\n\n// Set up container\ntry\n{\n\t$phpbb_container_builder = new \\phpbb\\di\\container_builder($phpbb_root_path, $phpEx);\n\t$phpbb_container = $phpbb_container_builder->with_config($phpbb_config_php_file)->get_container();\n}\ncatch (InvalidArgumentException $e)\n{\n\tif (PHPBB_ENVIRONMENT !== 'development')\n\t{\n\t\ttrigger_error(\n\t\t\t'The requested environment ' . PHPBB_ENVIRONMENT . ' is not available.',\n\t\t\tE_USER_ERROR\n\t\t);\n\t}\n\telse\n\t{\n\t\tthrow $e;\n\t}\n}\n\n$phpbb_class_loader->set_cache($phpbb_container->get('cache.driver'));\n$phpbb_class_loader_ext->set_cache($phpbb_container->get('cache.driver'));\n\nrequire($phpbb_root_path . 'includes/compatibility_globals.' . $phpEx);\n\nregister_compatibility_globals();\n\n// Add own hook handler\nrequire($phpbb_root_path . 'includes/hooks/index.' . $phpEx);\n$phpbb_hook = new phpbb_hook(array('exit_handler', 'phpbb_user_session_handler', 'append_sid', array('template', 'display')));\n\n/* @var $phpbb_hook_finder \\phpbb\\hook\\finder */\n$phpbb_hook_finder = $phpbb_container->get('hook_finder');\n\nforeach ($phpbb_hook_finder->find() as $hook)\n{\n\t@include($phpbb_root_path . 'includes/hooks/' . $hook . '.' . $phpEx);\n}\n\n/**\n* Main event which is triggered on every page\n*\n* You can use this event to load function files and initiate objects\n*\n* NOTE:\tAt this point the global session ($user) and permissions ($auth)\n*\t\tdo NOT exist yet. If you need to use the user object\n*\t\t(f.e. to include language files) or need to check permissions,\n*\t\tplease use the core.user_setup event instead!\n*\n* @event core.common\n* @since 3.1.0-a1\n*/\n$phpbb_dispatcher->dispatch('core.common');\n\n}\n\n/* Inclusion of common.php ends here */\n\n\n\nnamespace  {\n\ninclude($phpbb_root_path . 'includes/functions_display.' . $phpEx);\ninclude($phpbb_root_path . 'includes/bbcode.' . $phpEx);\ninclude($phpbb_root_path . 'includes/functions_user.' . $phpEx);\n\n// Start session management\n$user->session_begin();\n$auth->acl($user->data);\n\n// Initial var setup\n$forum_id\t= $request->variable('f', 0);\n$topic_id\t= $request->variable('t', 0);\n$post_id\t= $request->variable('p', 0);\n$voted_id\t= $request->variable('vote_id', array('' => 0));\n\n$voted_id = (sizeof($voted_id) > 1) ? array_unique($voted_id) : $voted_id;\n\n\n$start\t\t= $request->variable('start', 0);\n$view\t\t= $request->variable('view', '');\n\n$default_sort_days\t= (!empty($user->data['user_post_show_days'])) ? $user->data['user_post_show_days'] : 0;\n$default_sort_key\t= (!empty($user->data['user_post_sortby_type'])) ? $user->data['user_post_sortby_type'] : 't';\n$default_sort_dir\t= (!empty($user->data['user_post_sortby_dir'])) ? $user->data['user_post_sortby_dir'] : 'a';\n\n$sort_days\t= $request->variable('st', $default_sort_days);\n$sort_key\t= $request->variable('sk', $default_sort_key);\n$sort_dir\t= $request->variable('sd', $default_sort_dir);\n\n$update\t\t= $request->variable('update', false);\n\n/* @var $pagination \\phpbb\\pagination */\n$pagination = $phpbb_container->get('pagination');\n\n$s_can_vote = false;\n/**\n* @todo normalize?\n*/\n$hilit_words\t= $request->variable('hilit', '', true);\n\n// Do we have a topic or post id?\nif (!$topic_id && !$post_id)\n{\n\ttrigger_error('NO_TOPIC');\n}\n\n/* @var $phpbb_content_visibility \\phpbb\\content_visibility */\n$phpbb_content_visibility = $phpbb_container->get('content.visibility');\n\n// Find topic id if user requested a newer or older topic\nif ($view && !$post_id)\n{\n\tif (!$forum_id)\n\t{\n\t\t$sql = 'SELECT forum_id\n\t\t\tFROM ' . TOPICS_TABLE . \"\n\t\t\tWHERE topic_id = $topic_id\";\n\t\t$result = $db->sql_query($sql);\n\t\t$forum_id = (int) $db->sql_fetchfield('forum_id');\n\t\t$db->sql_freeresult($result);\n\n\t\tif (!$forum_id)\n\t\t{\n\t\t\ttrigger_error('NO_TOPIC');\n\t\t}\n\t}\n\n\tif ($view == 'unread')\n\t{\n\t\t// Get topic tracking info\n\t\t$topic_tracking_info = get_complete_topic_tracking($forum_id, $topic_id);\n\t\t$topic_last_read = (isset($topic_tracking_info[$topic_id])) ? $topic_tracking_info[$topic_id] : 0;\n\n\t\t$sql = 'SELECT post_id, topic_id, forum_id\n\t\t\tFROM ' . POSTS_TABLE . \"\n\t\t\tWHERE topic_id = $topic_id\n\t\t\t\tAND \" . $phpbb_content_visibility->get_visibility_sql('post', $forum_id) . \"\n\t\t\t\tAND post_time > $topic_last_read\n\t\t\t\tAND forum_id = $forum_id\n\t\t\tORDER BY post_time ASC, post_id ASC\";\n\t\t$result = $db->sql_query_limit($sql, 1);\n\t\t$row = $db->sql_fetchrow($result);\n\t\t$db->sql_freeresult($result);\n\n\t\tif (!$row)\n\t\t{\n\t\t\t$sql = 'SELECT topic_last_post_id as post_id, topic_id, forum_id\n\t\t\t\tFROM ' . TOPICS_TABLE . '\n\t\t\t\tWHERE topic_id = ' . $topic_id;\n\t\t\t$result = $db->sql_query($sql);\n\t\t\t$row = $db->sql_fetchrow($result);\n\t\t\t$db->sql_freeresult($result);\n\t\t}\n\n\t\tif (!$row)\n\t\t{\n\t\t\t// Setup user environment so we can process lang string\n\t\t\t$user->setup('viewtopic');\n\n\t\t\ttrigger_error('NO_TOPIC');\n\t\t}\n\n\t\t$post_id = $row['post_id'];\n\t\t$topic_id = $row['topic_id'];\n\t}\n\telse if ($view == 'next' || $view == 'previous')\n\t{\n\t\t$sql_condition = ($view == 'next') ? '>' : '<';\n\t\t$sql_ordering = ($view == 'next') ? 'ASC' : 'DESC';\n\n\t\t$sql = 'SELECT forum_id, topic_last_post_time\n\t\t\tFROM ' . TOPICS_TABLE . '\n\t\t\tWHERE topic_id = ' . $topic_id;\n\t\t$result = $db->sql_query($sql);\n\t\t$row = $db->sql_fetchrow($result);\n\t\t$db->sql_freeresult($result);\n\n\t\tif (!$row)\n\t\t{\n\t\t\t$user->setup('viewtopic');\n\t\t\t// OK, the topic doesn't exist. This error message is not helpful, but technically correct.\n\t\t\ttrigger_error(($view == 'next') ? 'NO_NEWER_TOPICS' : 'NO_OLDER_TOPICS');\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$sql = 'SELECT topic_id, forum_id\n\t\t\t\tFROM ' . TOPICS_TABLE . '\n\t\t\t\tWHERE forum_id = ' . $row['forum_id'] . \"\n\t\t\t\t\tAND topic_moved_id = 0\n\t\t\t\t\tAND topic_last_post_time $sql_condition {$row['topic_last_post_time']}\n\t\t\t\t\tAND \" . $phpbb_content_visibility->get_visibility_sql('topic', $row['forum_id']) . \"\n\t\t\t\tORDER BY topic_last_post_time $sql_ordering, topic_last_post_id $sql_ordering\";\n\t\t\t$result = $db->sql_query_limit($sql, 1);\n\t\t\t$row = $db->sql_fetchrow($result);\n\t\t\t$db->sql_freeresult($result);\n\n\t\t\tif (!$row)\n\t\t\t{\n\t\t\t\t$sql = 'SELECT forum_style\n\t\t\t\t\tFROM ' . FORUMS_TABLE . \"\n\t\t\t\t\tWHERE forum_id = $forum_id\";\n\t\t\t\t$result = $db->sql_query($sql);\n\t\t\t\t$forum_style = (int) $db->sql_fetchfield('forum_style');\n\t\t\t\t$db->sql_freeresult($result);\n\n\t\t\t\t$user->setup('viewtopic', $forum_style);\n\t\t\t\ttrigger_error(($view == 'next') ? 'NO_NEWER_TOPICS' : 'NO_OLDER_TOPICS');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$topic_id = $row['topic_id'];\n\t\t\t\t$forum_id = $row['forum_id'];\n\t\t\t}\n\t\t}\n\t}\n\n\tif (isset($row) && $row['forum_id'])\n\t{\n\t\t$forum_id = $row['forum_id'];\n\t}\n}\n\n// This rather complex gaggle of code handles querying for topics but\n// also allows for direct linking to a post (and the calculation of which\n// page the post is on and the correct display of viewtopic)\n$sql_array = array(\n\t'SELECT'\t=> 't.*, f.*',\n\n\t'FROM'\t\t=> array(FORUMS_TABLE => 'f'),\n);\n\n// The FROM-Order is quite important here, else t.* columns can not be correctly bound.\nif ($post_id)\n{\n\t$sql_array['SELECT'] .= ', p.post_visibility, p.post_time, p.post_id';\n\t$sql_array['FROM'][POSTS_TABLE] = 'p';\n}\n\n// Topics table need to be the last in the chain\n$sql_array['FROM'][TOPICS_TABLE] = 't';\n\nif ($user->data['is_registered'])\n{\n\t$sql_array['SELECT'] .= ', tw.notify_status';\n\t$sql_array['LEFT_JOIN'] = array();\n\n\t$sql_array['LEFT_JOIN'][] = array(\n\t\t'FROM'\t=> array(TOPICS_WATCH_TABLE => 'tw'),\n\t\t'ON'\t=> 'tw.user_id = ' . $user->data['user_id'] . ' AND t.topic_id = tw.topic_id'\n\t);\n\n\tif ($config['allow_bookmarks'])\n\t{\n\t\t$sql_array['SELECT'] .= ', bm.topic_id as bookmarked';\n\t\t$sql_array['LEFT_JOIN'][] = array(\n\t\t\t'FROM'\t=> array(BOOKMARKS_TABLE => 'bm'),\n\t\t\t'ON'\t=> 'bm.user_id = ' . $user->data['user_id'] . ' AND t.topic_id = bm.topic_id'\n\t\t);\n\t}\n\n\tif ($config['load_db_lastread'])\n\t{\n\t\t$sql_array['SELECT'] .= ', tt.mark_time, ft.mark_time as forum_mark_time';\n\n\t\t$sql_array['LEFT_JOIN'][] = array(\n\t\t\t'FROM'\t=> array(TOPICS_TRACK_TABLE => 'tt'),\n\t\t\t'ON'\t=> 'tt.user_id = ' . $user->data['user_id'] . ' AND t.topic_id = tt.topic_id'\n\t\t);\n\n\t\t$sql_array['LEFT_JOIN'][] = array(\n\t\t\t'FROM'\t=> array(FORUMS_TRACK_TABLE => 'ft'),\n\t\t\t'ON'\t=> 'ft.user_id = ' . $user->data['user_id'] . ' AND t.forum_id = ft.forum_id'\n\t\t);\n\t}\n}\n\nif (!$post_id)\n{\n\t$sql_array['WHERE'] = \"t.topic_id = $topic_id\";\n}\nelse\n{\n\t$sql_array['WHERE'] = \"p.post_id = $post_id AND t.topic_id = p.topic_id\";\n}\n\n$sql_array['WHERE'] .= ' AND f.forum_id = t.forum_id';\n\n$sql = $db->sql_build_query('SELECT', $sql_array);\n$result = $db->sql_query($sql);\n$topic_data = $db->sql_fetchrow($result);\n$db->sql_freeresult($result);\n\n// link to unapproved post or incorrect link\nif (!$topic_data)\n{\n\t// If post_id was submitted, we try at least to display the topic as a last resort...\n\tif ($post_id && $topic_id)\n\t{\n\t\tredirect(append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"t=$topic_id\" . (($forum_id) ? \"&amp;f=$forum_id\" : '')));\n\t}\n\n\ttrigger_error('NO_TOPIC');\n}\n\n$forum_id = (int) $topic_data['forum_id'];\n\n// Now we know the forum_id and can check the permissions\nif ($topic_data['topic_visibility'] != ITEM_APPROVED && !$auth->acl_get('m_approve', $forum_id))\n{\n\ttrigger_error('NO_TOPIC');\n}\n\n// This is for determining where we are (page)\nif ($post_id)\n{\n\t// are we where we are supposed to be?\n\tif (($topic_data['post_visibility'] == ITEM_UNAPPROVED || $topic_data['post_visibility'] == ITEM_REAPPROVE) && !$auth->acl_get('m_approve', $topic_data['forum_id']))\n\t{\n\t\t// If post_id was submitted, we try at least to display the topic as a last resort...\n\t\tif ($topic_id)\n\t\t{\n\t\t\tredirect(append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"t=$topic_id\" . (($forum_id) ? \"&amp;f=$forum_id\" : '')));\n\t\t}\n\n\t\ttrigger_error('NO_TOPIC');\n\t}\n\tif ($post_id == $topic_data['topic_first_post_id'] || $post_id == $topic_data['topic_last_post_id'])\n\t{\n\t\t$check_sort = ($post_id == $topic_data['topic_first_post_id']) ? 'd' : 'a';\n\n\t\tif ($sort_dir == $check_sort)\n\t\t{\n\t\t\t$topic_data['prev_posts'] = $phpbb_content_visibility->get_count('topic_posts', $topic_data, $forum_id) - 1;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$topic_data['prev_posts'] = 0;\n\t\t}\n\t}\n\telse\n\t{\n\t\t$sql = 'SELECT COUNT(p.post_id) AS prev_posts\n\t\t\tFROM ' . POSTS_TABLE . \" p\n\t\t\tWHERE p.topic_id = {$topic_data['topic_id']}\n\t\t\t\tAND \" . $phpbb_content_visibility->get_visibility_sql('post', $forum_id, 'p.');\n\n\t\tif ($sort_dir == 'd')\n\t\t{\n\t\t\t$sql .= \" AND (p.post_time > {$topic_data['post_time']} OR (p.post_time = {$topic_data['post_time']} AND p.post_id >= {$topic_data['post_id']}))\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$sql .= \" AND (p.post_time < {$topic_data['post_time']} OR (p.post_time = {$topic_data['post_time']} AND p.post_id <= {$topic_data['post_id']}))\";\n\t\t}\n\n\t\t$result = $db->sql_query($sql);\n\t\t$row = $db->sql_fetchrow($result);\n\t\t$db->sql_freeresult($result);\n\n\t\t$topic_data['prev_posts'] = $row['prev_posts'] - 1;\n\t}\n}\n\n$topic_id = (int) $topic_data['topic_id'];\n$topic_replies = $phpbb_content_visibility->get_count('topic_posts', $topic_data, $forum_id) - 1;\n\n// Check sticky/announcement/global  time limit\nif (($topic_data['topic_type'] != POST_NORMAL) && $topic_data['topic_time_limit'] && ($topic_data['topic_time'] + $topic_data['topic_time_limit']) < time())\n{\n\t$sql = 'UPDATE ' . TOPICS_TABLE . '\n\t\tSET topic_type = ' . POST_NORMAL . ', topic_time_limit = 0\n\t\tWHERE topic_id = ' . $topic_id;\n\t$db->sql_query($sql);\n\n\t$topic_data['topic_type'] = POST_NORMAL;\n\t$topic_data['topic_time_limit'] = 0;\n}\n\n// Setup look and feel\n$user->setup('viewtopic', $topic_data['forum_style']);\n\n$overrides_f_read_check = false;\n$overrides_forum_password_check = false;\n$topic_tracking_info = isset($topic_tracking_info) ? $topic_tracking_info : null;\n\n/**\n* Event to apply extra permissions and to override original phpBB's f_read permission and forum password check\n* on viewtopic access\n*\n* @event core.viewtopic_before_f_read_check\n* @var\tint\t\tforum_id\t\t\t\t\t\tThe forum id from where the topic belongs\n* @var\tint\t\ttopic_id\t\t\t\t\t\tThe id of the topic the user tries to access\n* @var\tint\t\tpost_id\t\t\t\t\t\t\tThe id of the post the user tries to start viewing at.\n*\t\t\t\t\t\t\t\t\t\t\t\tIt may be 0 for none given.\n* @var\tarray\ttopic_data\t\t\t\t\t\tAll the information from the topic and forum tables for this topic\n* \t\t\t\t\t\t\t\t\t\t\t\tIt includes posts information if post_id is not 0\n* @var\tbool\toverrides_f_read_check\t\t\tSet true to remove f_read check afterwards\n* @var\tbool\toverrides_forum_password_check\tSet true to remove forum_password check afterwards\n* @var\tarray\ttopic_tracking_info\t\t\t\tInformation upon calling get_topic_tracking()\n*\t\t\t\t\t\t\t\t\t\t\t\tSet it to NULL to allow auto-filling later.\n*\t\t\t\t\t\t\t\t\t\t\t\tSet it to an array to override original data.\n* @since 3.1.3-RC1\n*/\n$vars = array(\n\t'forum_id',\n\t'topic_id',\n\t'post_id',\n\t'topic_data',\n\t'overrides_f_read_check',\n\t'overrides_forum_password_check',\n\t'topic_tracking_info',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_before_f_read_check', compact($vars)));\n\n// Start auth check\nif (!$overrides_f_read_check && !$auth->acl_get('f_read', $forum_id))\n{\n\tif ($user->data['user_id'] != ANONYMOUS)\n\t{\n\t\tsend_status_line(403, 'Forbidden');\n\t\ttrigger_error('SORRY_AUTH_READ');\n\t}\n\n\tlogin_box('', $user->lang['LOGIN_VIEWFORUM']);\n}\n\n// Forum is passworded ... check whether access has been granted to this\n// user this session, if not show login box\nif (!$overrides_forum_password_check && $topic_data['forum_password'])\n{\n\tlogin_forum_box($topic_data);\n}\n\n// Redirect to login upon emailed notification links if user is not logged in.\nif (isset($_GET['e']) && $user->data['user_id'] == ANONYMOUS)\n{\n\tlogin_box(build_url('e') . '#unread', $user->lang['LOGIN_NOTIFY_TOPIC']);\n}\n\n// What is start equal to?\nif ($post_id)\n{\n\t$start = floor(($topic_data['prev_posts']) / $config['posts_per_page']) * $config['posts_per_page'];\n}\n\n// Get topic tracking info\nif (!isset($topic_tracking_info))\n{\n\t$topic_tracking_info = array();\n\n\t// Get topic tracking info\n\tif ($config['load_db_lastread'] && $user->data['is_registered'])\n\t{\n\t\t$tmp_topic_data = array($topic_id => $topic_data);\n\t\t$topic_tracking_info = get_topic_tracking($forum_id, $topic_id, $tmp_topic_data, array($forum_id => $topic_data['forum_mark_time']));\n\t\tunset($tmp_topic_data);\n\t}\n\telse if ($config['load_anon_lastread'] || $user->data['is_registered'])\n\t{\n\t\t$topic_tracking_info = get_complete_topic_tracking($forum_id, $topic_id);\n\t}\n}\n\n// Post ordering options\n$limit_days = array(0 => $user->lang['ALL_POSTS'], 1 => $user->lang['1_DAY'], 7 => $user->lang['7_DAYS'], 14 => $user->lang['2_WEEKS'], 30 => $user->lang['1_MONTH'], 90 => $user->lang['3_MONTHS'], 180 => $user->lang['6_MONTHS'], 365 => $user->lang['1_YEAR']);\n\n$sort_by_text = array('a' => $user->lang['AUTHOR'], 't' => $user->lang['POST_TIME'], 's' => $user->lang['SUBJECT']);\n$sort_by_sql = array('a' => array('u.username_clean', 'p.post_id'), 't' => array('p.post_time', 'p.post_id'), 's' => array('p.post_subject', 'p.post_id'));\n$join_user_sql = array('a' => true, 't' => false, 's' => false);\n\n$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';\n\ngen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param, $default_sort_days, $default_sort_key, $default_sort_dir);\n\n// Obtain correct post count and ordering SQL if user has\n// requested anything different\nif ($sort_days)\n{\n\t$min_post_time = time() - ($sort_days * 86400);\n\n\t$sql = 'SELECT COUNT(post_id) AS num_posts\n\t\tFROM ' . POSTS_TABLE . \"\n\t\tWHERE topic_id = $topic_id\n\t\t\tAND post_time >= $min_post_time\n\t\t\t\tAND \" . $phpbb_content_visibility->get_visibility_sql('post', $forum_id);\n\t$result = $db->sql_query($sql);\n\t$total_posts = (int) $db->sql_fetchfield('num_posts');\n\t$db->sql_freeresult($result);\n\n\t$limit_posts_time = \"AND p.post_time >= $min_post_time \";\n\n\tif (isset($_POST['sort']))\n\t{\n\t\t$start = 0;\n\t}\n}\nelse\n{\n\t$total_posts = $topic_replies + 1;\n\t$limit_posts_time = '';\n}\n\n// Was a highlight request part of the URI?\n$highlight_match = $highlight = '';\nif ($hilit_words)\n{\n\t$highlight_match = phpbb_clean_search_string($hilit_words);\n\t$highlight = urlencode($highlight_match);\n\t$highlight_match = str_replace('\\*', '\\w+?', preg_quote($highlight_match, '#'));\n\t$highlight_match = preg_replace('#(?<=^|\\s)\\\\\\\\w\\*\\?(?=\\s|$)#', '\\w+?', $highlight_match);\n\t$highlight_match = str_replace(' ', '|', $highlight_match);\n}\n\n// Make sure $start is set to the last page if it exceeds the amount\n$start = $pagination->validate_start($start, $config['posts_per_page'], $total_posts);\n\n// General Viewtopic URL for return links\n$viewtopic_url = append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id\" . (($start == 0) ? '' : \"&amp;start=$start\") . ((strlen($u_sort_param)) ? \"&amp;$u_sort_param\" : '') . (($highlight_match) ? \"&amp;hilit=$highlight\" : ''));\n\n// Are we watching this topic?\n$s_watching_topic = array(\n\t'link'\t\t\t=> '',\n\t'link_toggle'\t=> '',\n\t'title'\t\t\t=> '',\n\t'title_toggle'\t=> '',\n\t'is_watching'\t=> false,\n);\n\nif ($config['allow_topic_notify'])\n{\n\t$notify_status = (isset($topic_data['notify_status'])) ? $topic_data['notify_status'] : null;\n\twatch_topic_forum('topic', $s_watching_topic, $user->data['user_id'], $forum_id, $topic_id, $notify_status, $start, $topic_data['topic_title']);\n\n\t// Reset forum notification if forum notify is set\n\tif ($config['allow_forum_notify'] && $auth->acl_get('f_subscribe', $forum_id))\n\t{\n\t\t$s_watching_forum = $s_watching_topic;\n\t\twatch_topic_forum('forum', $s_watching_forum, $user->data['user_id'], $forum_id, 0);\n\t}\n}\n\n/**\n* Event to modify highlight.\n*\n* @event core.viewtopic_highlight_modify\n* @var\tstring\thighlight\t\t\tString to be highlighted\n* @var\tstring\thighlight_match\t\tHighlight string to be used in preg_replace\n* @var\tarray\ttopic_data\t\t\tTopic data\n* @var\tint\t\tstart\t\t\t\tPagination start\n* @var\tint\t\ttotal_posts\t\t\tNumber of posts\n* @var\tstring\tviewtopic_url\t\tCurrent viewtopic URL\n* @since 3.1.11-RC1\n*/\n$vars = array(\n\t'highlight',\n\t'highlight_match',\n\t'topic_data',\n\t'start',\n\t'total_posts',\n\t'viewtopic_url',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_highlight_modify', compact($vars)));\n\n// Bookmarks\nif ($config['allow_bookmarks'] && $user->data['is_registered'] && $request->variable('bookmark', 0))\n{\n\tif (check_link_hash($request->variable('hash', ''), \"topic_$topic_id\"))\n\t{\n\t\tif (!$topic_data['bookmarked'])\n\t\t{\n\t\t\t$sql = 'INSERT INTO ' . BOOKMARKS_TABLE . ' ' . $db->sql_build_array('INSERT', array(\n\t\t\t\t'user_id'\t=> $user->data['user_id'],\n\t\t\t\t'topic_id'\t=> $topic_id,\n\t\t\t));\n\t\t\t$db->sql_query($sql);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$sql = 'DELETE FROM ' . BOOKMARKS_TABLE . \"\n\t\t\t\tWHERE user_id = {$user->data['user_id']}\n\t\t\t\t\tAND topic_id = $topic_id\";\n\t\t\t$db->sql_query($sql);\n\t\t}\n\t\t$message = (($topic_data['bookmarked']) ? $user->lang['BOOKMARK_REMOVED'] : $user->lang['BOOKMARK_ADDED']);\n\n\t\tif (!$request->is_ajax())\n\t\t{\n\t\t\t$message .= '<br /><br />' . $user->lang('RETURN_TOPIC', '<a href=\"' . $viewtopic_url . '\">', '</a>');\n\t\t}\n\t}\n\telse\n\t{\n\t\t$message = $user->lang['BOOKMARK_ERR'];\n\n\t\tif (!$request->is_ajax())\n\t\t{\n\t\t\t$message .= '<br /><br />' . $user->lang('RETURN_TOPIC', '<a href=\"' . $viewtopic_url . '\">', '</a>');\n\t\t}\n\t}\n\tmeta_refresh(3, $viewtopic_url);\n\n\ttrigger_error($message);\n}\n\n// Grab ranks\n$ranks = $cache->obtain_ranks();\n\n// Grab icons\n$icons = $cache->obtain_icons();\n\n// Grab extensions\n$extensions = array();\nif ($topic_data['topic_attachment'])\n{\n\t$extensions = $cache->obtain_attach_extensions($forum_id);\n}\n\n// Forum rules listing\n$s_forum_rules = '';\ngen_forum_auth_level('topic', $forum_id, $topic_data['forum_status']);\n\n// Quick mod tools\n$allow_change_type = ($auth->acl_get('m_', $forum_id) || ($user->data['is_registered'] && $user->data['user_id'] == $topic_data['topic_poster'])) ? true : false;\n\n$s_quickmod_action = append_sid(\n\t\"{$phpbb_root_path}mcp.$phpEx\",\n\tarray(\n\t\t'f'\t=> $forum_id,\n\t\t't'\t=> $topic_id,\n\t\t'start'\t\t=> $start,\n\t\t'quickmod'\t=> 1,\n\t\t'redirect'\t=> urlencode(str_replace('&amp;', '&', $viewtopic_url)),\n\t),\n\ttrue,\n\t$user->session_id\n);\n\n$quickmod_array = array(\n//\t'key'\t\t\t=> array('LANG_KEY', $userHasPermissions),\n\n\t'lock'\t\t\t\t\t=> array('LOCK_TOPIC', ($topic_data['topic_status'] == ITEM_UNLOCKED) && ($auth->acl_get('m_lock', $forum_id) || ($auth->acl_get('f_user_lock', $forum_id) && $user->data['is_registered'] && $user->data['user_id'] == $topic_data['topic_poster']))),\n\t'unlock'\t\t\t\t=> array('UNLOCK_TOPIC', ($topic_data['topic_status'] != ITEM_UNLOCKED) && ($auth->acl_get('m_lock', $forum_id))),\n\t'delete_topic'\t\t=> array('DELETE_TOPIC', ($auth->acl_get('m_delete', $forum_id) || (($topic_data['topic_visibility'] != ITEM_DELETED) && $auth->acl_get('m_softdelete', $forum_id)))),\n\t'restore_topic'\t\t=> array('RESTORE_TOPIC', (($topic_data['topic_visibility'] == ITEM_DELETED) && $auth->acl_get('m_approve', $forum_id))),\n\t'move'\t\t\t\t\t=> array('MOVE_TOPIC', $auth->acl_get('m_move', $forum_id) && $topic_data['topic_status'] != ITEM_MOVED),\n\t'split'\t\t\t\t\t=> array('SPLIT_TOPIC', $auth->acl_get('m_split', $forum_id)),\n\t'merge'\t\t\t\t\t=> array('MERGE_POSTS', $auth->acl_get('m_merge', $forum_id)),\n\t'merge_topic'\t\t=> array('MERGE_TOPIC', $auth->acl_get('m_merge', $forum_id)),\n\t'fork'\t\t\t\t\t=> array('FORK_TOPIC', $auth->acl_get('m_move', $forum_id)),\n\t'make_normal'\t\t=> array('MAKE_NORMAL', ($allow_change_type && $auth->acl_gets('f_sticky', 'f_announce', 'f_announce_global', $forum_id) && $topic_data['topic_type'] != POST_NORMAL)),\n\t'make_sticky'\t\t=> array('MAKE_STICKY', ($allow_change_type && $auth->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY)),\n\t'make_announce'\t=> array('MAKE_ANNOUNCE', ($allow_change_type && $auth->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE)),\n\t'make_global'\t\t=> array('MAKE_GLOBAL', ($allow_change_type && $auth->acl_get('f_announce_global', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL)),\n\t'topic_logs'\t\t\t=> array('VIEW_TOPIC_LOGS', $auth->acl_get('m_', $forum_id)),\n);\n\n/**\n* Event to modify data in the quickmod_array before it gets sent to the\n* phpbb_add_quickmod_option function.\n*\n* @event core.viewtopic_add_quickmod_option_before\n* @var\tint\t\t\t\tforum_id\t\t\t\tForum ID\n* @var\tint\t\t\t\tpost_id\t\t\t\t\tPost ID\n* @var\tarray\t\t\tquickmod_array\t\t\tArray with quick moderation options data\n* @var\tarray\t\t\ttopic_data\t\t\t\tArray with topic data\n* @var\tint\t\t\t\ttopic_id\t\t\t\tTopic ID\n* @var\tarray\t\t\ttopic_tracking_info\t\tArray with topic tracking data\n* @var\tstring\t\t\tviewtopic_url\t\t\tURL to the topic page\n* @var\tbool\t\t\tallow_change_type\t\tTopic change permissions check\n* @since 3.1.9-RC1\n*/\n$vars = array(\n\t'forum_id',\n\t'post_id',\n\t'quickmod_array',\n\t'topic_data',\n\t'topic_id',\n\t'topic_tracking_info',\n\t'viewtopic_url',\n\t'allow_change_type',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_add_quickmod_option_before', compact($vars)));\n\nforeach ($quickmod_array as $option => $qm_ary)\n{\n\tif (!empty($qm_ary[1]))\n\t{\n\t\tphpbb_add_quickmod_option($s_quickmod_action, $option, $qm_ary[0]);\n\t}\n}\n\n// Navigation links\ngenerate_forum_nav($topic_data);\n\n// Forum Rules\ngenerate_forum_rules($topic_data);\n\n// Moderators\n$forum_moderators = array();\nif ($config['load_moderators'])\n{\n\tget_moderators($forum_moderators, $forum_id);\n}\n\n// This is only used for print view so ...\n$server_path = (!$view) ? $phpbb_root_path : generate_board_url() . '/';\n\n// Replace naughty words in title\n$topic_data['topic_title'] = censor_text($topic_data['topic_title']);\n\n$s_search_hidden_fields = array(\n\t't' => $topic_id,\n\t'sf' => 'msgonly',\n);\nif ($_SID)\n{\n\t$s_search_hidden_fields['sid'] = $_SID;\n}\n\nif (!empty($_EXTRA_URL))\n{\n\tforeach ($_EXTRA_URL as $url_param)\n\t{\n\t\t$url_param = explode('=', $url_param, 2);\n\t\t$s_search_hidden_fields[$url_param[0]] = $url_param[1];\n\t}\n}\n\n// If we've got a hightlight set pass it on to pagination.\n$base_url = append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id\" . ((strlen($u_sort_param)) ? \"&amp;$u_sort_param\" : '') . (($highlight_match) ? \"&amp;hilit=$highlight\" : ''));\n\n/**\n* Event to modify data before template variables are being assigned\n*\n* @event core.viewtopic_assign_template_vars_before\n* @var\tstring\tbase_url\t\t\tURL to be passed to generate pagination\n* @var\tint\t\tforum_id\t\t\tForum ID\n* @var\tint\t\tpost_id\t\t\t\tPost ID\n* @var\tarray\tquickmod_array\t\tArray with quick moderation options data\n* @var\tint\t\tstart\t\t\t\tPagination information\n* @var\tarray\ttopic_data\t\t\tArray with topic data\n* @var\tint\t\ttopic_id\t\t\tTopic ID\n* @var\tarray\ttopic_tracking_info\tArray with topic tracking data\n* @var\tint\t\ttotal_posts\t\t\tTopic total posts count\n* @var\tstring\tviewtopic_url\t\tURL to the topic page\n* @since 3.1.0-RC4\n* @changed 3.1.2-RC1 Added viewtopic_url\n*/\n$vars = array(\n\t'base_url',\n\t'forum_id',\n\t'post_id',\n\t'quickmod_array',\n\t'start',\n\t'topic_data',\n\t'topic_id',\n\t'topic_tracking_info',\n\t'total_posts',\n\t'viewtopic_url',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_assign_template_vars_before', compact($vars)));\n\n$pagination->generate_template_pagination($base_url, 'pagination', 'start', $total_posts, $config['posts_per_page'], $start);\n\n// Send vars to template\n$template->assign_vars(array(\n\t'FORUM_ID' \t\t=> $forum_id,\n\t'FORUM_NAME' \t=> $topic_data['forum_name'],\n\t'FORUM_DESC'\t=> generate_text_for_display($topic_data['forum_desc'], $topic_data['forum_desc_uid'], $topic_data['forum_desc_bitfield'], $topic_data['forum_desc_options']),\n\t'TOPIC_ID' \t\t=> $topic_id,\n\t'TOPIC_TITLE' \t=> $topic_data['topic_title'],\n\t'TOPIC_POSTER'\t=> $topic_data['topic_poster'],\n\n\t'TOPIC_AUTHOR_FULL'\t\t=> get_username_string('full', $topic_data['topic_poster'], $topic_data['topic_first_poster_name'], $topic_data['topic_first_poster_colour']),\n\t'TOPIC_AUTHOR_COLOUR'\t=> get_username_string('colour', $topic_data['topic_poster'], $topic_data['topic_first_poster_name'], $topic_data['topic_first_poster_colour']),\n\t'TOPIC_AUTHOR'\t\t\t=> get_username_string('username', $topic_data['topic_poster'], $topic_data['topic_first_poster_name'], $topic_data['topic_first_poster_colour']),\n\n\t'TOTAL_POSTS'\t=> $user->lang('VIEW_TOPIC_POSTS', (int) $total_posts),\n\t'U_MCP' \t\t=> ($auth->acl_get('m_', $forum_id)) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", \"i=main&amp;mode=topic_view&amp;f=$forum_id&amp;t=$topic_id\" . (($start == 0) ? '' : \"&amp;start=$start\") . ((strlen($u_sort_param)) ? \"&amp;$u_sort_param\" : ''), true, $user->session_id) : '',\n\t'MODERATORS'\t=> (isset($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id])) ? implode($user->lang['COMMA_SEPARATOR'], $forum_moderators[$forum_id]) : '',\n\n\t'POST_IMG' \t\t\t=> ($topic_data['forum_status'] == ITEM_LOCKED) ? $user->img('button_topic_locked', 'FORUM_LOCKED') : $user->img('button_topic_new', 'POST_NEW_TOPIC'),\n\t'QUOTE_IMG' \t\t=> $user->img('icon_post_quote', 'REPLY_WITH_QUOTE'),\n\t'REPLY_IMG'\t\t\t=> ($topic_data['forum_status'] == ITEM_LOCKED || $topic_data['topic_status'] == ITEM_LOCKED) ? $user->img('button_topic_locked', 'TOPIC_LOCKED') : $user->img('button_topic_reply', 'REPLY_TO_TOPIC'),\n\t'EDIT_IMG' \t\t\t=> $user->img('icon_post_edit', 'EDIT_POST'),\n\t'DELETE_IMG' \t\t=> $user->img('icon_post_delete', 'DELETE_POST'),\n\t'DELETED_IMG'\t\t=> $user->img('icon_topic_deleted', 'POST_DELETED_RESTORE'),\n\t'INFO_IMG' \t\t\t=> $user->img('icon_post_info', 'VIEW_INFO'),\n\t'PROFILE_IMG'\t\t=> $user->img('icon_user_profile', 'READ_PROFILE'),\n\t'SEARCH_IMG' \t\t=> $user->img('icon_user_search', 'SEARCH_USER_POSTS'),\n\t'PM_IMG' \t\t\t=> $user->img('icon_contact_pm', 'SEND_PRIVATE_MESSAGE'),\n\t'EMAIL_IMG' \t\t=> $user->img('icon_contact_email', 'SEND_EMAIL'),\n\t'JABBER_IMG'\t\t=> $user->img('icon_contact_jabber', 'JABBER') ,\n\t'REPORT_IMG'\t\t=> $user->img('icon_post_report', 'REPORT_POST'),\n\t'REPORTED_IMG'\t\t=> $user->img('icon_topic_reported', 'POST_REPORTED'),\n\t'UNAPPROVED_IMG'\t=> $user->img('icon_topic_unapproved', 'POST_UNAPPROVED'),\n\t'WARN_IMG'\t\t\t=> $user->img('icon_user_warn', 'WARN_USER'),\n\n\t'S_IS_LOCKED'\t\t\t=> ($topic_data['topic_status'] == ITEM_UNLOCKED && $topic_data['forum_status'] == ITEM_UNLOCKED) ? false : true,\n\t'S_SELECT_SORT_DIR' \t=> $s_sort_dir,\n\t'S_SELECT_SORT_KEY' \t=> $s_sort_key,\n\t'S_SELECT_SORT_DAYS' \t=> $s_limit_days,\n\t'S_SINGLE_MODERATOR'\t=> (!empty($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id]) > 1) ? false : true,\n\t'S_TOPIC_ACTION' \t\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id\" . (($start == 0) ? '' : \"&amp;start=$start\")),\n\t'S_MOD_ACTION' \t\t\t=> $s_quickmod_action,\n\n\t'L_RETURN_TO_FORUM'\t\t=> $user->lang('RETURN_TO', $topic_data['forum_name']),\n\t'S_VIEWTOPIC'\t\t\t=> true,\n\t'S_UNREAD_VIEW'\t\t\t=> $view == 'unread',\n\t'S_DISPLAY_SEARCHBOX'\t=> ($auth->acl_get('u_search') && $auth->acl_get('f_search', $forum_id) && $config['load_search']) ? true : false,\n\t'S_SEARCHBOX_ACTION'\t=> append_sid(\"{$phpbb_root_path}search.$phpEx\"),\n\t'S_SEARCH_LOCAL_HIDDEN_FIELDS'\t=> build_hidden_fields($s_search_hidden_fields),\n\n\t'S_DISPLAY_POST_INFO'\t=> ($topic_data['forum_type'] == FORUM_POST && ($auth->acl_get('f_post', $forum_id) || $user->data['user_id'] == ANONYMOUS)) ? true : false,\n\t'S_DISPLAY_REPLY_INFO'\t=> ($topic_data['forum_type'] == FORUM_POST && ($auth->acl_get('f_reply', $forum_id) || $user->data['user_id'] == ANONYMOUS)) ? true : false,\n\t'S_ENABLE_FEEDS_TOPIC'\t=> ($config['feed_topic'] && !phpbb_optionget(FORUM_OPTION_FEED_EXCLUDE, $topic_data['forum_options'])) ? true : false,\n\n\t'U_TOPIC'\t\t\t\t=> \"{$server_path}viewtopic.$phpEx?f=$forum_id&amp;t=$topic_id\",\n\t'U_FORUM'\t\t\t\t=> $server_path,\n\t'U_VIEW_TOPIC' \t\t\t=> $viewtopic_url,\n\t'U_CANONICAL'\t\t\t=> generate_board_url() . '/' . append_sid(\"viewtopic.$phpEx\", \"t=$topic_id\" . (($start) ? \"&amp;start=$start\" : ''), true, ''),\n\t'U_VIEW_FORUM' \t\t\t=> append_sid(\"{$phpbb_root_path}viewforum.$phpEx\", 'f=' . $forum_id),\n\t'U_VIEW_OLDER_TOPIC'\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id&amp;view=previous\"),\n\t'U_VIEW_NEWER_TOPIC'\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id&amp;view=next\"),\n\t'U_PRINT_TOPIC'\t\t\t=> ($auth->acl_get('f_print', $forum_id)) ? $viewtopic_url . '&amp;view=print' : '',\n\t'U_EMAIL_TOPIC'\t\t\t=> ($auth->acl_get('f_email', $forum_id) && $config['email_enable']) ? append_sid(\"{$phpbb_root_path}memberlist.$phpEx\", \"mode=email&amp;t=$topic_id\") : '',\n\n\t'U_WATCH_TOPIC'\t\t\t=> $s_watching_topic['link'],\n\t'U_WATCH_TOPIC_TOGGLE'\t=> $s_watching_topic['link_toggle'],\n\t'S_WATCH_TOPIC_TITLE'\t=> $s_watching_topic['title'],\n\t'S_WATCH_TOPIC_TOGGLE'\t=> $s_watching_topic['title_toggle'],\n\t'S_WATCHING_TOPIC'\t\t=> $s_watching_topic['is_watching'],\n\n\t'U_BOOKMARK_TOPIC'\t\t=> ($user->data['is_registered'] && $config['allow_bookmarks']) ? $viewtopic_url . '&amp;bookmark=1&amp;hash=' . generate_link_hash(\"topic_$topic_id\") : '',\n\t'S_BOOKMARK_TOPIC'\t\t=> ($user->data['is_registered'] && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? $user->lang['BOOKMARK_TOPIC_REMOVE'] : $user->lang['BOOKMARK_TOPIC'],\n\t'S_BOOKMARK_TOGGLE'\t\t=> (!$user->data['is_registered'] || !$config['allow_bookmarks'] || !$topic_data['bookmarked']) ? $user->lang['BOOKMARK_TOPIC_REMOVE'] : $user->lang['BOOKMARK_TOPIC'],\n\t'S_BOOKMARKED_TOPIC'\t=> ($user->data['is_registered'] && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? true : false,\n\n\t'U_POST_NEW_TOPIC' \t\t=> ($auth->acl_get('f_post', $forum_id) || $user->data['user_id'] == ANONYMOUS) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=post&amp;f=$forum_id\") : '',\n\t'U_POST_REPLY_TOPIC' \t=> ($auth->acl_get('f_reply', $forum_id) || $user->data['user_id'] == ANONYMOUS) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=reply&amp;f=$forum_id&amp;t=$topic_id\") : '',\n\t'U_BUMP_TOPIC'\t\t\t=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=bump&amp;f=$forum_id&amp;t=$topic_id&amp;hash=\" . generate_link_hash(\"topic_$topic_id\")) : '')\n);\n\n// Does this topic contain a poll?\nif (!empty($topic_data['poll_start']))\n{\n\t$sql = 'SELECT o.*, p.bbcode_bitfield, p.bbcode_uid\n\t\tFROM ' . POLL_OPTIONS_TABLE . ' o, ' . POSTS_TABLE . \" p\n\t\tWHERE o.topic_id = $topic_id\n\t\t\tAND p.post_id = {$topic_data['topic_first_post_id']}\n\t\t\tAND p.topic_id = o.topic_id\n\t\tORDER BY o.poll_option_id\";\n\t$result = $db->sql_query($sql);\n\n\t$poll_info = $vote_counts = array();\n\twhile ($row = $db->sql_fetchrow($result))\n\t{\n\t\t$poll_info[] = $row;\n\t\t$option_id = (int) $row['poll_option_id'];\n\t\t$vote_counts[$option_id] = (int) $row['poll_option_total'];\n\t}\n\t$db->sql_freeresult($result);\n\n\t$cur_voted_id = array();\n\tif ($user->data['is_registered'])\n\t{\n\t\t$sql = 'SELECT poll_option_id\n\t\t\tFROM ' . POLL_VOTES_TABLE . '\n\t\t\tWHERE topic_id = ' . $topic_id . '\n\t\t\t\tAND vote_user_id = ' . $user->data['user_id'];\n\t\t$result = $db->sql_query($sql);\n\n\t\twhile ($row = $db->sql_fetchrow($result))\n\t\t{\n\t\t\t$cur_voted_id[] = $row['poll_option_id'];\n\t\t}\n\t\t$db->sql_freeresult($result);\n\t}\n\telse\n\t{\n\t\t// Cookie based guest tracking ... I don't like this but hum ho\n\t\t// it's oft requested. This relies on \"nice\" users who don't feel\n\t\t// the need to delete cookies to mess with results.\n\t\tif ($request->is_set($config['cookie_name'] . '_poll_' . $topic_id, \\phpbb\\request\\request_interface::COOKIE))\n\t\t{\n\t\t\t$cur_voted_id = explode(',', $request->variable($config['cookie_name'] . '_poll_' . $topic_id, '', true, \\phpbb\\request\\request_interface::COOKIE));\n\t\t\t$cur_voted_id = array_map('intval', $cur_voted_id);\n\t\t}\n\t}\n\n\t// Can not vote at all if no vote permission\n\t$s_can_vote = ($auth->acl_get('f_vote', $forum_id) &&\n\t\t(($topic_data['poll_length'] != 0 && $topic_data['poll_start'] + $topic_data['poll_length'] > time()) || $topic_data['poll_length'] == 0) &&\n\t\t$topic_data['topic_status'] != ITEM_LOCKED &&\n\t\t$topic_data['forum_status'] != ITEM_LOCKED &&\n\t\t(!sizeof($cur_voted_id) ||\n\t\t($auth->acl_get('f_votechg', $forum_id) && $topic_data['poll_vote_change']))) ? true : false;\n\t$s_display_results = (!$s_can_vote || ($s_can_vote && sizeof($cur_voted_id)) || $view == 'viewpoll') ? true : false;\n\n\t/**\n\t* Event to manipulate the poll data\n\t*\n\t* @event core.viewtopic_modify_poll_data\n\t* @var\tarray\tcur_voted_id\t\t\t\tArray with options' IDs current user has voted for\n\t* @var\tint\t\tforum_id\t\t\t\t\tThe topic's forum id\n\t* @var\tarray\tpoll_info\t\t\t\t\tArray with the poll information\n\t* @var\tbool\ts_can_vote\t\t\t\t\tFlag indicating if a user can vote\n\t* @var\tbool\ts_display_results\t\t\tFlag indicating if results or poll options should be displayed\n\t* @var\tint\t\ttopic_id\t\t\t\t\tThe id of the topic the user tries to access\n\t* @var\tarray\ttopic_data\t\t\t\t\tAll the information from the topic and forum tables for this topic\n\t* @var\tstring\tviewtopic_url\t\t\t\tURL to the topic page\n\t* @var\tarray\tvote_counts\t\t\t\t\tArray with the vote counts for every poll option\n\t* @var\tarray\tvoted_id\t\t\t\t\tArray with updated options' IDs current user is voting for\n\t* @since 3.1.5-RC1\n\t*/\n\t$vars = array(\n\t\t'cur_voted_id',\n\t\t'forum_id',\n\t\t'poll_info',\n\t\t's_can_vote',\n\t\t's_display_results',\n\t\t'topic_id',\n\t\t'topic_data',\n\t\t'viewtopic_url',\n\t\t'vote_counts',\n\t\t'voted_id',\n\t);\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_poll_data', compact($vars)));\n\n\tif ($update && $s_can_vote)\n\t{\n\n\t\tif (!sizeof($voted_id) || sizeof($voted_id) > $topic_data['poll_max_options'] || in_array(VOTE_CONVERTED, $cur_voted_id) || !check_form_key('posting'))\n\t\t{\n\t\t\t$redirect_url = append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id\" . (($start == 0) ? '' : \"&amp;start=$start\"));\n\n\t\t\tmeta_refresh(5, $redirect_url);\n\t\t\tif (!sizeof($voted_id))\n\t\t\t{\n\t\t\t\t$message = 'NO_VOTE_OPTION';\n\t\t\t}\n\t\t\telse if (sizeof($voted_id) > $topic_data['poll_max_options'])\n\t\t\t{\n\t\t\t\t$message = 'TOO_MANY_VOTE_OPTIONS';\n\t\t\t}\n\t\t\telse if (in_array(VOTE_CONVERTED, $cur_voted_id))\n\t\t\t{\n\t\t\t\t$message = 'VOTE_CONVERTED';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$message = 'FORM_INVALID';\n\t\t\t}\n\n\t\t\t$message = $user->lang[$message] . '<br /><br />' . sprintf($user->lang['RETURN_TOPIC'], '<a href=\"' . $redirect_url . '\">', '</a>');\n\t\t\ttrigger_error($message);\n\t\t}\n\n\t\tforeach ($voted_id as $option)\n\t\t{\n\t\t\tif (in_array($option, $cur_voted_id))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . '\n\t\t\t\tSET poll_option_total = poll_option_total + 1\n\t\t\t\tWHERE poll_option_id = ' . (int) $option . '\n\t\t\t\t\tAND topic_id = ' . (int) $topic_id;\n\t\t\t$db->sql_query($sql);\n\n\t\t\t$vote_counts[$option]++;\n\n\t\t\tif ($user->data['is_registered'])\n\t\t\t{\n\t\t\t\t$sql_ary = array(\n\t\t\t\t\t'topic_id'\t\t\t=> (int) $topic_id,\n\t\t\t\t\t'poll_option_id'\t=> (int) $option,\n\t\t\t\t\t'vote_user_id'\t\t=> (int) $user->data['user_id'],\n\t\t\t\t\t'vote_user_ip'\t\t=> (string) $user->ip,\n\t\t\t\t);\n\n\t\t\t\t$sql = 'INSERT INTO ' . POLL_VOTES_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);\n\t\t\t\t$db->sql_query($sql);\n\t\t\t}\n\t\t}\n\n\t\tforeach ($cur_voted_id as $option)\n\t\t{\n\t\t\tif (!in_array($option, $voted_id))\n\t\t\t{\n\t\t\t\t$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . '\n\t\t\t\t\tSET poll_option_total = poll_option_total - 1\n\t\t\t\t\tWHERE poll_option_id = ' . (int) $option . '\n\t\t\t\t\t\tAND topic_id = ' . (int) $topic_id;\n\t\t\t\t$db->sql_query($sql);\n\n\t\t\t\t$vote_counts[$option]--;\n\n\t\t\t\tif ($user->data['is_registered'])\n\t\t\t\t{\n\t\t\t\t\t$sql = 'DELETE FROM ' . POLL_VOTES_TABLE . '\n\t\t\t\t\t\tWHERE topic_id = ' . (int) $topic_id . '\n\t\t\t\t\t\t\tAND poll_option_id = ' . (int) $option . '\n\t\t\t\t\t\t\tAND vote_user_id = ' . (int) $user->data['user_id'];\n\t\t\t\t\t$db->sql_query($sql);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($user->data['user_id'] == ANONYMOUS && !$user->data['is_bot'])\n\t\t{\n\t\t\t$user->set_cookie('poll_' . $topic_id, implode(',', $voted_id), time() + 31536000);\n\t\t}\n\n\t\t$sql = 'UPDATE ' . TOPICS_TABLE . '\n\t\t\tSET poll_last_vote = ' . time() . \"\n\t\t\tWHERE topic_id = $topic_id\";\n\t\t//, topic_last_post_time = ' . time() . \" -- for bumping topics with new votes, ignore for now\n\t\t$db->sql_query($sql);\n\n\t\t$redirect_url = append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id\" . (($start == 0) ? '' : \"&amp;start=$start\"));\n\t\t$message = $user->lang['VOTE_SUBMITTED'] . '<br /><br />' . sprintf($user->lang['RETURN_TOPIC'], '<a href=\"' . $redirect_url . '\">', '</a>');\n\n\t\tif ($request->is_ajax())\n\t\t{\n\t\t\t// Filter out invalid options\n\t\t\t$valid_user_votes = array_intersect(array_keys($vote_counts), $voted_id);\n\n\t\t\t$data = array(\n\t\t\t\t'NO_VOTES'\t\t\t=> $user->lang['NO_VOTES'],\n\t\t\t\t'success'\t\t\t=> true,\n\t\t\t\t'user_votes'\t\t=> array_flip($valid_user_votes),\n\t\t\t\t'vote_counts'\t\t=> $vote_counts,\n\t\t\t\t'total_votes'\t\t=> array_sum($vote_counts),\n\t\t\t\t'can_vote'\t\t\t=> !sizeof($valid_user_votes) || ($auth->acl_get('f_votechg', $forum_id) && $topic_data['poll_vote_change']),\n\t\t\t);\n\t\t\t$json_response = new \\phpbb\\json_response();\n\t\t\t$json_response->send($data);\n\t\t}\n\n\t\tmeta_refresh(5, $redirect_url);\n\t\ttrigger_error($message);\n\t}\n\n\t$poll_total = 0;\n\t$poll_most = 0;\n\tforeach ($poll_info as $poll_option)\n\t{\n\t\t$poll_total += $poll_option['poll_option_total'];\n\t\t$poll_most = ($poll_option['poll_option_total'] >= $poll_most) ? $poll_option['poll_option_total'] : $poll_most;\n\t}\n\n\t$parse_flags = ($poll_info[0]['bbcode_bitfield'] ? OPTION_FLAG_BBCODE : 0) | OPTION_FLAG_SMILIES;\n\n\tfor ($i = 0, $size = sizeof($poll_info); $i < $size; $i++)\n\t{\n\t\t$poll_info[$i]['poll_option_text'] = generate_text_for_display($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield'], $parse_flags, true);\n\t}\n\n\t$topic_data['poll_title'] = generate_text_for_display($topic_data['poll_title'], $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield'], $parse_flags, true);\n\n\t$poll_template_data = $poll_options_template_data = array();\n\tforeach ($poll_info as $poll_option)\n\t{\n\t\t$option_pct = ($poll_total > 0) ? $poll_option['poll_option_total'] / $poll_total : 0;\n\t\t$option_pct_txt = sprintf(\"%.1d%%\", round($option_pct * 100));\n\t\t$option_pct_rel = ($poll_most > 0) ? $poll_option['poll_option_total'] / $poll_most : 0;\n\t\t$option_pct_rel_txt = sprintf(\"%.1d%%\", round($option_pct_rel * 100));\n\t\t$option_most_votes = ($poll_option['poll_option_total'] > 0 && $poll_option['poll_option_total'] == $poll_most) ? true : false;\n\n\t\t$poll_options_template_data[] = array(\n\t\t\t'POLL_OPTION_ID' \t\t\t=> $poll_option['poll_option_id'],\n\t\t\t'POLL_OPTION_CAPTION' \t\t=> $poll_option['poll_option_text'],\n\t\t\t'POLL_OPTION_RESULT' \t\t=> $poll_option['poll_option_total'],\n\t\t\t'POLL_OPTION_PERCENT' \t\t=> $option_pct_txt,\n\t\t\t'POLL_OPTION_PERCENT_REL' \t=> $option_pct_rel_txt,\n\t\t\t'POLL_OPTION_PCT'\t\t\t=> round($option_pct * 100),\n\t\t\t'POLL_OPTION_WIDTH'     \t=> round($option_pct * 250),\n\t\t\t'POLL_OPTION_VOTED'\t\t\t=> (in_array($poll_option['poll_option_id'], $cur_voted_id)) ? true : false,\n\t\t\t'POLL_OPTION_MOST_VOTES'\t=> $option_most_votes,\n\t\t);\n\t}\n\n\t$poll_end = $topic_data['poll_length'] + $topic_data['poll_start'];\n\n\t$poll_template_data = array(\n\t\t'POLL_QUESTION'\t\t=> $topic_data['poll_title'],\n\t\t'TOTAL_VOTES' \t\t=> $poll_total,\n\t\t'POLL_LEFT_CAP_IMG'\t=> $user->img('poll_left'),\n\t\t'POLL_RIGHT_CAP_IMG'=> $user->img('poll_right'),\n\n\t\t'L_MAX_VOTES'\t\t=> $user->lang('MAX_OPTIONS_SELECT', (int) $topic_data['poll_max_options']),\n\t\t'L_POLL_LENGTH'\t\t=> ($topic_data['poll_length']) ? sprintf($user->lang[($poll_end > time()) ? 'POLL_RUN_TILL' : 'POLL_ENDED_AT'], $user->format_date($poll_end)) : '',\n\n\t\t'S_HAS_POLL'\t\t=> true,\n\t\t'S_CAN_VOTE'\t\t=> $s_can_vote,\n\t\t'S_DISPLAY_RESULTS'\t=> $s_display_results,\n\t\t'S_IS_MULTI_CHOICE'\t=> ($topic_data['poll_max_options'] > 1) ? true : false,\n\t\t'S_POLL_ACTION'\t\t=> $viewtopic_url,\n\n\t\t'U_VIEW_RESULTS'\t=> $viewtopic_url . '&amp;view=viewpoll',\n\t);\n\n\t/**\n\t* Event to add/modify poll template data\n\t*\n\t* @event core.viewtopic_modify_poll_template_data\n\t* @var\tarray\tcur_voted_id\t\t\t\t\tArray with options' IDs current user has voted for\n\t* @var\tint\t\tpoll_end\t\t\t\t\t\tThe poll end time\n\t* @var\tarray\tpoll_info\t\t\t\t\t\tArray with the poll information\n\t* @var\tarray\tpoll_options_template_data\t\tArray with the poll options template data\n\t* @var\tarray\tpoll_template_data\t\t\t\tArray with the common poll template data\n\t* @var\tint\t\tpoll_total\t\t\t\t\t\tTotal poll votes count\n\t* @var\tint\t\tpoll_most\t\t\t\t\t\tMostly voted option votes count\n\t* @var\tarray\ttopic_data\t\t\t\t\t\tAll the information from the topic and forum tables for this topic\n\t* @var\tstring\tviewtopic_url\t\t\t\t\tURL to the topic page\n\t* @var\tarray\tvote_counts\t\t\t\t\t\tArray with the vote counts for every poll option\n\t* @var\tarray\tvoted_id\t\t\t\t\t\tArray with updated options' IDs current user is voting for\n\t* @since 3.1.5-RC1\n\t*/\n\t$vars = array(\n\t\t'cur_voted_id',\n\t\t'poll_end',\n\t\t'poll_info',\n\t\t'poll_options_template_data',\n\t\t'poll_template_data',\n\t\t'poll_total',\n\t\t'poll_most',\n\t\t'topic_data',\n\t\t'viewtopic_url',\n\t\t'vote_counts',\n\t\t'voted_id',\n\t);\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_poll_template_data', compact($vars)));\n\n\t$template->assign_block_vars_array('poll_option', $poll_options_template_data);\n\n\t$template->assign_vars($poll_template_data);\n\n\tunset($poll_end, $poll_info, $poll_options_template_data, $poll_template_data, $voted_id);\n}\n\n// If the user is trying to reach the second half of the topic, fetch it starting from the end\n$store_reverse = false;\n$sql_limit = $config['posts_per_page'];\n$sql_sort_order = $direction = '';\n\nif ($start > $total_posts / 2)\n{\n\t$store_reverse = true;\n\n\t// Select the sort order\n\t$direction = (($sort_dir == 'd') ? 'ASC' : 'DESC');\n\n\t$sql_limit = $pagination->reverse_limit($start, $sql_limit, $total_posts);\n\t$sql_start = $pagination->reverse_start($start, $sql_limit, $total_posts);\n}\nelse\n{\n\t// Select the sort order\n\t$direction = (($sort_dir == 'd') ? 'DESC' : 'ASC');\n\t$sql_start = $start;\n}\n\nif (is_array($sort_by_sql[$sort_key]))\n{\n\t$sql_sort_order = implode(' ' . $direction . ', ', $sort_by_sql[$sort_key]) . ' ' . $direction;\n}\nelse\n{\n\t$sql_sort_order = $sort_by_sql[$sort_key] . ' ' . $direction;\n}\n\n// Container for user details, only process once\n$post_list = $user_cache = $id_cache = $attachments = $attach_list = $rowset = $update_count = $post_edit_list = $post_delete_list = array();\n$has_unapproved_attachments = $has_approved_attachments = $display_notice = false;\n$i = $i_total = 0;\n\n// Go ahead and pull all data for this topic\n$sql = 'SELECT p.post_id\n\tFROM ' . POSTS_TABLE . ' p' . (($join_user_sql[$sort_key]) ? ', ' . USERS_TABLE . ' u': '') . \"\n\tWHERE p.topic_id = $topic_id\n\t\tAND \" . $phpbb_content_visibility->get_visibility_sql('post', $forum_id, 'p.') . \"\n\t\t\" . (($join_user_sql[$sort_key]) ? 'AND u.user_id = p.poster_id': '') . \"\n\t\t$limit_posts_time\n\tORDER BY $sql_sort_order\";\n$result = $db->sql_query_limit($sql, $sql_limit, $sql_start);\n\n$i = ($store_reverse) ? $sql_limit - 1 : 0;\nwhile ($row = $db->sql_fetchrow($result))\n{\n\t$post_list[$i] = (int) $row['post_id'];\n\t($store_reverse) ? $i-- : $i++;\n}\n$db->sql_freeresult($result);\n\nif (!sizeof($post_list))\n{\n\tif ($sort_days)\n\t{\n\t\ttrigger_error('NO_POSTS_TIME_FRAME');\n\t}\n\telse\n\t{\n\t\ttrigger_error('NO_TOPIC');\n\t}\n}\n\n// Holding maximum post time for marking topic read\n// We need to grab it because we do reverse ordering sometimes\n$max_post_time = 0;\n\n$sql_ary = array(\n\t'SELECT'\t=> 'u.*, z.friend, z.foe, p.*',\n\n\t'FROM'\t\t=> array(\n\t\tUSERS_TABLE\t\t=> 'u',\n\t\tPOSTS_TABLE\t\t=> 'p',\n\t),\n\n\t'LEFT_JOIN'\t=> array(\n\t\tarray(\n\t\t\t'FROM'\t=> array(ZEBRA_TABLE => 'z'),\n\t\t\t'ON'\t=> 'z.user_id = ' . $user->data['user_id'] . ' AND z.zebra_id = p.poster_id',\n\t\t),\n\t),\n\n\t'WHERE'\t\t=> $db->sql_in_set('p.post_id', $post_list) . '\n\t\tAND u.user_id = p.poster_id',\n);\n\n/**\n* Event to modify the SQL query before the post and poster data is retrieved\n*\n* @event core.viewtopic_get_post_data\n* @var\tint\t\tforum_id\tForum ID\n* @var\tint\t\ttopic_id\tTopic ID\n* @var\tarray\ttopic_data\tArray with topic data\n* @var\tarray\tpost_list\tArray with post_ids we are going to retrieve\n* @var\tint\t\tsort_days\tDisplay posts of previous x days\n* @var\tstring\tsort_key\tKey the posts are sorted by\n* @var\tstring\tsort_dir\tDirection the posts are sorted by\n* @var\tint\t\tstart\t\tPagination information\n* @var\tarray\tsql_ary\t\tThe SQL array to get the data of posts and posters\n* @since 3.1.0-a1\n* @changed 3.1.0-a2 Added vars forum_id, topic_id, topic_data, post_list, sort_days, sort_key, sort_dir, start\n*/\n$vars = array(\n\t'forum_id',\n\t'topic_id',\n\t'topic_data',\n\t'post_list',\n\t'sort_days',\n\t'sort_key',\n\t'sort_dir',\n\t'start',\n\t'sql_ary',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_get_post_data', compact($vars)));\n\n$sql = $db->sql_build_query('SELECT', $sql_ary);\n$result = $db->sql_query($sql);\n\n$now = $user->create_datetime();\n$now = phpbb_gmgetdate($now->getTimestamp() + $now->getOffset());\n\n// Posts are stored in the $rowset array while $attach_list, $user_cache\n// and the global bbcode_bitfield are built\nwhile ($row = $db->sql_fetchrow($result))\n{\n\t// Set max_post_time\n\tif ($row['post_time'] > $max_post_time)\n\t{\n\t\t$max_post_time = $row['post_time'];\n\t}\n\n\t$poster_id = (int) $row['poster_id'];\n\n\t// Does post have an attachment? If so, add it to the list\n\tif ($row['post_attachment'] && $config['allow_attachments'])\n\t{\n\t\t$attach_list[] = (int) $row['post_id'];\n\n\t\tif ($row['post_visibility'] == ITEM_UNAPPROVED || $row['post_visibility'] == ITEM_REAPPROVE)\n\t\t{\n\t\t\t$has_unapproved_attachments = true;\n\t\t}\n\t\telse if ($row['post_visibility'] == ITEM_APPROVED)\n\t\t{\n\t\t\t$has_approved_attachments = true;\n\t\t}\n\t}\n\n\t$rowset_data = array(\n\t\t'hide_post'\t\t\t=> (($row['foe'] || $row['post_visibility'] == ITEM_DELETED) && ($view != 'show' || $post_id != $row['post_id'])) ? true : false,\n\n\t\t'post_id'\t\t\t=> $row['post_id'],\n\t\t'post_time'\t\t\t=> $row['post_time'],\n\t\t'user_id'\t\t\t=> $row['user_id'],\n\t\t'username'\t\t\t=> $row['username'],\n\t\t'user_colour'\t\t=> $row['user_colour'],\n\t\t'topic_id'\t\t\t=> $row['topic_id'],\n\t\t'forum_id'\t\t\t=> $row['forum_id'],\n\t\t'post_subject'\t\t=> $row['post_subject'],\n\t\t'post_edit_count'\t=> $row['post_edit_count'],\n\t\t'post_edit_time'\t=> $row['post_edit_time'],\n\t\t'post_edit_reason'\t=> $row['post_edit_reason'],\n\t\t'post_edit_user'\t=> $row['post_edit_user'],\n\t\t'post_edit_locked'\t=> $row['post_edit_locked'],\n\t\t'post_delete_time'\t=> $row['post_delete_time'],\n\t\t'post_delete_reason'=> $row['post_delete_reason'],\n\t\t'post_delete_user'\t=> $row['post_delete_user'],\n\n\t\t// Make sure the icon actually exists\n\t\t'icon_id'\t\t\t=> (isset($icons[$row['icon_id']]['img'], $icons[$row['icon_id']]['height'], $icons[$row['icon_id']]['width'])) ? $row['icon_id'] : 0,\n\t\t'post_attachment'\t=> $row['post_attachment'],\n\t\t'post_visibility'\t=> $row['post_visibility'],\n\t\t'post_reported'\t\t=> $row['post_reported'],\n\t\t'post_username'\t\t=> $row['post_username'],\n\t\t'post_text'\t\t\t=> $row['post_text'],\n\t\t'bbcode_uid'\t\t=> $row['bbcode_uid'],\n\t\t'bbcode_bitfield'\t=> $row['bbcode_bitfield'],\n\t\t'enable_smilies'\t=> $row['enable_smilies'],\n\t\t'enable_sig'\t\t=> $row['enable_sig'],\n\t\t'friend'\t\t\t=> $row['friend'],\n\t\t'foe'\t\t\t\t=> $row['foe'],\n\t);\n\n\t/**\n\t* Modify the post rowset containing data to be displayed with posts\n\t*\n\t* @event core.viewtopic_post_rowset_data\n\t* @var\tarray\trowset_data\tArray with the rowset data for this post\n\t* @var\tarray\trow\t\t\tArray with original user and post data\n\t* @since 3.1.0-a1\n\t*/\n\t$vars = array('rowset_data', 'row');\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_post_rowset_data', compact($vars)));\n\n\t$rowset[$row['post_id']] = $rowset_data;\n\n\t// Cache various user specific data ... so we don't have to recompute\n\t// this each time the same user appears on this page\n\tif (!isset($user_cache[$poster_id]))\n\t{\n\t\tif ($poster_id == ANONYMOUS)\n\t\t{\n\t\t\t$user_cache_data = array(\n\t\t\t\t'user_type'\t\t=> USER_IGNORE,\n\t\t\t\t'joined'\t\t=> '',\n\t\t\t\t'posts'\t\t\t=> '',\n\n\t\t\t\t'sig'\t\t\t\t\t=> '',\n\t\t\t\t'sig_bbcode_uid'\t\t=> '',\n\t\t\t\t'sig_bbcode_bitfield'\t=> '',\n\n\t\t\t\t'online'\t\t\t=> false,\n\t\t\t\t'avatar'\t\t\t=> ($user->optionget('viewavatars')) ? phpbb_get_user_avatar($row) : '',\n\t\t\t\t'rank_title'\t\t=> '',\n\t\t\t\t'rank_image'\t\t=> '',\n\t\t\t\t'rank_image_src'\t=> '',\n\t\t\t\t'pm'\t\t\t\t=> '',\n\t\t\t\t'email'\t\t\t\t=> '',\n\t\t\t\t'jabber'\t\t\t=> '',\n\t\t\t\t'search'\t\t\t=> '',\n\t\t\t\t'age'\t\t\t\t=> '',\n\n\t\t\t\t'username'\t\t\t=> $row['username'],\n\t\t\t\t'user_colour'\t\t=> $row['user_colour'],\n\t\t\t\t'contact_user'\t\t=> '',\n\n\t\t\t\t'warnings'\t\t\t=> 0,\n\t\t\t\t'allow_pm'\t\t\t=> 0,\n\t\t\t);\n\n\t\t\t/**\n\t\t\t* Modify the guest user's data displayed with the posts\n\t\t\t*\n\t\t\t* @event core.viewtopic_cache_guest_data\n\t\t\t* @var\tarray\tuser_cache_data\tArray with the user's data\n\t\t\t* @var\tint\t\tposter_id\t\tPoster's user id\n\t\t\t* @var\tarray\trow\t\t\t\tArray with original user and post data\n\t\t\t* @since 3.1.0-a1\n\t\t\t*/\n\t\t\t$vars = array('user_cache_data', 'poster_id', 'row');\n\t\t\textract($phpbb_dispatcher->trigger_event('core.viewtopic_cache_guest_data', compact($vars)));\n\n\t\t\t$user_cache[$poster_id] = $user_cache_data;\n\n\t\t\t$user_rank_data = phpbb_get_user_rank($row, false);\n\t\t\t$user_cache[$poster_id]['rank_title'] = $user_rank_data['title'];\n\t\t\t$user_cache[$poster_id]['rank_image'] = $user_rank_data['img'];\n\t\t\t$user_cache[$poster_id]['rank_image_src'] = $user_rank_data['img_src'];\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$user_sig = '';\n\n\t\t\t// We add the signature to every posters entry because enable_sig is post dependent\n\t\t\tif ($row['user_sig'] && $config['allow_sig'] && $user->optionget('viewsigs'))\n\t\t\t{\n\t\t\t\t$user_sig = $row['user_sig'];\n\t\t\t}\n\n\t\t\t$id_cache[] = $poster_id;\n\n\t\t\t$user_cache_data = array(\n\t\t\t\t'user_type'\t\t\t\t\t=> $row['user_type'],\n\t\t\t\t'user_inactive_reason'\t\t=> $row['user_inactive_reason'],\n\n\t\t\t\t'joined'\t\t=> $user->format_date($row['user_regdate']),\n\t\t\t\t'posts'\t\t\t=> $row['user_posts'],\n\t\t\t\t'warnings'\t\t=> (isset($row['user_warnings'])) ? $row['user_warnings'] : 0,\n\n\t\t\t\t'sig'\t\t\t\t\t=> $user_sig,\n\t\t\t\t'sig_bbcode_uid'\t\t=> (!empty($row['user_sig_bbcode_uid'])) ? $row['user_sig_bbcode_uid'] : '',\n\t\t\t\t'sig_bbcode_bitfield'\t=> (!empty($row['user_sig_bbcode_bitfield'])) ? $row['user_sig_bbcode_bitfield'] : '',\n\n\t\t\t\t'viewonline'\t=> $row['user_allow_viewonline'],\n\t\t\t\t'allow_pm'\t\t=> $row['user_allow_pm'],\n\n\t\t\t\t'avatar'\t\t=> ($user->optionget('viewavatars')) ? phpbb_get_user_avatar($row) : '',\n\t\t\t\t'age'\t\t\t=> '',\n\n\t\t\t\t'rank_title'\t\t=> '',\n\t\t\t\t'rank_image'\t\t=> '',\n\t\t\t\t'rank_image_src'\t=> '',\n\n\t\t\t\t'username'\t\t\t=> $row['username'],\n\t\t\t\t'user_colour'\t\t=> $row['user_colour'],\n\t\t\t\t'contact_user' \t\t=> $user->lang('CONTACT_USER', get_username_string('username', $poster_id, $row['username'], $row['user_colour'], $row['username'])),\n\n\t\t\t\t'online'\t\t=> false,\n\t\t\t\t'jabber'\t\t=> ($config['jab_enable'] && $row['user_jabber'] && $auth->acl_get('u_sendim')) ? append_sid(\"{$phpbb_root_path}memberlist.$phpEx\", \"mode=contact&amp;action=jabber&amp;u=$poster_id\") : '',\n\t\t\t\t'search'\t\t=> ($config['load_search'] && $auth->acl_get('u_search')) ? append_sid(\"{$phpbb_root_path}search.$phpEx\", \"author_id=$poster_id&amp;sr=posts\") : '',\n\n\t\t\t\t'author_full'\t\t=> get_username_string('full', $poster_id, $row['username'], $row['user_colour']),\n\t\t\t\t'author_colour'\t\t=> get_username_string('colour', $poster_id, $row['username'], $row['user_colour']),\n\t\t\t\t'author_username'\t=> get_username_string('username', $poster_id, $row['username'], $row['user_colour']),\n\t\t\t\t'author_profile'\t=> get_username_string('profile', $poster_id, $row['username'], $row['user_colour']),\n\t\t\t);\n\n\t\t\t/**\n\t\t\t* Modify the users' data displayed with their posts\n\t\t\t*\n\t\t\t* @event core.viewtopic_cache_user_data\n\t\t\t* @var\tarray\tuser_cache_data\tArray with the user's data\n\t\t\t* @var\tint\t\tposter_id\t\tPoster's user id\n\t\t\t* @var\tarray\trow\t\t\t\tArray with original user and post data\n\t\t\t* @since 3.1.0-a1\n\t\t\t*/\n\t\t\t$vars = array('user_cache_data', 'poster_id', 'row');\n\t\t\textract($phpbb_dispatcher->trigger_event('core.viewtopic_cache_user_data', compact($vars)));\n\n\t\t\t$user_cache[$poster_id] = $user_cache_data;\n\n\t\t\t$user_rank_data = phpbb_get_user_rank($row, $row['user_posts']);\n\t\t\t$user_cache[$poster_id]['rank_title'] = $user_rank_data['title'];\n\t\t\t$user_cache[$poster_id]['rank_image'] = $user_rank_data['img'];\n\t\t\t$user_cache[$poster_id]['rank_image_src'] = $user_rank_data['img_src'];\n\n\t\t\tif ((!empty($row['user_allow_viewemail']) && $auth->acl_get('u_sendemail')) || $auth->acl_get('a_email'))\n\t\t\t{\n\t\t\t\t$user_cache[$poster_id]['email'] = ($config['board_email_form'] && $config['email_enable']) ? append_sid(\"{$phpbb_root_path}memberlist.$phpEx\", \"mode=email&amp;u=$poster_id\") : (($config['board_hide_emails'] && !$auth->acl_get('a_email')) ? '' : 'mailto:' . $row['user_email']);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$user_cache[$poster_id]['email'] = '';\n\t\t\t}\n\n\t\t\tif ($config['allow_birthdays'] && !empty($row['user_birthday']))\n\t\t\t{\n\t\t\t\tlist($bday_day, $bday_month, $bday_year) = array_map('intval', explode('-', $row['user_birthday']));\n\n\t\t\t\tif ($bday_year)\n\t\t\t\t{\n\t\t\t\t\t$diff = $now['mon'] - $bday_month;\n\t\t\t\t\tif ($diff == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$diff = ($now['mday'] - $bday_day < 0) ? 1 : 0;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$diff = ($diff < 0) ? 1 : 0;\n\t\t\t\t\t}\n\n\t\t\t\t\t$user_cache[$poster_id]['age'] = (int) ($now['year'] - $bday_year - $diff);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n$db->sql_freeresult($result);\n\n// Load custom profile fields\nif ($config['load_cpf_viewtopic'])\n{\n\t/* @var $cp \\phpbb\\profilefields\\manager */\n\t$cp = $phpbb_container->get('profilefields.manager');\n\n\t// Grab all profile fields from users in id cache for later use - similar to the poster cache\n\t$profile_fields_tmp = $cp->grab_profile_fields_data($id_cache);\n\n\t// filter out fields not to be displayed on viewtopic. Yes, it's a hack, but this shouldn't break any MODs.\n\t$profile_fields_cache = array();\n\tforeach ($profile_fields_tmp as $profile_user_id => $profile_fields)\n\t{\n\t\t$profile_fields_cache[$profile_user_id] = array();\n\t\tforeach ($profile_fields as $used_ident => $profile_field)\n\t\t{\n\t\t\tif ($profile_field['data']['field_show_on_vt'])\n\t\t\t{\n\t\t\t\t$profile_fields_cache[$profile_user_id][$used_ident] = $profile_field;\n\t\t\t}\n\t\t}\n\t}\n\tunset($profile_fields_tmp);\n}\n\n// Generate online information for user\nif ($config['load_onlinetrack'] && sizeof($id_cache))\n{\n\t$sql = 'SELECT session_user_id, MAX(session_time) as online_time, MIN(session_viewonline) AS viewonline\n\t\tFROM ' . SESSIONS_TABLE . '\n\t\tWHERE ' . $db->sql_in_set('session_user_id', $id_cache) . '\n\t\tGROUP BY session_user_id';\n\t$result = $db->sql_query($sql);\n\n\t$update_time = $config['load_online_time'] * 60;\n\twhile ($row = $db->sql_fetchrow($result))\n\t{\n\t\t$user_cache[$row['session_user_id']]['online'] = (time() - $update_time < $row['online_time'] && (($row['viewonline']) || $auth->acl_get('u_viewonline'))) ? true : false;\n\t}\n\t$db->sql_freeresult($result);\n}\nunset($id_cache);\n\n// Pull attachment data\nif (sizeof($attach_list))\n{\n\tif ($auth->acl_get('u_download') && $auth->acl_get('f_download', $forum_id))\n\t{\n\t\t$sql = 'SELECT *\n\t\t\tFROM ' . ATTACHMENTS_TABLE . '\n\t\t\tWHERE ' . $db->sql_in_set('post_msg_id', $attach_list) . '\n\t\t\t\tAND in_message = 0\n\t\t\tORDER BY attach_id DESC, post_msg_id ASC';\n\t\t$result = $db->sql_query($sql);\n\n\t\twhile ($row = $db->sql_fetchrow($result))\n\t\t{\n\t\t\t$attachments[$row['post_msg_id']][] = $row;\n\t\t}\n\t\t$db->sql_freeresult($result);\n\n\t\t// No attachments exist, but post table thinks they do so go ahead and reset post_attach flags\n\t\tif (!sizeof($attachments))\n\t\t{\n\t\t\t$sql = 'UPDATE ' . POSTS_TABLE . '\n\t\t\t\tSET post_attachment = 0\n\t\t\t\tWHERE ' . $db->sql_in_set('post_id', $attach_list);\n\t\t\t$db->sql_query($sql);\n\n\t\t\t// We need to update the topic indicator too if the complete topic is now without an attachment\n\t\t\tif (sizeof($rowset) != $total_posts)\n\t\t\t{\n\t\t\t\t// Not all posts are displayed so we query the db to find if there's any attachment for this topic\n\t\t\t\t$sql = 'SELECT a.post_msg_id as post_id\n\t\t\t\t\tFROM ' . ATTACHMENTS_TABLE . ' a, ' . POSTS_TABLE . \" p\n\t\t\t\t\tWHERE p.topic_id = $topic_id\n\t\t\t\t\t\tAND p.post_visibility = \" . ITEM_APPROVED . '\n\t\t\t\t\t\tAND p.topic_id = a.topic_id';\n\t\t\t\t$result = $db->sql_query_limit($sql, 1);\n\t\t\t\t$row = $db->sql_fetchrow($result);\n\t\t\t\t$db->sql_freeresult($result);\n\n\t\t\t\tif (!$row)\n\t\t\t\t{\n\t\t\t\t\t$sql = 'UPDATE ' . TOPICS_TABLE . \"\n\t\t\t\t\t\tSET topic_attachment = 0\n\t\t\t\t\t\tWHERE topic_id = $topic_id\";\n\t\t\t\t\t$db->sql_query($sql);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$sql = 'UPDATE ' . TOPICS_TABLE . \"\n\t\t\t\t\tSET topic_attachment = 0\n\t\t\t\t\tWHERE topic_id = $topic_id\";\n\t\t\t\t$db->sql_query($sql);\n\t\t\t}\n\t\t}\n\t\telse if ($has_approved_attachments && !$topic_data['topic_attachment'])\n\t\t{\n\t\t\t// Topic has approved attachments but its flag is wrong\n\t\t\t$sql = 'UPDATE ' . TOPICS_TABLE . \"\n\t\t\t\tSET topic_attachment = 1\n\t\t\t\tWHERE topic_id = $topic_id\";\n\t\t\t$db->sql_query($sql);\n\n\t\t\t$topic_data['topic_attachment'] = 1;\n\t\t}\n\t\telse if ($has_unapproved_attachments && !$topic_data['topic_attachment'])\n\t\t{\n\t\t\t// Topic has only unapproved attachments but we have the right to see and download them\n\t\t\t$topic_data['topic_attachment'] = 1;\n\t\t}\n\t}\n\telse\n\t{\n\t\t$display_notice = true;\n\t}\n}\n\n// Get the list of users who can receive private messages\n$can_receive_pm_list = $auth->acl_get_list(array_keys($user_cache), 'u_readpm');\n$can_receive_pm_list = (empty($can_receive_pm_list) || !isset($can_receive_pm_list[0]['u_readpm'])) ? array() : $can_receive_pm_list[0]['u_readpm'];\n\n// Get the list of permanently banned users\n$permanently_banned_users = phpbb_get_banned_user_ids(array_keys($user_cache), false);\n\n$i_total = sizeof($rowset) - 1;\n$prev_post_id = '';\n\n$template->assign_vars(array(\n\t'S_HAS_ATTACHMENTS' => $topic_data['topic_attachment'],\n\t'S_NUM_POSTS' => sizeof($post_list))\n);\n\n/**\n* Event to modify the post, poster and attachment data before assigning the posts\n*\n* @event core.viewtopic_modify_post_data\n* @var\tint\t\tforum_id\tForum ID\n* @var\tint\t\ttopic_id\tTopic ID\n* @var\tarray\ttopic_data\tArray with topic data\n* @var\tarray\tpost_list\tArray with post_ids we are going to display\n* @var\tarray\trowset\t\tArray with post_id => post data\n* @var\tarray\tuser_cache\tArray with prepared user data\n* @var\tint\t\tstart\t\tPagination information\n* @var\tint\t\tsort_days\tDisplay posts of previous x days\n* @var\tstring\tsort_key\tKey the posts are sorted by\n* @var\tstring\tsort_dir\tDirection the posts are sorted by\n* @var\tbool\tdisplay_notice\t\t\t\tShall we display a notice instead of attachments\n* @var\tbool\thas_approved_attachments\tDoes the topic have approved attachments\n* @var\tarray\tattachments\t\t\t\t\tList of attachments post_id => array of attachments\n* @var\tarray\tpermanently_banned_users\tList of permanently banned users\n* @var\tarray\tcan_receive_pm_list\t\t\tArray with posters that can receive pms\n* @since 3.1.0-RC3\n*/\n$vars = array(\n\t'forum_id',\n\t'topic_id',\n\t'topic_data',\n\t'post_list',\n\t'rowset',\n\t'user_cache',\n\t'sort_days',\n\t'sort_key',\n\t'sort_dir',\n\t'start',\n\t'permanently_banned_users',\n\t'can_receive_pm_list',\n\t'display_notice',\n\t'has_approved_attachments',\n\t'attachments',\n);\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_post_data', compact($vars)));\n\n// Output the posts\n$first_unread = $post_unread = false;\nfor ($i = 0, $end = sizeof($post_list); $i < $end; ++$i)\n{\n\t// A non-existing rowset only happens if there was no user present for the entered poster_id\n\t// This could be a broken posts table.\n\tif (!isset($rowset[$post_list[$i]]))\n\t{\n\t\tcontinue;\n\t}\n\n\t$row = $rowset[$post_list[$i]];\n\t$poster_id = $row['user_id'];\n\n\t// End signature parsing, only if needed\n\tif ($user_cache[$poster_id]['sig'] && $row['enable_sig'] && empty($user_cache[$poster_id]['sig_parsed']))\n\t{\n\t\t$parse_flags = ($user_cache[$poster_id]['sig_bbcode_bitfield'] ? OPTION_FLAG_BBCODE : 0) | OPTION_FLAG_SMILIES;\n\t\t$user_cache[$poster_id]['sig'] = generate_text_for_display($user_cache[$poster_id]['sig'], $user_cache[$poster_id]['sig_bbcode_uid'], $user_cache[$poster_id]['sig_bbcode_bitfield'],  $parse_flags, true);\n\t\t$user_cache[$poster_id]['sig_parsed'] = true;\n\t}\n\n\t// Parse the message and subject\n\t$parse_flags = ($row['bbcode_bitfield'] ? OPTION_FLAG_BBCODE : 0) | OPTION_FLAG_SMILIES;\n\t$message = generate_text_for_display($row['post_text'], $row['bbcode_uid'], $row['bbcode_bitfield'], $parse_flags, true);\n\n\tif (!empty($attachments[$row['post_id']]))\n\t{\n\t\tparse_attachments($forum_id, $message, $attachments[$row['post_id']], $update_count);\n\t}\n\n\t// Replace naughty words such as farty pants\n\t$row['post_subject'] = censor_text($row['post_subject']);\n\n\t// Highlight active words (primarily for search)\n\tif ($highlight_match)\n\t{\n\t\t$message = preg_replace('#(?!<.*)(?<!\\w)(' . $highlight_match . ')(?!\\w|[^<>]*(?:</s(?:cript|tyle))?>)#is', '<span class=\"posthilit\">\\1</span>', $message);\n\t\t$row['post_subject'] = preg_replace('#(?!<.*)(?<!\\w)(' . $highlight_match . ')(?!\\w|[^<>]*(?:</s(?:cript|tyle))?>)#is', '<span class=\"posthilit\">\\1</span>', $row['post_subject']);\n\t}\n\n\t// Editing information\n\tif (($row['post_edit_count'] && $config['display_last_edited']) || $row['post_edit_reason'])\n\t{\n\t\t// Get usernames for all following posts if not already stored\n\t\tif (!sizeof($post_edit_list) && ($row['post_edit_reason'] || ($row['post_edit_user'] && !isset($user_cache[$row['post_edit_user']]))))\n\t\t{\n\t\t\t// Remove all post_ids already parsed (we do not have to check them)\n\t\t\t$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);\n\n\t\t\t$sql = 'SELECT DISTINCT u.user_id, u.username, u.user_colour\n\t\t\t\tFROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u\n\t\t\t\tWHERE ' . $db->sql_in_set('p.post_id', $post_storage_list) . '\n\t\t\t\t\tAND p.post_edit_count <> 0\n\t\t\t\t\tAND p.post_edit_user <> 0\n\t\t\t\t\tAND p.post_edit_user = u.user_id';\n\t\t\t$result2 = $db->sql_query($sql);\n\t\t\twhile ($user_edit_row = $db->sql_fetchrow($result2))\n\t\t\t{\n\t\t\t\t$post_edit_list[$user_edit_row['user_id']] = $user_edit_row;\n\t\t\t}\n\t\t\t$db->sql_freeresult($result2);\n\n\t\t\tunset($post_storage_list);\n\t\t}\n\n\t\tif ($row['post_edit_reason'])\n\t\t{\n\t\t\t// User having edited the post also being the post author?\n\t\t\tif (!$row['post_edit_user'] || $row['post_edit_user'] == $poster_id)\n\t\t\t{\n\t\t\t\t$display_username = get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$display_username = get_username_string('full', $row['post_edit_user'], $post_edit_list[$row['post_edit_user']]['username'], $post_edit_list[$row['post_edit_user']]['user_colour']);\n\t\t\t}\n\n\t\t\t$l_edited_by = $user->lang('EDITED_TIMES_TOTAL', (int) $row['post_edit_count'], $display_username, $user->format_date($row['post_edit_time'], false, true));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif ($row['post_edit_user'] && !isset($user_cache[$row['post_edit_user']]))\n\t\t\t{\n\t\t\t\t$user_cache[$row['post_edit_user']] = $post_edit_list[$row['post_edit_user']];\n\t\t\t}\n\n\t\t\t// User having edited the post also being the post author?\n\t\t\tif (!$row['post_edit_user'] || $row['post_edit_user'] == $poster_id)\n\t\t\t{\n\t\t\t\t$display_username = get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$display_username = get_username_string('full', $row['post_edit_user'], $user_cache[$row['post_edit_user']]['username'], $user_cache[$row['post_edit_user']]['user_colour']);\n\t\t\t}\n\n\t\t\t$l_edited_by = $user->lang('EDITED_TIMES_TOTAL', (int) $row['post_edit_count'], $display_username, $user->format_date($row['post_edit_time'], false, true));\n\t\t}\n\t}\n\telse\n\t{\n\t\t$l_edited_by = '';\n\t}\n\n\t// Deleting information\n\tif ($row['post_visibility'] == ITEM_DELETED && $row['post_delete_user'])\n\t{\n\t\t// Get usernames for all following posts if not already stored\n\t\tif (!sizeof($post_delete_list) && ($row['post_delete_reason'] || ($row['post_delete_user'] && !isset($user_cache[$row['post_delete_user']]))))\n\t\t{\n\t\t\t// Remove all post_ids already parsed (we do not have to check them)\n\t\t\t$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);\n\n\t\t\t$sql = 'SELECT DISTINCT u.user_id, u.username, u.user_colour\n\t\t\t\tFROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u\n\t\t\t\tWHERE ' . $db->sql_in_set('p.post_id', $post_storage_list) . '\n\t\t\t\t\tAND p.post_delete_user <> 0\n\t\t\t\t\tAND p.post_delete_user = u.user_id';\n\t\t\t$result2 = $db->sql_query($sql);\n\t\t\twhile ($user_delete_row = $db->sql_fetchrow($result2))\n\t\t\t{\n\t\t\t\t$post_delete_list[$user_delete_row['user_id']] = $user_delete_row;\n\t\t\t}\n\t\t\t$db->sql_freeresult($result2);\n\n\t\t\tunset($post_storage_list);\n\t\t}\n\n\t\tif ($row['post_delete_user'] && !isset($user_cache[$row['post_delete_user']]))\n\t\t{\n\t\t\t$user_cache[$row['post_delete_user']] = $post_delete_list[$row['post_delete_user']];\n\t\t}\n\n\t\t$display_postername = get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']);\n\n\t\t// User having deleted the post also being the post author?\n\t\tif (!$row['post_delete_user'] || $row['post_delete_user'] == $poster_id)\n\t\t{\n\t\t\t$display_username = $display_postername;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$display_username = get_username_string('full', $row['post_delete_user'], $user_cache[$row['post_delete_user']]['username'], $user_cache[$row['post_delete_user']]['user_colour']);\n\t\t}\n\n\t\tif ($row['post_delete_reason'])\n\t\t{\n\t\t\t$l_deleted_message = $user->lang('POST_DELETED_BY_REASON', $display_postername, $display_username, $user->format_date($row['post_delete_time'], false, true), $row['post_delete_reason']);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$l_deleted_message = $user->lang('POST_DELETED_BY', $display_postername, $display_username, $user->format_date($row['post_delete_time'], false, true));\n\t\t}\n\t\t$l_deleted_by = $user->lang('DELETED_INFORMATION', $display_username, $user->format_date($row['post_delete_time'], false, true));\n\t}\n\telse\n\t{\n\t\t$l_deleted_by = $l_deleted_message = '';\n\t}\n\n\t// Bump information\n\tif ($topic_data['topic_bumped'] && $row['post_id'] == $topic_data['topic_last_post_id'] && isset($user_cache[$topic_data['topic_bumper']]) )\n\t{\n\t\t// It is safe to grab the username from the user cache array, we are at the last\n\t\t// post and only the topic poster and last poster are allowed to bump.\n\t\t// Admins and mods are bound to the above rules too...\n\t\t$l_bumped_by = sprintf($user->lang['BUMPED_BY'], $user_cache[$topic_data['topic_bumper']]['username'], $user->format_date($topic_data['topic_last_post_time'], false, true));\n\t}\n\telse\n\t{\n\t\t$l_bumped_by = '';\n\t}\n\n\t$cp_row = array();\n\n\t//\n\tif ($config['load_cpf_viewtopic'])\n\t{\n\t\t$cp_row = (isset($profile_fields_cache[$poster_id])) ? $cp->generate_profile_fields_template_data($profile_fields_cache[$poster_id]) : array();\n\t}\n\n\t$post_unread = (isset($topic_tracking_info[$topic_id]) && $row['post_time'] > $topic_tracking_info[$topic_id]) ? true : false;\n\n\t$s_first_unread = false;\n\tif (!$first_unread && $post_unread)\n\t{\n\t\t$s_first_unread = $first_unread = true;\n\t}\n\n\t$force_edit_allowed = $force_delete_allowed = $force_softdelete_allowed = false;\n\n\t$s_cannot_edit = !$auth->acl_get('f_edit', $forum_id) || $user->data['user_id'] != $poster_id;\n\t$s_cannot_edit_time = $config['edit_time'] && $row['post_time'] <= time() - ($config['edit_time'] * 60);\n\t$s_cannot_edit_locked = $topic_data['topic_status'] == ITEM_LOCKED || $row['post_edit_locked'];\n\n\t$s_cannot_delete = $user->data['user_id'] != $poster_id || (\n\t\t\t!$auth->acl_get('f_delete', $forum_id) &&\n\t\t\t(!$auth->acl_get('f_softdelete', $forum_id) || $row['post_visibility'] == ITEM_DELETED)\n\t);\n\t$s_cannot_delete_lastpost = $topic_data['topic_last_post_id'] != $row['post_id'];\n\t$s_cannot_delete_time = $config['delete_time'] && $row['post_time'] <= time() - ($config['delete_time'] * 60);\n\t// we do not want to allow removal of the last post if a moderator locked it!\n\t$s_cannot_delete_locked = $topic_data['topic_status'] == ITEM_LOCKED || $row['post_edit_locked'];\n\n\t/**\n\t* This event allows you to modify the conditions for the \"can edit post\" and \"can delete post\" checks\n\t*\n\t* @event core.viewtopic_modify_post_action_conditions\n\t* @var\tarray\trow\t\t\tArray with post data\n\t* @var\tarray\ttopic_data\tArray with topic data\n\t* @var\tbool\tforce_edit_allowed\t\tAllow the user to edit the post (all permissions and conditions are ignored)\n\t* @var\tbool\ts_cannot_edit\t\t\tUser can not edit the post because it's not his\n\t* @var\tbool\ts_cannot_edit_locked\tUser can not edit the post because it's locked\n\t* @var\tbool\ts_cannot_edit_time\t\tUser can not edit the post because edit_time has passed\n\t* @var\tbool\tforce_delete_allowed\t\tAllow the user to delete the post (all permissions and conditions are ignored)\n\t* @var\tbool\ts_cannot_delete\t\t\t\tUser can not delete the post because it's not his\n\t* @var\tbool\ts_cannot_delete_lastpost\tUser can not delete the post because it's not the last post of the topic\n\t* @var\tbool\ts_cannot_delete_locked\t\tUser can not delete the post because it's locked\n\t* @var\tbool\ts_cannot_delete_time\t\tUser can not delete the post because edit_time has passed\n\t* @var\tbool\tforce_softdelete_allowed\tAllow the user to \209\139oftdelete the post (all permissions and conditions are ignored)\n\t* @since 3.1.0-b4\n\t* @changed 3.1.11-RC1 Added force_softdelete_allowed var\n\t*/\n\t$vars = array(\n\t\t'row',\n\t\t'topic_data',\n\t\t'force_edit_allowed',\n\t\t's_cannot_edit',\n\t\t's_cannot_edit_locked',\n\t\t's_cannot_edit_time',\n\t\t'force_delete_allowed',\n\t\t's_cannot_delete',\n\t\t's_cannot_delete_lastpost',\n\t\t's_cannot_delete_locked',\n\t\t's_cannot_delete_time',\n\t\t'force_softdelete_allowed',\n\t);\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_post_action_conditions', compact($vars)));\n\n\t$edit_allowed = $force_edit_allowed || ($user->data['is_registered'] && ($auth->acl_get('m_edit', $forum_id) || (\n\t\t!$s_cannot_edit &&\n\t\t!$s_cannot_edit_time &&\n\t\t!$s_cannot_edit_locked\n\t)));\n\n\t$quote_allowed = $auth->acl_get('m_edit', $forum_id) || ($topic_data['topic_status'] != ITEM_LOCKED &&\n\t\t($user->data['user_id'] == ANONYMOUS || $auth->acl_get('f_reply', $forum_id))\n\t);\n\n\t// Only display the quote button if the post is quotable.  Posts not approved are not quotable.\n\t$quote_allowed = ($quote_allowed && $row['post_visibility'] == ITEM_APPROVED) ? true : false;\n\n\t$delete_allowed = $force_delete_allowed || ($user->data['is_registered'] && (\n\t\t($auth->acl_get('m_delete', $forum_id) || ($auth->acl_get('m_softdelete', $forum_id) && $row['post_visibility'] != ITEM_DELETED)) ||\n\t\t(!$s_cannot_delete && !$s_cannot_delete_lastpost && !$s_cannot_delete_time && !$s_cannot_delete_locked)\n\t));\n\n\t$softdelete_allowed = $force_softdelete_allowed || (($auth->acl_get('m_softdelete', $forum_id) ||\n\t\t($auth->acl_get('f_softdelete', $forum_id) && $user->data['user_id'] == $poster_id)) && ($row['post_visibility'] != ITEM_DELETED));\n\n\t$permanent_delete_allowed = $force_delete_allowed || ($auth->acl_get('m_delete', $forum_id) ||\n\t\t($auth->acl_get('f_delete', $forum_id) && $user->data['user_id'] == $poster_id));\n\n\t// Can this user receive a Private Message?\n\t$can_receive_pm = (\n\t\t// They must be a \"normal\" user\n\t\t$user_cache[$poster_id]['user_type'] != USER_IGNORE &&\n\n\t\t// They must not be deactivated by the administrator\n\t\t($user_cache[$poster_id]['user_type'] != USER_INACTIVE || $user_cache[$poster_id]['user_inactive_reason'] != INACTIVE_MANUAL) &&\n\n\t\t// They must be able to read PMs\n\t\tin_array($poster_id, $can_receive_pm_list) &&\n\n\t\t// They must not be permanently banned\n\t\t!in_array($poster_id, $permanently_banned_users) &&\n\n\t\t// They must allow users to contact via PM\n\t\t(($auth->acl_gets('a_', 'm_') || $auth->acl_getf_global('m_')) || $user_cache[$poster_id]['allow_pm'])\n\t);\n\n\t$u_pm = '';\n\n\tif ($config['allow_privmsg'] && $auth->acl_get('u_sendpm') && $can_receive_pm)\n\t{\n\t\t$u_pm = append_sid(\"{$phpbb_root_path}ucp.$phpEx\", 'i=pm&amp;mode=compose&amp;action=quotepost&amp;p=' . $row['post_id']);\n\t}\n\n\t//\n\t$post_row = array(\n\t\t'POST_AUTHOR_FULL'\t\t=> ($poster_id != ANONYMOUS) ? $user_cache[$poster_id]['author_full'] : get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']),\n\t\t'POST_AUTHOR_COLOUR'\t=> ($poster_id != ANONYMOUS) ? $user_cache[$poster_id]['author_colour'] : get_username_string('colour', $poster_id, $row['username'], $row['user_colour'], $row['post_username']),\n\t\t'POST_AUTHOR'\t\t\t=> ($poster_id != ANONYMOUS) ? $user_cache[$poster_id]['author_username'] : get_username_string('username', $poster_id, $row['username'], $row['user_colour'], $row['post_username']),\n\t\t'U_POST_AUTHOR'\t\t\t=> ($poster_id != ANONYMOUS) ? $user_cache[$poster_id]['author_profile'] : get_username_string('profile', $poster_id, $row['username'], $row['user_colour'], $row['post_username']),\n\n\t\t'RANK_TITLE'\t\t=> $user_cache[$poster_id]['rank_title'],\n\t\t'RANK_IMG'\t\t\t=> $user_cache[$poster_id]['rank_image'],\n\t\t'RANK_IMG_SRC'\t\t=> $user_cache[$poster_id]['rank_image_src'],\n\t\t'POSTER_JOINED'\t\t=> $user_cache[$poster_id]['joined'],\n\t\t'POSTER_POSTS'\t\t=> $user_cache[$poster_id]['posts'],\n\t\t'POSTER_AVATAR'\t\t=> $user_cache[$poster_id]['avatar'],\n\t\t'POSTER_WARNINGS'\t=> $auth->acl_get('m_warn') ? $user_cache[$poster_id]['warnings'] : '',\n\t\t'POSTER_AGE'\t\t=> $user_cache[$poster_id]['age'],\n\t\t'CONTACT_USER'\t\t=> $user_cache[$poster_id]['contact_user'],\n\n\t\t'POST_DATE'\t\t\t=> $user->format_date($row['post_time'], false, ($view == 'print') ? true : false),\n\t\t'POST_SUBJECT'\t\t=> $row['post_subject'],\n\t\t'MESSAGE'\t\t\t=> $message,\n\t\t'SIGNATURE'\t\t\t=> ($row['enable_sig']) ? $user_cache[$poster_id]['sig'] : '',\n\t\t'EDITED_MESSAGE'\t=> $l_edited_by,\n\t\t'EDIT_REASON'\t\t=> $row['post_edit_reason'],\n\t\t'DELETED_MESSAGE'\t=> $l_deleted_by,\n\t\t'DELETE_REASON'\t\t=> $row['post_delete_reason'],\n\t\t'BUMPED_MESSAGE'\t=> $l_bumped_by,\n\n\t\t'MINI_POST_IMG'\t\t\t=> ($post_unread) ? $user->img('icon_post_target_unread', 'UNREAD_POST') : $user->img('icon_post_target', 'POST'),\n\t\t'POST_ICON_IMG'\t\t\t=> ($topic_data['enable_icons'] && !empty($row['icon_id'])) ? $icons[$row['icon_id']]['img'] : '',\n\t\t'POST_ICON_IMG_WIDTH'\t=> ($topic_data['enable_icons'] && !empty($row['icon_id'])) ? $icons[$row['icon_id']]['width'] : '',\n\t\t'POST_ICON_IMG_HEIGHT'\t=> ($topic_data['enable_icons'] && !empty($row['icon_id'])) ? $icons[$row['icon_id']]['height'] : '',\n\t\t'POST_ICON_IMG_ALT' \t=> ($topic_data['enable_icons'] && !empty($row['icon_id'])) ? $icons[$row['icon_id']]['alt'] : '',\n\t\t'ONLINE_IMG'\t\t\t=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $user->img('icon_user_online', 'ONLINE') : $user->img('icon_user_offline', 'OFFLINE')),\n\t\t'S_ONLINE'\t\t\t\t=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? false : (($user_cache[$poster_id]['online']) ? true : false),\n\n\t\t'U_EDIT'\t\t\t=> ($edit_allowed) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=edit&amp;f=$forum_id&amp;p={$row['post_id']}\") : '',\n\t\t'U_QUOTE'\t\t\t=> ($quote_allowed) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=quote&amp;f=$forum_id&amp;p={$row['post_id']}\") : '',\n\t\t'U_INFO'\t\t\t=> ($auth->acl_get('m_info', $forum_id)) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", \"i=main&amp;mode=post_details&amp;f=$forum_id&amp;p=\" . $row['post_id'], true, $user->session_id) : '',\n\t\t'U_DELETE'\t\t\t=> ($delete_allowed) ? append_sid(\"{$phpbb_root_path}posting.$phpEx\", 'mode=' . (($softdelete_allowed) ? 'soft_delete' : 'delete') . \"&amp;f=$forum_id&amp;p={$row['post_id']}\") : '',\n\n\t\t'U_SEARCH'\t\t=> $user_cache[$poster_id]['search'],\n\t\t'U_PM'\t\t\t=> $u_pm,\n\t\t'U_EMAIL'\t\t=> $user_cache[$poster_id]['email'],\n\t\t'U_JABBER'\t\t=> $user_cache[$poster_id]['jabber'],\n\n\t\t'U_APPROVE_ACTION'\t\t=> append_sid(\"{$phpbb_root_path}mcp.$phpEx\", \"i=queue&amp;p={$row['post_id']}&amp;f=$forum_id&amp;redirect=\" . urlencode(str_replace('&amp;', '&', $viewtopic_url . '&amp;p=' . $row['post_id'] . '#p' . $row['post_id']))),\n\t\t'U_REPORT'\t\t\t=> ($auth->acl_get('f_report', $forum_id)) ? $phpbb_container->get('controller.helper')->route('phpbb_report_post_controller', array('id' => $row['post_id'])) : '',\n\t\t'U_MCP_REPORT'\t\t=> ($auth->acl_get('m_report', $forum_id)) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", 'i=reports&amp;mode=report_details&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',\n\t\t'U_MCP_APPROVE'\t\t=> ($auth->acl_get('m_approve', $forum_id)) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", 'i=queue&amp;mode=approve_details&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',\n\t\t'U_MCP_RESTORE'\t\t=> ($auth->acl_get('m_approve', $forum_id)) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", 'i=queue&amp;mode=' . (($topic_data['topic_visibility'] != ITEM_DELETED) ? 'deleted_posts' : 'deleted_topics') . '&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',\n\t\t'U_MINI_POST'\t\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", 'p=' . $row['post_id']) . '#p' . $row['post_id'],\n\t\t'U_NEXT_POST_ID'\t=> ($i < $i_total && isset($rowset[$post_list[$i + 1]])) ? $rowset[$post_list[$i + 1]]['post_id'] : '',\n\t\t'U_PREV_POST_ID'\t=> $prev_post_id,\n\t\t'U_NOTES'\t\t\t=> ($auth->acl_getf_global('m_')) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", 'i=notes&amp;mode=user_notes&amp;u=' . $poster_id, true, $user->session_id) : '',\n\t\t'U_WARN'\t\t\t=> ($auth->acl_get('m_warn') && $poster_id != $user->data['user_id'] && $poster_id != ANONYMOUS) ? append_sid(\"{$phpbb_root_path}mcp.$phpEx\", 'i=warn&amp;mode=warn_post&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',\n\n\t\t'POST_ID'\t\t\t=> $row['post_id'],\n\t\t'POST_NUMBER'\t\t=> $i + $start + 1,\n\t\t'POSTER_ID'\t\t\t=> $poster_id,\n\t\t'MINI_POST'\t\t\t=> ($post_unread) ? $user->lang['UNREAD_POST'] : $user->lang['POST'],\n\n\n\t\t'S_HAS_ATTACHMENTS'\t=> (!empty($attachments[$row['post_id']])) ? true : false,\n\t\t'S_MULTIPLE_ATTACHMENTS'\t=> !empty($attachments[$row['post_id']]) && sizeof($attachments[$row['post_id']]) > 1,\n\t\t'S_POST_UNAPPROVED'\t=> ($row['post_visibility'] == ITEM_UNAPPROVED || $row['post_visibility'] == ITEM_REAPPROVE) ? true : false,\n\t\t'S_POST_DELETED'\t=> ($row['post_visibility'] == ITEM_DELETED) ? true : false,\n\t\t'L_POST_DELETED_MESSAGE'\t=> $l_deleted_message,\n\t\t'S_POST_REPORTED'\t=> ($row['post_reported'] && $auth->acl_get('m_report', $forum_id)) ? true : false,\n\t\t'S_DISPLAY_NOTICE'\t=> $display_notice && $row['post_attachment'],\n\t\t'S_FRIEND'\t\t\t=> ($row['friend']) ? true : false,\n\t\t'S_UNREAD_POST'\t\t=> $post_unread,\n\t\t'S_FIRST_UNREAD'\t=> $s_first_unread,\n\t\t'S_CUSTOM_FIELDS'\t=> (isset($cp_row['row']) && sizeof($cp_row['row'])) ? true : false,\n\t\t'S_TOPIC_POSTER'\t=> ($topic_data['topic_poster'] == $poster_id) ? true : false,\n\n\t\t'S_IGNORE_POST'\t\t=> ($row['foe']) ? true : false,\n\t\t'L_IGNORE_POST'\t\t=> ($row['foe']) ? sprintf($user->lang['POST_BY_FOE'], get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username'])) : '',\n\t\t'S_POST_HIDDEN'\t\t=> $row['hide_post'],\n\t\t'L_POST_DISPLAY'\t=> ($row['hide_post']) ? $user->lang('POST_DISPLAY', '<a class=\"display_post\" data-post-id=\"' . $row['post_id'] . '\" href=\"' . $viewtopic_url . \"&amp;p={$row['post_id']}&amp;view=show#p{$row['post_id']}\" . '\">', '</a>') : '',\n\t\t'S_DELETE_PERMANENT'\t=> $permanent_delete_allowed,\n\t);\n\n\t$user_poster_data = $user_cache[$poster_id];\n\n\t$current_row_number = $i;\n\n\t/**\n\t* Modify the posts template block\n\t*\n\t* @event core.viewtopic_modify_post_row\n\t* @var\tint\t\tstart\t\t\t\tStart item of this page\n\t* @var\tint\t\tcurrent_row_number\tNumber of the post on this page\n\t* @var\tint\t\tend\t\t\t\t\tNumber of posts on this page\n\t* @var\tint\t\ttotal_posts\t\t\tTotal posts count\n\t* @var\tint\t\tposter_id\t\t\tPost author id\n\t* @var\tarray\trow\t\t\t\t\tArray with original post and user data\n\t* @var\tarray\tcp_row\t\t\t\tCustom profile field data of the poster\n\t* @var\tarray\tattachments\t\t\tList of attachments\n\t* @var\tarray\tuser_poster_data\tPoster's data from user cache\n\t* @var\tarray\tpost_row\t\t\tTemplate block array of the post\n\t* @var\tarray\ttopic_data\t\t\tArray with topic data\n\t* @since 3.1.0-a1\n\t* @changed 3.1.0-a3 Added vars start, current_row_number, end, attachments\n\t* @changed 3.1.0-b3 Added topic_data array, total_posts\n\t* @changed 3.1.0-RC3 Added poster_id\n\t*/\n\t$vars = array(\n\t\t'start',\n\t\t'current_row_number',\n\t\t'end',\n\t\t'total_posts',\n\t\t'poster_id',\n\t\t'row',\n\t\t'cp_row',\n\t\t'attachments',\n\t\t'user_poster_data',\n\t\t'post_row',\n\t\t'topic_data',\n\t);\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_post_row', compact($vars)));\n\n\t$i = $current_row_number;\n\n\tif (isset($cp_row['row']) && sizeof($cp_row['row']))\n\t{\n\t\t$post_row = array_merge($post_row, $cp_row['row']);\n\t}\n\n\t// Dump vars into template\n\t$template->assign_block_vars('postrow', $post_row);\n\n\t$contact_fields = array(\n\t\tarray(\n\t\t\t'ID'\t\t=> 'pm',\n\t\t\t'NAME' \t\t=> $user->lang['SEND_PRIVATE_MESSAGE'],\n\t\t\t'U_CONTACT'\t=> $u_pm,\n\t\t),\n\t\tarray(\n\t\t\t'ID'\t\t=> 'email',\n\t\t\t'NAME'\t\t=> $user->lang['SEND_EMAIL'],\n\t\t\t'U_CONTACT'\t=> $user_cache[$poster_id]['email'],\n\t\t),\n\t\tarray(\n\t\t\t'ID'\t\t=> 'jabber',\n\t\t\t'NAME'\t\t=> $user->lang['JABBER'],\n\t\t\t'U_CONTACT'\t=> $user_cache[$poster_id]['jabber'],\n\t\t),\n\t);\n\n\tforeach ($contact_fields as $field)\n\t{\n\t\tif ($field['U_CONTACT'])\n\t\t{\n\t\t\t$template->assign_block_vars('postrow.contact', $field);\n\t\t}\n\t}\n\n\tif (!empty($cp_row['blockrow']))\n\t{\n\t\tforeach ($cp_row['blockrow'] as $field_data)\n\t\t{\n\t\t\t$template->assign_block_vars('postrow.custom_fields', $field_data);\n\n\t\t\tif ($field_data['S_PROFILE_CONTACT'])\n\t\t\t{\n\t\t\t\t$template->assign_block_vars('postrow.contact', array(\n\t\t\t\t\t'ID'\t\t=> $field_data['PROFILE_FIELD_IDENT'],\n\t\t\t\t\t'NAME'\t\t=> $field_data['PROFILE_FIELD_NAME'],\n\t\t\t\t\t'U_CONTACT'\t=> $field_data['PROFILE_FIELD_CONTACT'],\n\t\t\t\t));\n\t\t\t}\n\t\t}\n\t}\n\n\t// Display not already displayed Attachments for this post, we already parsed them. ;)\n\tif (!empty($attachments[$row['post_id']]))\n\t{\n\t\tforeach ($attachments[$row['post_id']] as $attachment)\n\t\t{\n\t\t\t$template->assign_block_vars('postrow.attachment', array(\n\t\t\t\t'DISPLAY_ATTACHMENT'\t=> $attachment)\n\t\t\t);\n\t\t}\n\t}\n\n\t$current_row_number = $i;\n\n\t/**\n\t* Event after the post data has been assigned to the template\n\t*\n\t* @event core.viewtopic_post_row_after\n\t* @var\tint\t\tstart\t\t\t\tStart item of this page\n\t* @var\tint\t\tcurrent_row_number\tNumber of the post on this page\n\t* @var\tint\t\tend\t\t\t\t\tNumber of posts on this page\n\t* @var\tint\t\ttotal_posts\t\t\tTotal posts count\n\t* @var\tarray\trow\t\t\t\t\tArray with original post and user data\n\t* @var\tarray\tcp_row\t\t\t\tCustom profile field data of the poster\n\t* @var\tarray\tattachments\t\t\tList of attachments\n\t* @var\tarray\tuser_poster_data\tPoster's data from user cache\n\t* @var\tarray\tpost_row\t\t\tTemplate block array of the post\n\t* @var\tarray\ttopic_data\t\t\tArray with topic data\n\t* @since 3.1.0-a3\n\t* @changed 3.1.0-b3 Added topic_data array, total_posts\n\t*/\n\t$vars = array(\n\t\t'start',\n\t\t'current_row_number',\n\t\t'end',\n\t\t'total_posts',\n\t\t'row',\n\t\t'cp_row',\n\t\t'attachments',\n\t\t'user_poster_data',\n\t\t'post_row',\n\t\t'topic_data',\n\t);\n\textract($phpbb_dispatcher->trigger_event('core.viewtopic_post_row_after', compact($vars)));\n\n\t$i = $current_row_number;\n\n\t$prev_post_id = $row['post_id'];\n\n\tunset($rowset[$post_list[$i]]);\n\tunset($attachments[$row['post_id']]);\n}\nunset($rowset, $user_cache);\n\n// Update topic view and if necessary attachment view counters ... but only for humans and if this is the first 'page view'\nif (isset($user->data['session_page']) && !$user->data['is_bot'] && (strpos($user->data['session_page'], '&t=' . $topic_id) === false || isset($user->data['session_created'])))\n{\n\t$sql = 'UPDATE ' . TOPICS_TABLE . '\n\t\tSET topic_views = topic_views + 1, topic_last_view_time = ' . time() . \"\n\t\tWHERE topic_id = $topic_id\";\n\t$db->sql_query($sql);\n\n\t// Update the attachment download counts\n\tif (sizeof($update_count))\n\t{\n\t\t$sql = 'UPDATE ' . ATTACHMENTS_TABLE . '\n\t\t\tSET download_count = download_count + 1\n\t\t\tWHERE ' . $db->sql_in_set('attach_id', array_unique($update_count));\n\t\t$db->sql_query($sql);\n\t}\n}\n\n// Only mark topic if it's currently unread. Also make sure we do not set topic tracking back if earlier pages are viewed.\nif (isset($topic_tracking_info[$topic_id]) && $topic_data['topic_last_post_time'] > $topic_tracking_info[$topic_id] && $max_post_time > $topic_tracking_info[$topic_id])\n{\n\tmarkread('topic', $forum_id, $topic_id, $max_post_time);\n\n\t// Update forum info\n\t$all_marked_read = update_forum_tracking_info($forum_id, $topic_data['forum_last_post_time'], (isset($topic_data['forum_mark_time'])) ? $topic_data['forum_mark_time'] : false, false);\n}\nelse\n{\n\t$all_marked_read = true;\n}\n\n// If there are absolutely no more unread posts in this forum\n// and unread posts shown, we can safely show the #unread link\nif ($all_marked_read)\n{\n\tif ($post_unread)\n\t{\n\t\t$template->assign_vars(array(\n\t\t\t'U_VIEW_UNREAD_POST'\t=> '#unread',\n\t\t));\n\t}\n\telse if (isset($topic_tracking_info[$topic_id]) && $topic_data['topic_last_post_time'] > $topic_tracking_info[$topic_id])\n\t{\n\t\t$template->assign_vars(array(\n\t\t\t'U_VIEW_UNREAD_POST'\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id&amp;view=unread\") . '#unread',\n\t\t));\n\t}\n}\nelse if (!$all_marked_read)\n{\n\t$last_page = ((floor($start / $config['posts_per_page']) + 1) == max(ceil($total_posts / $config['posts_per_page']), 1)) ? true : false;\n\n\t// What can happen is that we are at the last displayed page. If so, we also display the #unread link based in $post_unread\n\tif ($last_page && $post_unread)\n\t{\n\t\t$template->assign_vars(array(\n\t\t\t'U_VIEW_UNREAD_POST'\t=> '#unread',\n\t\t));\n\t}\n\telse if (!$last_page)\n\t{\n\t\t$template->assign_vars(array(\n\t\t\t'U_VIEW_UNREAD_POST'\t=> append_sid(\"{$phpbb_root_path}viewtopic.$phpEx\", \"f=$forum_id&amp;t=$topic_id&amp;view=unread\") . '#unread',\n\t\t));\n\t}\n}\n\n// let's set up quick_reply\n$s_quick_reply = false;\nif ($user->data['is_registered'] && $config['allow_quick_reply'] && ($topic_data['forum_flags'] & FORUM_FLAG_QUICK_REPLY) && $auth->acl_get('f_reply', $forum_id))\n{\n\t// Quick reply enabled forum\n\t$s_quick_reply = (($topic_data['forum_status'] == ITEM_UNLOCKED && $topic_data['topic_status'] == ITEM_UNLOCKED) || $auth->acl_get('m_edit', $forum_id)) ? true : false;\n}\n\nif ($s_can_vote || $s_quick_reply)\n{\n\tadd_form_key('posting');\n\n\tif ($s_quick_reply)\n\t{\n\t\t$s_attach_sig\t= $config['allow_sig'] && $user->optionget('attachsig') && $auth->acl_get('f_sigs', $forum_id) && $auth->acl_get('u_sig');\n\t\t$s_smilies\t\t= $config['allow_smilies'] && $user->optionget('smilies') && $auth->acl_get('f_smilies', $forum_id);\n\t\t$s_bbcode\t\t= $config['allow_bbcode'] && $user->optionget('bbcode') && $auth->acl_get('f_bbcode', $forum_id);\n\t\t$s_notify\t\t= $config['allow_topic_notify'] && ($user->data['user_notify'] || $s_watching_topic['is_watching']);\n\n\t\t$qr_hidden_fields = array(\n\t\t\t'topic_cur_post_id'\t\t=> (int) $topic_data['topic_last_post_id'],\n\t\t\t'lastclick'\t\t\t\t=> (int) time(),\n\t\t\t'topic_id'\t\t\t\t=> (int) $topic_data['topic_id'],\n\t\t\t'forum_id'\t\t\t\t=> (int) $forum_id,\n\t\t);\n\n\t\t// Originally we use checkboxes and check with isset(), so we only provide them if they would be checked\n\t\t(!$s_bbcode)\t\t\t\t\t? $qr_hidden_fields['disable_bbcode'] = 1\t\t: true;\n\t\t(!$s_smilies)\t\t\t\t\t? $qr_hidden_fields['disable_smilies'] = 1\t\t: true;\n\t\t(!$config['allow_post_links'])\t? $qr_hidden_fields['disable_magic_url'] = 1\t: true;\n\t\t($s_attach_sig)\t\t\t\t\t? $qr_hidden_fields['attach_sig'] = 1\t\t\t: true;\n\t\t($s_notify)\t\t\t\t\t\t? $qr_hidden_fields['notify'] = 1\t\t\t\t: true;\n\t\t($topic_data['topic_status'] == ITEM_LOCKED) ? $qr_hidden_fields['lock_topic'] = 1 : true;\n\n\t\t$template->assign_vars(array(\n\t\t\t'S_QUICK_REPLY'\t\t\t=> true,\n\t\t\t'U_QR_ACTION'\t\t\t=> append_sid(\"{$phpbb_root_path}posting.$phpEx\", \"mode=reply&amp;f=$forum_id&amp;t=$topic_id\"),\n\t\t\t'QR_HIDDEN_FIELDS'\t\t=> build_hidden_fields($qr_hidden_fields),\n\t\t\t'SUBJECT'\t\t\t\t=> 'Re: ' . censor_text($topic_data['topic_title']),\n\t\t));\n\t}\n}\n// now I have the urge to wash my hands :(\n\n\n// We overwrite $_REQUEST['f'] if there is no forum specified\n// to be able to display the correct online list.\n// One downside is that the user currently viewing this topic/post is not taken into account.\nif (!$request->variable('f', 0))\n{\n\t$request->overwrite('f', $forum_id);\n}\n\n// We need to do the same with the topic_id. See #53025.\nif (!$request->variable('t', 0) && !empty($topic_id))\n{\n\t$request->overwrite('t', $topic_id);\n}\n\n$page_title = $topic_data['topic_title'] . ($start ? ' - ' . sprintf($user->lang['PAGE_TITLE_NUMBER'], $pagination->get_on_page($config['posts_per_page'], $start)) : '');\n\n/**\n* You can use this event to modify the page title of the viewtopic page\n*\n* @event core.viewtopic_modify_page_title\n* @var\tstring\tpage_title\t\tTitle of the viewtopic page\n* @var\tarray\ttopic_data\t\tArray with topic data\n* @var\tint\t\tforum_id\t\tForum ID of the topic\n* @var\tint\t\tstart\t\t\tStart offset used to calculate the page\n* @var\tarray\tpost_list\t\tArray with post_ids we are going to display\n* @since 3.1.0-a1\n* @changed 3.1.0-RC4 Added post_list var\n*/\n$vars = array('page_title', 'topic_data', 'forum_id', 'start', 'post_list');\nextract($phpbb_dispatcher->trigger_event('core.viewtopic_modify_page_title', compact($vars)));\n\n// Output the page\npage_header($page_title, true, $forum_id);\n\n$template->set_filenames(array(\n\t'body' => ($view == 'print') ? 'viewtopic_print.html' : 'viewtopic_body.html')\n);\nmake_jumpbox(append_sid(\"{$phpbb_root_path}viewforum.$phpEx\"), $forum_id);\n\npage_footer();\n\n}\n\n\n";;


let bad=Put_markers_everywhere.in_string w;;